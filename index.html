<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="好记性不如烂笔头,更何况记性还不好">
<meta property="og:type" content="website">
<meta property="og:title" content="Fujia's Blog">
<meta property="og:url" content="https://fujiador.github.io/index.html">
<meta property="og:site_name" content="Fujia's Blog">
<meta property="og:description" content="好记性不如烂笔头,更何况记性还不好">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fujia's Blog">
<meta name="twitter:description" content="好记性不如烂笔头,更何况记性还不好">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fujiador.github.io/"/>





  <title> Fujia's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fujia's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">点滴技术的印记</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/19/数据需求-活跃用户统计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/19/数据需求-活跃用户统计/" itemprop="url">
                  [数据需求] 活跃用户统计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-19T21:04:44+08:00">
                2017-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求简介"><a href="#需求简介" class="headerlink" title="需求简介"></a>需求简介</h3><p>首先，简单的聊一下“活跃用户”这个概念。</p>
<p>在不同的行业、不同的公司、不同的人眼中，甚至在上述各个对象的不同发展阶段，“活跃用户”的定义各不相同，且很可能在定义字面上的差异非常明显。换句话说，“活跃用户”的定义并没有一个行业的统一标准，更加趋向于特殊化和个例化。因此不要盲从的去比较关于“活跃用户”的概念，只要是适合自己公司的，就是最好概念定义的。</p>
<p>定义“活跃用户”概念，其关键核心是围绕自己的产品战略和实际情况，进行跟踪分析用户<strong>有效的</strong>体验、参与、使用了我们的产品的用户活跃行为。</p>
<p>这些运营的需求是，将活跃用户定义为“在自然日期内，已经连续七天有效调用服务器API接口的用户”，将条件推广的定义即“连续N日内”。</p>
<p>连续活跃七天，我们可以先初步估算下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">假设：某个用户正常在自然日期内调用的概率是<span class="number">0.5</span>；</div><div class="line"></div><div class="line">概率：连续<span class="number">7</span>天内有效调用API接口的概率是 (<span class="number">0.5</span>)^<span class="number">7</span> ≈ <span class="number">0.78</span>%</div><div class="line"></div><div class="line">分析：当然实际的产品情况并非是简单的相互独立概率计算方式，这里的<span class="number">0.78</span>%仅仅是一个参考，单从概率值上来讲结论近几乎乎绝大多数用户都不太可能连续<span class="number">7</span>天内都活跃，虽然实际的概率模型并非每日活跃概率相互独立。</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="误区"><a href="#误区" class="headerlink" title="误区"></a>误区</h3><p>常见的活跃定义，可以是用户某个（系列）行为、打开APP停留时间、体验深入等等，因不同行业、不同产品，我们不展开说明。下面主要聊一下不能计入活跃的行为。</p>
<ol>
<li>用户在操作过程中，肯定存在<strong>误点击</strong>行为，这种类型不应算作活跃计数；</li>
<li>对于消息推送类，用户很可能因你推送消息的吸引而打开应用，但停留<strong>时间极短</strong>，就跳出结束体验。实际上这种情况是造成了不良用户体验的，这种情况也不算做活跃计数。</li>
<li>某些非用户正常行为，属于作弊行为的。这种情况也不应该算作活跃计数。（作弊行为识别和反作弊，这是另外一个庞大的话题了。）</li>
</ol>
<p>关于“活跃用户”的概念，暂时就聊这么多。下面回归到实现运营的需求这个正轨上面。</p>
<hr>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>Python 2.7 和 MySQL</p>
<h4 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h4><p>实现逻辑分为“全量更新”和“增量更新”两部分，拿“全量更新”来说明，将每天活跃的用户存储为dict字典，key为日期，value为活跃用户数；在<code>defaultdict(set)</code>数据结构中依次选择连续7日的活跃用户进行交集运算。实现比较简单，示例代码如下所示。</p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"></div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date,datetime,timedelta</div><div class="line"><span class="keyword">from</span> mysqlutil <span class="keyword">import</span> MysqlUtil</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Increment_Update</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Full_Update</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, section, out_file_name)</span>:</span></div><div class="line">        self.config_file = <span class="string">'mysql.config'</span></div><div class="line">        self.section = section</div><div class="line">        self.out_file_name = out_file_name</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rawData</span><span class="params">(self, left_date=<span class="number">20161220</span>, valid_pv=<span class="number">0</span>)</span>:</span></div><div class="line">        config_path = os.path.join(os.path.dirname(__file__), self.config_file)</div><div class="line">        Sql = <span class="string">'''</span></div><div class="line">              SELECT access_day, apikey</div><div class="line">              FROM active_log_table</div><div class="line">              WHERE access_day &gt;= &#123;0&#125; AND access_day &lt; &#123;1&#125;</div><div class="line">              AND valid_pv &gt; &#123;2&#125; '''.format(left_date, int(date.today().strftime(<span class="string">"%Y%m%d"</span>)), valid_pv)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            MySQL_DB = MysqlUtil(config_path, self.section)</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The mysql.config path get wrong.Error information:&#123;0&#125;."</span>.format(e)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            data = MySQL_DB.select(Sql)</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</div><div class="line">                <span class="keyword">print</span> <span class="string">"The return Data is None. Please check the data source."</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">return</span> data</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reconstruct</span><span class="params">(self, data)</span>:</span></div><div class="line">        data_result = defaultdict(set)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The self.data is None. Please check the self.data."</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> data:</div><div class="line">                <span class="keyword">if</span> <span class="keyword">not</span> line:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">                dt, api_key = line</div><div class="line">                data_result[datetime.strptime(str(dt), <span class="string">"%Y%m%d"</span>)].add(api_key)</div><div class="line">        <span class="keyword">return</span> data_result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">activeRobotCnt</span><span class="params">(self, data_result, focus_date, N=<span class="number">7</span>)</span>:</span></div><div class="line">        <span class="keyword">if</span> focus_date <span class="keyword">not</span> <span class="keyword">in</span> data_result:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The focus_data &#123;0&#125; is out of self.data date range."</span>.format(focus_date)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            query_data = locals()</div><div class="line">            code_str = <span class="string">'len( '</span></div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</div><div class="line">                query_data[<span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i)] = data_result[focus_date - timedelta(days=i)]</div><div class="line">                <span class="keyword">if</span> i &lt;= N<span class="number">-2</span>:</div><div class="line">                    code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' &amp; '</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' )'</span></div><div class="line">            <span class="keyword">return</span> eval(code_str)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">saveInfo</span><span class="params">(self, focus_date, active_cnt)</span>:</span></div><div class="line">        out_file_path = os.path.join(os.path.dirname(__file__), self.out_file_name)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">with</span> codecs.open(out_file_path, mode=<span class="string">'a+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> outFile:</div><div class="line">                outFile.write(focus_date.strftime(<span class="string">"%Y%m%d"</span>) + <span class="string">'\t'</span> + str(active_cnt) + <span class="string">'\n'</span>)</div><div class="line">            <span class="keyword">print</span> <span class="string">"The process has been completed successfully!"</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The Error information &#123;0&#125;"</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    instance = Full_Update(<span class="string">'report'</span>, <span class="string">'result-0619.txt'</span>)</div><div class="line"></div><div class="line">    data = instance.rawData(left_date=<span class="number">20161220</span>, valid_pv=<span class="number">0</span>)</div><div class="line">    data_result = instance.reconstruct(data)</div><div class="line"></div><div class="line">    query_date = datetime(<span class="number">2017</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">    today = datetime.today()</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> query_date &lt; today:</div><div class="line">        active_cnt = instance.activeRobotCnt(data_result, query_date)</div><div class="line">        instance.saveInfo(query_date, active_cnt)</div><div class="line">        <span class="comment"># print str(query_date) + '\t' + str(active_cnt)</span></div><div class="line">        query_date += timedelta(days=<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<h3 id="动态变量"><a href="#动态变量" class="headerlink" title="动态变量"></a>动态变量</h3><p>上面代码中比较重要的内容就是处理“连续七日内活跃用户数”的计算，因为考虑到代码逻辑的通用性，将其写成“连续N日活跃用户”的实现方式。在这里就遇到“动态变量”这个问题，假如我们要求“30日”，难道我们要写30个变量吗？而且，随着需求的变化，可能今天需要30日，明天需要2日，总不能手动修改变量赋值吧。因此，这里使用比较典型的“动态变量”来实现。</p>
<p>动态变量的创建解决了，那么我们同样面临的是动态变量的调用的问题。此处的解决方案是将待执行的代码拼接为字符串，通过<code>eval()</code>函数来执行并返回计算值。<code>eval()</code>方法使用的不算多，这算它的一个很好的使用场景。</p>
<p>关键的知识点是<code>locals()</code>和<code>eval()</code>两块内容。</p>
<h4 id="locals"><a href="#locals" class="headerlink" title="locals()"></a><code>locals()</code></h4><p><code>locals()</code>是内置函数，它以字典的方式来访问局部和全局变量。注意，动态创建字典会带来额外开销。</p>
<p>动态创建变量：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">query_data = locals()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(N):</div><div class="line">     query_data[<span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i)] = data_result[focus_date - timedelta(days=i)]</div><div class="line">     <span class="comment"># 动态变量创建完成,在代码中可以通过对应变量名来调用</span></div></pre></td></tr></table></figure></p>
<h4 id="eval"><a href="#eval" class="headerlink" title="eval()"></a><code>eval()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ......</span></div><div class="line"><span class="comment"># ......</span></div><div class="line">query_data = locals()</div><div class="line">code_str = <span class="string">'len( '</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(N):</div><div class="line">    query_data[<span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i)] = data_result[focus_date - timedelta(days=i)]</div><div class="line">    <span class="keyword">if</span> i &lt;= N<span class="number">-2</span>:</div><div class="line">        code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' &amp; '</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' )'</span></div><div class="line">	<span class="comment"># 动态拼接动态字符串过程完成</span></div><div class="line"><span class="keyword">return</span> eval(code_str)</div></pre></td></tr></table></figure>
<p>到此，我们再也不用担心运营随时变更需求啦！甚至可以给提供从连续登陆2日到N日的定义的活跃用户数据。只需要调整一个参数即可，再也不用为频繁调整代码、变量名命名而头疼啦！</p>
<hr>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>代码优化</li>
<li>可做一个“N日连续调用”的活跃用户变化表（预期类似留存曲线，因为活跃&amp;流失&amp;留存必然不是相互独立的）</li>
</ol>
<hr>
<h3 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h3><p>最后计算出运营定义下的活跃用户量之后，又统计了截止当前的注册用户，占比平均约为“0.0075（0.75%）”，计算的结果与我们当初的预期相差不多。从概率的角度来看，这部分活跃用户已经可以定位为超核心用户啦。</p>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://docs.python.org/2/library/functions.html#locals" target="_blank" rel="external">https://docs.python.org/2/library/functions.html#locals</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/18/《Intermediate-Python》-读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/18/《Intermediate-Python》-读书笔记/" itemprop="url">
                  《Intermediate Python》 读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-18T02:44:12+08:00">
                2017-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="intermediate-python简介"><a href="#《Intermediate-Python》简介" class="headerlink" title="《Intermediate Python》简介"></a>《Intermediate Python》简介</h3><p>《Intermediate Python》即“Python 进阶”，首先感谢英文原著作者 <a href="https://pythontips.com/" target="_blank" rel="external">@Muhammad Yasoob Ullah Khalid</a>《Intermediate Python》的杰出贡献，请支持原著的伙伴购买正版书籍。</p>
<p><a href="https://github.com/yasoob/intermediatePython" target="_blank" rel="external">《Intermediate Python》Git地址</a></p>
<hr>
<h3 id="python-进阶简介"><a href="#《Python-进阶》简介" class="headerlink" title="《Python 进阶》简介"></a>《Python 进阶》简介</h3><p>《Python进阶》是《Intermediate Python》的中文译本，由辛勤的译者：老高 @spawnris  |  刘宇 @liuyu  |  明源 @muxueqz  |  大牙 @suqi  |  蒋委员长 @jiedo  翻译，感谢这些无私的译者的贡献。</p>
<p><a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/index.html" target="_blank" rel="external">《Python 进阶》在线阅读地址</a><br><img src="http://on58f12qv.bkt.clouddn.com/Python%E8%BF%9B%E9%98%B6%20%E6%A0%B7%E4%BE%8B.png" alt="页面示意截图"></p>
<hr>
<h3 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h3><p>Python语言对绝大多数使用者而言，是一门入门较易、精通较难的高级编程语言。引用译者对原著的评价“本书作者的行文方式有着科普作家的风范，那就是能将晦涩难懂的技术用比较清晰简洁的方式进行呈现，深入浅出的风格在每个章节的讨论中都得到了体现”。有些Python的知识点的确是循序渐进、深入浅出的讲解。</p>
<hr>
<h4 id="书籍目录"><a href="#书籍目录" class="headerlink" title="书籍目录"></a>书籍目录</h4><ul>
<li>*args 和 **kwargs 魔法变量</li>
<li>调试 Debugging</li>
<li>生成器 Generators    ※※</li>
<li>Map和Filter    ※※</li>
<li>set 数据结构</li>
<li>三元运算符    ※</li>
<li><a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/index.html" target="_blank" rel="external">装饰器     ※※※</a></li>
<li>Global和Return</li>
<li>对象变动 Mutation</li>
<li>__slots__魔法</li>
<li>虚拟环境    ※※</li>
<li>容器 Collections    ※※</li>
<li>枚举 Enumerate    ※※</li>
<li>对象自省</li>
<li>推导式    ※※</li>
<li>异常    ※※</li>
<li>lambda表达式    ※※※</li>
<li>一行式    ※</li>
<li>For-Else    ※</li>
<li>使用C扩展</li>
<li>open函数</li>
<li>目标Python2+3</li>
<li>协程    ※※</li>
<li>函数缓存</li>
<li>上下文管理器</li>
<li><a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/seealso.html" target="_blank" rel="external">推荐阅读 ※※※※</a><blockquote>
<p>1.<br>在基本目录中，依据我个人的使用和理解情况，依次对不同重要程度的内容以“※”进行标记。其中<strong>装饰器</strong>知识点部分尤其清晰明了，读者可以自行阅读体验。<br>2.<br>在推荐阅读详情页中给的资源也非常优质，请读者自行跳转阅读体验。</p>
</blockquote>
</li>
</ul>
<hr>
<h4 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h4><p>此处内容，是我个人读后感觉需要记录一下的知识点或内容，并不是以Python知识点的重要程度来决定的。</p>
<ol>
<li><p>*args 和 *<em>kwargs 魔法变量<br>在函数里同时使用所有这三种参数，顺序是`some_func(fargs, </em>args, **kwargs)`</p>
</li>
<li><p>迭代器（iterators）<br>迭代器是一个让程序员可以遍历的容器对象。迭代器包含三个部分：可迭代对象（iterable）、迭代器（iterator）、迭代（iteration）。<br><strong>可迭代对象（iterable）</strong> ：python中任意对象，只要定义了可返回一个迭代器的<code>__iter__</code>方法，或者定义可支持下标索引<code>__getitem__</code>方法，那么它就是一个可迭代对象。<br><strong>迭代器（Iterator）</strong>：任意对象，只要定义了<code>next</code>或<code>__next__</code>方法就是一个迭代器。<br><strong>迭代（Iteration）</strong>：从某个地方取出一个元素的过程。当使用一个循环来遍历某个东西时，这个过程本身就叫迭代。</p>
</li>
<li><p>生成器（Generators）<br>生成器也是一种迭代器，但是你只能对其迭代一次。因为它们并没有把所有的值存在内存中，而是在运行时生成值。通过遍历来使用它们，大多数生成器是以函数来实现的，但它们并不返回一个值，而是yield生出一个值。<br>生成器最佳应用场景是：你不想同一时间将所有计算出来的大量结果集分配到内存当中，特别是结果集里还包含循环（会消耗大量资源）。Python2中的标准库函数都会返回列表，而Python3都修改成了返回生成器，因为生成器占用更少的资源。</p>
</li>
</ol>
<p>生成器的典型示例就是计算斐波那契数列：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fibon</span><span class="params">(n)</span>:</span></div><div class="line">    a = b = <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</div><div class="line">        <span class="keyword">yield</span> a </div><div class="line">        a, b = b, a+b</div><div class="line"><span class="comment"># use it like this</span></div><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> fibon(<span class="number">1000000</span>):</div><div class="line">    print(x)</div><div class="line"><span class="comment"># 使用生成器的方式可以不用担心它会使用大量资源。</span></div><div class="line"></div><div class="line"><span class="comment"># 如果按照下列来实现的话：</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fibon</span><span class="params">(n)</span>:</span></div><div class="line">    a = b = <span class="number">1</span></div><div class="line">    result = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</div><div class="line">        result.append(a)</div><div class="line">        a, b = b, a+b</div><div class="line">    <span class="keyword">return</span> result</div><div class="line"><span class="comment"># 可能在计算很大的输入参数时，耗尽所有的资源。</span></div></pre></td></tr></table></figure></p>
<ol>
<li>Map和Filter<br>适用于函数式编程，关键是灵活应用这两个函数使代码更加Pythonic。<br><strong>map</strong>：将一个函数映射到一个输入列表的所有元素上。<code>map(function_to_apply, list_of_inputs)</code>。通常配合匿名函数（lambdas）来使用。<br>例如：<code>suqared = list(map(lambda x:x**2, [1,2,3,4]))</code>。<br>下面展示一个特殊的例子，将map函数应用于一列表的函数。<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">multiply</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> x*x</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + x</div><div class="line"></div><div class="line">funcs = [multiply, add]</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">    value = list(map(<span class="keyword">lambda</span> x:x(i), funcs))</div><div class="line">    print(value)</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># [0, 0]</span></div><div class="line"><span class="comment"># [1, 2]</span></div><div class="line"><span class="comment"># [4, 4]</span></div><div class="line"><span class="comment"># [9, 6]</span></div><div class="line"><span class="comment"># [16, 8]</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>filter</strong>：filter能创建一个列表，其中每个元素都是对应一个函数能返回True。例如<code>less_then_zero = list(filter(lambda x:x&lt;0, range(-5,5)))</code></p>
<ol>
<li>set 集合数据结构<br>集合最广泛的运用就是高效去重和交并补集合运算。</li>
</ol>
<p>例如：<code>duplicates = set([x for x in some_list if some_list.count(x) &gt; 1])</code></p>
<ol>
<li><p>三元运算符<br>即条件表达式。伪代码示例<code>condition_is_true if condition else condition_is_false</code>。主要用在简单的一行快速判断，而不是使用复杂的if语句。</p>
</li>
<li><p>装饰器（Decorators）<br>这本书里对我个人启发最深的一个知识点—就是装饰器。在日常的工作中，很少的用到装饰器。但它是Python的一个重要部分，是Python的魔法功能。<br>装饰器是修改其他函数的功能的函数，有助于让代码更简短、更Pythonic。初学者首先要懂得“哪些区域里装饰器可以让你的代码更简洁”。</p>
</li>
</ol>
<p>原作者将这个较难掌握的概念，逐层分解，一步步深入讨论装饰器的每个步骤。下面，所有示例和解释均摘要于《Python进阶》一书。</p>
<blockquote>
<p>7.1 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/everything_is_object.html" target="_blank" rel="external">一切皆对象</a><br>python中的函数也是对象，可以讲一个函数赋值给一个变量。使用形如<code>func()</code>，带括号的是在调用函数，不带括号<code>func</code>只是python函数对象。 </p>
<p>7.2 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/def_func_in_func.html" target="_blank" rel="external">在函数中定义函数</a><br>在python中可以在一个函数中定义另一个函数，如下示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hi</span><span class="params">(name=<span class="string">'yasoob'</span>)</span>:</span></div><div class="line">    print(<span class="string">"now you are inside the hi() function"</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">greet</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the greet() function"</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">welcome</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the welcome() function"</span></div><div class="line">	print(greet())</div><div class="line">	print(welcome())</div><div class="line">	print(<span class="string">"now you are back in the hi() function"</span>)</div><div class="line"></div><div class="line">hi()</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># now you are inside the hi() function</span></div><div class="line"><span class="comment"># now you are in the greet() function</span></div><div class="line"><span class="comment"># now you are in the welcome() function</span></div><div class="line"><span class="comment"># now you are back in the hi() function</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>这个例子重点展示了无论何时你调用<code>hi()</code>函数，在<code>hi()</code>内的<code>greet()</code>和<code>welcome()</code>函数将会依次被调用。但是，<code>greet()</code>和<code>welcome()</code>函数在<code>hi()</code>函数之外是不能访问的。</p>
<blockquote>
<p>7.3 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/return_func_in_func.html" target="_blank" rel="external">从函数中返回函数</a><br>在嵌套的函数中，可以将嵌套的函数作为输出返回。如下示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hi</span><span class="params">(name=<span class="string">'yasoob'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">greet</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the greet() function"</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">welcome</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the welcome() function"</span></div><div class="line">    <span class="keyword">if</span> name == <span class="string">'yasoob'</span>:</div><div class="line">        <span class="keyword">return</span> greet</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> welcome</div><div class="line">a = hi()</div><div class="line">print(a)</div><div class="line"><span class="comment"># output  a是一个函数对象，不是在调用a函数</span></div><div class="line"><span class="comment"># &lt;function greet at 0x7f2143c01500&gt;</span></div><div class="line"></div><div class="line">print(a())</div><div class="line"><span class="comment"># output  调用 a函数</span></div><div class="line"><span class="comment"># now you are in the greet() function</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>在<code>if/else</code>语句中我们返回<code>greet</code>和<code>welcome</code>。而不是<code>greet()</code>和<code>welcome()</code>。为什么那样？因为当你把一对小括号放在后面，这个函数就会执行；如果你放括号在它后面，那它可以被到处传递，并且可以赋值给别的变量而不去执行它。</p>
<blockquote>
<p>7.4 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/func_as_argument.html" target="_blank" rel="external">将函数作为参数传递给另一个函数</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hi</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'hi yasoob!'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">doSomethingBeforHi</span><span class="params">(func)</span>:</span></div><div class="line">    print(<span class="string">"I am doing some boring work before executing hi()"</span>)</div><div class="line">    print(func())</div><div class="line">doSomethingBeforeHi(hi)</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># I am doing some boring work before executing hi()</span></div><div class="line"><span class="comment"># hi yasoob!</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>到这里，其实有一些装饰器小影子啦。<code>hi()</code>函数作为参数传递给<code>doSomethingBeforHi()</code>函数，在<code>print(func())</code>中被调用形式参数<code>func()=hi()</code>并且被打印输出。<br>现在已经具备所有必需知识，来进一步学习装饰器真正是什么了。装饰器让你在一个函数的前后去执行代码。</p>
<blockquote>
<p>7.5 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/your_first_decorator.html" target="_blank" rel="external">你的第一个装饰器</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_new_decorator</span><span class="params">(a_func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapTheFunction</span><span class="params">()</span>:</span></div><div class="line">        print(<span class="string">"I am doing some boring work befor executing a_func()"</span>)</div><div class="line">        a_func()</div><div class="line">        print(<span class="string">"I am doing some boring work after executing a_func()"</span>)</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> wrapTheFunction</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_function_requiring_decoration</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"I am the function which need some decoration to remove my foul smell"</span>)</div><div class="line"></div><div class="line">a_function_requiring_decoration()</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># I am the function which needs some decoration to remove my foul smell</span></div><div class="line"></div><div class="line">a_function_requiring_decoration = a_new_decorator(a_function_requiring_decoration)</div><div class="line"><span class="comment"># now a_function_requiring_decoration is wrapped by wrapTheFunction()</span></div><div class="line"></div><div class="line">a_function_requiring_decoration ()</div><div class="line"><span class="comment">#outputs:I am doing some boring work before executing a_func()</span></div><div class="line"><span class="comment">#        I am the function which needs some decoration to remove my foul smell</span></div><div class="line"><span class="comment">#        I am doing some boring work after executing a_func()</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>这正是装饰器做的事情，它们封装一个函数，并且修改它的行为。你也许会疑惑，在代码里并没有使用‘@’符号？<br>那只是一个简短的方式来生成一个被装备的函数。下面是使用“@”来重写之前的代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@a_new_decorator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_function_requiring_decoration</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Hey you! Decorate me!"""</span></div><div class="line">    print(<span class="string">"I am the function which needs some decoration to remove my foul smell"</span>)</div><div class="line"></div><div class="line">a_function_requiring_decoration()</div><div class="line"><span class="comment">#outputs: I am doing some boring work before executing a_func()</span></div><div class="line"><span class="comment">#         I am the function which needs some decoration to remove my foul smell</span></div><div class="line"><span class="comment">#         I am doing some boring work after executing a_func()</span></div></pre></td></tr></table></figure></p>
<p><strong>装饰器代码结构&lt;蓝本规范&gt;：</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> function <span class="keyword">import</span> wraps</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decorator_name</span><span class="params">(f)</span>:</span></div><div class="line"><span class="meta">    @wraps(f)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorated</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> can_run:</div><div class="line">            <span class="keyword">return</span> <span class="string">"Function will not run"</span></div><div class="line">        <span class="keyword">return</span> f(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> decorated</div><div class="line"></div><div class="line"><span class="meta">@decorator_name</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"Function is running"</span></div><div class="line"></div><div class="line">can_run = <span class="keyword">True</span></div><div class="line">print(func())</div><div class="line"><span class="comment"># Output: Function is running</span></div><div class="line"></div><div class="line">can_run = <span class="keyword">False</span></div><div class="line">print(func())</div><div class="line"><span class="comment"># Output: Function will not run</span></div></pre></td></tr></table></figure></p>
<p>注意，@wraps接受一个函数来进行装饰，并加入了复制函数名称、注释文档、参数列表等等的功能。可以让我们在装饰器里面访问在装饰器之前的函数的属性。</p>
<p><em>现在为止，个人对python的装饰器有一个大致的概念，但是还无法熟练使用和彻底理解装饰器的功能、写法、运用场景，还需要多回顾、多写、多体会</em></p>
<ol>
<li>虚拟环境（virtualenv）<br>创建独立的Python环境，而不是在全局安装所依赖的模块。<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install virtualenv</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>$ virtualenv myproject</code>  在“myproject”文件夹创建隔离环境；<br><code>$ source bin/activete</code>  激活这个隔离的环境；<br><code>$ deactivate</code> 退出隔离环境。</p>
<ol>
<li><p>容器（collections）<br>非常重要的数据结构，必须掌握的内置标准库。直接阅读collection模块的<a href="https://docs.python.org/3.6/library/collections.html" target="_blank" rel="external">官方文档</a>。</p>
</li>
<li><p>枚举<br>枚举（<a href="https://www.python.org/dev/peps/pep-0279/" target="_blank" rel="external">enumerate</a>）是Python内置函数。enumerate接受可选参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">enumerate</span><span class="params">(collection)</span>:</span></div><div class="line">   <span class="string">'Generates an indexed series:  (0,coll[0]), (1,coll[1]) ...'</span></div><div class="line">   i = <span class="number">0</span>  <span class="comment"># optional argument</span></div><div class="line">   it = iter(collection)</div><div class="line">   <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">      <span class="keyword">yield</span> (i, it.next())</div><div class="line">      i += <span class="number">1</span></div></pre></td></tr></table></figure>
</li>
<li><p>对象自省<br>自省（introspection），在计算机领域是指在运行时来判断一个对象的类型的能力。dir，返回一个对象所拥有的属性和方法的列表。深入了解可查看<a href="https://docs.python.org/3.6/library/inspect.html" target="_blank" rel="external"><code>inspect</code>模块</a></p>
</li>
<li><p>推导式（comprehensions）<br>列表list、字典dict、集合set推导式。</p>
</li>
<li><p>异常<br>异常处理时一种艺术，是必须要掌握的代码结构。try/except/finally语句块结构，可能触发异常的代码放到try语句块，而处理异常的代码放在except语句块，它会在try从句中的代码触发异常时执行，finally语句块是不管异常是否触发都将会被执行，一般用来在脚本执行之后做清理工作。</p>
</li>
</ol>
<p>可处理多个异常，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    file = open(<span class="string">'test.txt'</span>, <span class="string">'rb'</span>)</div><div class="line"><span class="keyword">except</span> (IOError, EOFError) <span class="keyword">as</span> e:</div><div class="line">    print(<span class="string">"An error occurred. &#123;&#125;"</span>.format(e.args[<span class="number">-1</span>]))</div><div class="line"></div><div class="line"><span class="comment"># 或</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    file = open(<span class="string">'test.txt'</span>, <span class="string">'rb'</span>)</div><div class="line"><span class="keyword">except</span> EOFError <span class="keyword">as</span> e:</div><div class="line">    print(<span class="string">"An EOF error occurred."</span>)</div><div class="line">    <span class="keyword">raise</span> e</div><div class="line"><span class="keyword">except</span> IOError <span class="keyword">as</span> e:</div><div class="line">    print(<span class="string">"An error occurred."</span>)</div><div class="line">    <span class="keyword">raise</span> e</div><div class="line"></div><div class="line"><span class="comment"># 下面这种方式会捕获所有异常</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    file = open(<span class="string">'test.txt'</span>, <span class="string">'rb'</span>)</div><div class="line"><span class="keyword">except</span> Exception:</div><div class="line">    <span class="comment"># 打印一些异常日志，如果你想要的话</span></div><div class="line">    <span class="keyword">raise</span></div></pre></td></tr></table></figure></p>
<ol>
<li><p>try/else<br>在没有触发异常的时候执行一些代码，通过else从句来实现。else从句只会在没有异常的情况下执行，而且它会在finally语句之前执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    print(<span class="string">'I am sure no exception is going to occur!'</span>)</div><div class="line"><span class="keyword">except</span> Exception:</div><div class="line">    print(<span class="string">'exception'</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="comment"># 这里的代码只会在try语句里没有触发异常时运行,</span></div><div class="line">    <span class="comment"># 但是这里的异常将 *不会* 被捕获</span></div><div class="line">    print(<span class="string">'This would only run if no exception occurs. And an error here '</span></div><div class="line">          <span class="string">'would NOT be caught.'</span>)</div><div class="line"><span class="keyword">finally</span>:</div><div class="line">    print(<span class="string">'This would be printed in every case.'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>lambda表达式<br>即匿名函数，也是非常有用的技巧。原型是<code>lambda 参数:操作(参数)</code>。经常使用在数据结构的<code>sort</code>排序中，例如：<code>a_list.sort(key=lambda x:x[1])</code>。</p>
</li>
<li><p>for-else<br>for循环还有一个else从句，这个else从句会在循环正常结束时执行，这意味着循环没有遇到任何的break，这是一种非常有用的代码结构。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">2</span>, n):</div><div class="line">        <span class="keyword">if</span> n % x == <span class="number">0</span>:</div><div class="line">            print( n, <span class="string">'equals'</span>, x, <span class="string">'*'</span>, n/x)</div><div class="line">            <span class="keyword">break</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="comment"># loop fell through without finding a factor</span></div><div class="line">        print(n, <span class="string">'is a prime number'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>上下文管理器（context managers）<br>在使用时，精确的分配和释放资源。常见的操作文件的上下文管理器，确保文件会被关闭。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> open(<span class="string">'some_file'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> opened_file:</div><div class="line">    opened_file.write(<span class="string">'Hola!'</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>基于类的实现上下文管理器，起码要定义<code>__enter__</code>和<code>__exit__</code>方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file_name, method)</span>:</span></div><div class="line">        self.file_obj = open(file_name, method)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.file_obj</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, traceback)</span>:</span></div><div class="line">        self.file_obj.close()</div><div class="line"><span class="comment">#1.with语句先暂存了File类的__exit__方法</span></div><div class="line"><span class="comment">#2.然后它调用File类的__enter__方法</span></div><div class="line"><span class="comment">#3.__enter__方法打开文件并返回给with语句</span></div><div class="line"><span class="comment">#4.打开的文件句柄被传递给opened_file参数</span></div><div class="line"><span class="comment">#5.我们使用.write()来写文件</span></div><div class="line"><span class="comment">#6.with语句调用之前暂存的__exit__方法</span></div><div class="line"><span class="comment">#7.__exit__方法关闭了文件</span></div></pre></td></tr></table></figure></p>
<hr>
<h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p>很好的资源，译者在 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/seealso.html" target="_blank" rel="external">http://www.lizenghai.com/doc/Intermediate_Python_CN/seealso.html</a> 分享的阅读资料。</p>
<p>感兴趣的小伙伴可以取Fork这个<a href="https://github.com/Yixiaohan/codeparkshare" target="_blank" rel="external">资源地址</a>。</p>
<hr>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>《Intermediate Python》本书的内容知识点相对简单，且数量仅仅是Python中的冰山一角，深入也仅仅是浅层。细读了两遍之后，推荐将这本书定位为入门书目。</p>
<p>其中“装饰器”部分重点推荐阅读，结合所给实例深入理解。</p>
<p>最后，仅借着写这篇读书笔记为由，第三遍读此书，感谢开源的力量。 : )</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/13/Python需求：嵌套序列展开/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/13/Python需求：嵌套序列展开/" itemprop="url">
                  Python需求：嵌套序列展开
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T22:52:48+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求简介"><a href="#需求简介" class="headerlink" title="需求简介"></a>需求简介</h3><p>将嵌套的列表（即列表内嵌套子列表）进行展开（直观的描述，即将“[]”内的左右中括号全部去掉）。实例的数据结构由简单且规则的形式，逐步推广到一般情况。</p>
<hr>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>Python 2.7  和  Python 3.5</p>
<hr>
<h3 id="示例一"><a href="#示例一" class="headerlink" title="示例一"></a>示例一</h3><p>需求：将形如<code>source_list = [[1,2],[3,4],[5,6]]</code>的数据结构，展开为<code>target_list = [1,2,3,4,5,6]</code>。</p>
<p>常规的处理方法比较多，下面主要介绍一个标准库提供的工具。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### example_1.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># Python 2.7 &amp; Python 3.5</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</div><div class="line"></div><div class="line">source_list = [[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>],[<span class="number">5</span>,<span class="number">6</span>]]</div><div class="line">target = list(chain.from_iterable(souce_list))</div><div class="line"></div><div class="line"><span class="comment"># out put data </span></div><div class="line"><span class="comment"># [1, 2, 3, 4, 5, 6]</span></div></pre></td></tr></table></figure>
<p>上述处理的方法，主要使用<code>itertools</code>库的<code>chain.from_iterable</code>工具。<code>itertools</code>模块主要包含创建迭代器和生成器的函数，这个模块是非常有用的内置标准库。</p>
<p><code>chain.from_iterable(iterable)</code>要求参数是可迭代的。直接将可迭代的数据展开为<code>&lt;class &#39;itertools.chain&#39;&gt;</code>对象。实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">from_iterable</span><span class="params">(iterables)</span>:</span></div><div class="line">    <span class="comment"># chain.from_iterable(['ABC','DEF']) --&gt; A B C D E F</span></div><div class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> iterables:</div><div class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> it:</div><div class="line">            <span class="keyword">yield</span> element</div></pre></td></tr></table></figure>
<p>从<code>chain.from_iterable(iterable)</code>实现中也可以发现，这个方法主要使用与两层的嵌套列表数据结构的展开。接下来我们再看一个更加一般的数据结构。</p>
<hr>
<h3 id="示例二"><a href="#示例二" class="headerlink" title="示例二"></a>示例二</h3><p>需求：将形如<code>source_list = [1, 2, [3, 4, [5, 6], 7], 8]</code>的数据结构，展开为<code>target_list = [1,2,3,4,5,6,7,8]</code>。</p>
<p>这个source_list的结构就特别一般化了，我们不确定具体的嵌套的形式和层数，列表中的子列表可能是序列，子列表的子项仍可能是列表序列。列表的嵌套是任意的深度。最终的结果要求是循环遍历所有列表和子列表，将其所有的元素展开成为一个单一的列表。</p>
<p>解决方案：此处最明显考虑到的就是递归形式的迭代器和生成器。我们循环遍历列表的元素，依次判断其元素是否可迭代，若不可迭代，直接将其返回，若可迭代，执行上述遍历子列表和判断步骤。实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### example_2.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># Python 2.7</span></div><div class="line"><span class="keyword">from</span> collections impot Iterable</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(items, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></div><div class="line">    <span class="string">''' items:iterable data structure</span></div><div class="line">    ignore_types:默认提供的数据类型不再展开'''</div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</div><div class="line">        <span class="keyword">if</span> isinstance(item, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(item, ignore_types):</div><div class="line">            <span class="keyword">for</span> it <span class="keyword">in</span> flatten(item):</div><div class="line">                <span class="keyword">yield</span> foo</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">yield</span> item</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    items = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>], <span class="number">7</span>], <span class="number">8</span>]</div><div class="line">    target_list = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target_list.append()</div><div class="line">    <span class="keyword">print</span> target_list</div><div class="line">    <span class="comment"># [1,2,3,4,5,6,7,8]</span></div><div class="line"></div><div class="line">    items = [<span class="string">'xiao Z'</span>, <span class="string">'xiao Q'</span>, [<span class="string">'xiao D'</span>, <span class="string">'xiao Y'</span>]]</div><div class="line">    target = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target.append(x)</div><div class="line">    <span class="keyword">print</span> target</div><div class="line">    <span class="comment"># ['xiao Z', 'xiao Q', 'xiao D', 'xiao Y']</span></div></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### example_2.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># Python 3.5</span></div><div class="line"><span class="keyword">from</span> collections impot Iterable</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(items, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></div><div class="line">    <span class="string">''' items:iterable data structure</span></div><div class="line">    ignore_types:默认提供的数据类型不再展开'''</div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</div><div class="line">        <span class="keyword">if</span> isinstance(item, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(item, ignore_types):</div><div class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> flatten(item)    <span class="comment"># &lt;== 主要的区别所在</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">yield</span> item</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    items = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>], <span class="number">7</span>], <span class="number">8</span>]</div><div class="line">    target_list = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target_list.append()</div><div class="line">    print(target_list)</div><div class="line">    <span class="comment"># [1,2,3,4,5,6,7,8]</span></div><div class="line"></div><div class="line">    items = [<span class="string">'xiao Z'</span>, <span class="string">'xiao Q'</span>, [<span class="string">'xiao D'</span>, <span class="string">'xiao Y'</span>]]</div><div class="line">    target = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target.append(x)</div><div class="line">    print(target)</div><div class="line">    <span class="comment"># ['xiao Z', 'xiao Q', 'xiao D', 'xiao Y']</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://docs.python.org/2/library/itertools.html" target="_blank" rel="external">itertools python2.7</a><br><a href="https://docs.python.org/3/library/itertools.html" target="_blank" rel="external">itertools python3.5</a></p>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>详细学习<code>itertools</code>内置模块</li>
<li>学习迭代器和生成器（yield）</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/01/Python需求：批量解压ZIP文件，并获取简单信息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/01/Python需求：批量解压ZIP文件，并获取简单信息/" itemprop="url">
                  Python需求：批量解压ZIP文件，并获取简单信息
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-01T00:50:08+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求简介"><a href="#需求简介" class="headerlink" title="需求简介"></a>需求简介</h3><p>现在需要获取服务器上某一类文件夹下的全部ZIP文件的创建时间信息，以及ZIP文件内的内容行数信息。服务器上基础的文件层级如下截图：<br><img src="http://on58f12qv.bkt.clouddn.com/%E9%9C%80%E6%B1%82-1.PNG" alt="需求-1|center"><br>其中以“YYYMM”命名的文件均为目标文件夹，“result”文件存放我们中间处理的结果以及放置脚本的位置，这些文件均在某一个固定目录下。其中“YYYYMM”文件夹下均未ZIP压缩文件，如下截图：<br><img src="http://on58f12qv.bkt.clouddn.com/%E9%9C%80%E6%B1%82-2.PNG" alt="需求-2|center"></p>
<p>需要说明的一点，在ZIP文件内，是不定数量的Excel（“.xls”格式，且以中文命名，而且只保证在单个ZIP文件下不重复）文件的压缩包（可能是空文件，也可能有很多个）。</p>
<p>现在的需求即：统计这些ZIP文件的创建时间，ZIP内各Excel的行数信息。</p>
<hr>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>获取某固定目录下的子目录以及各子目录下的ZIP文件列表，依次获取ZIP的创建时间信息。就ZIP文件内各Excel行数信息而言，需要将各ZIP文件解压，之后通过读取Excel获取行数信息。</p>
<p>大致的思路就是上述步骤，接下来是具体的代码实现。</p>
<hr>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><ul>
<li>Ubuntu</li>
<li>Python 2.7.10</li>
</ul>
<p>代码结构如下截图：<br><img src="http://on58f12qv.bkt.clouddn.com/%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png" alt="代码结构|center"></p>
<h4 id="解压zip文件"><a href="#解压ZIP文件" class="headerlink" title="解压ZIP文件"></a>解压ZIP文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## Unzip_file.py</span></div><div class="line"><span class="comment">## 实现ZIP文件的自动解压,同时读取各ZIP文件的创建时间</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="comment"># root_dir = '/mnt/home/data/upload'   #此路径为个人路径</span></div><div class="line">root_dir = <span class="string">'/mnt/online-env/upload/file'</span>   <span class="comment"># 此路径为线上环境路径</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dir_list</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">""" 获取指定路径下子目录列表"""</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    <span class="keyword">if</span> os.path.exists(root_dir):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            dir_list = os.listdir(root_dir)</div><div class="line">            <span class="keyword">return</span> dir_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The root_dir is not exists.'</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_zip_list</span><span class="params">(target_dir)</span>:</span></div><div class="line">    <span class="string">""" 获取指定子目录下的ZIP文件列表"""</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    target_dir_ = os.path.join(root_dir, target_dir)</div><div class="line">    <span class="keyword">if</span> os.path.exists(target_dir_):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            zip_list = [zp <span class="keyword">for</span> zp <span class="keyword">in</span> os.listdir(target_dir_)]</div><div class="line">            <span class="keyword">return</span> zip_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(target_dir)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">unzip_file</span><span class="params">(target_dir,zip_name)</span>:</span></div><div class="line">    <span class="string">""" 自动化解压ZIP文件功能"""</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    zip_file = os.path.join(root_dir, target_dir, zip_name)</div><div class="line">    <span class="keyword">if</span> os.path.exists(zip_file):</div><div class="line">	    <span class="comment"># root_dir是生产环境,不宜操作.故将数据解压到指定个人路径.</span></div><div class="line">	    <span class="comment"># 因ZIP文件只保证单个ZIP下不重复,因此以ZIP文件的"(*).ZIP"形式创建文件夹,存放对应解压后的Excel文件</span></div><div class="line">        new_dir_path = <span class="string">'/mnt/home/data/upload/result/&#123;0&#125;'</span>.format(zip_name[:<span class="number">-4</span>])</div><div class="line">        os.system(<span class="string">'mkdir &#123;0&#125;'</span>.format(new_dir_path))</div><div class="line">        os.system(<span class="string">'unzip -n -O CP936 &#123;0&#125; -d &#123;1&#125;'</span>.format(zip_file, new_dir_path))</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(zip_file)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">        </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_time</span><span class="params">(target_dir, zip_file)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    zip_path = os.path.join(root_dir, target_dir, zip_file)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> os.path.exists(zip_path):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            create_time = os.path.getctime(zip_path)</div><div class="line">            <span class="keyword">return</span>  zip_path[:<span class="number">-4</span>], datetime.fromtimestamp(create_time)</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(zip_path)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    dir_list = get_dir_list()</div><div class="line">	<span class="comment"># 保存ZIP文件创建时间</span></div><div class="line">    file_save = codecs.open(<span class="string">'/mnt/home/data/upload/time_result.txt'</span>, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> target_dir <span class="keyword">in</span> dir_list:</div><div class="line">        zip_list = get_zip_list(target_dir)</div><div class="line">        <span class="keyword">for</span> zip_name <span class="keyword">in</span> zip_list:</div><div class="line">            unzip_file(target_dir, zip_name)</div><div class="line">            zip_path, create_time = get_time(target_dir, zip_name)</div><div class="line">            file_save.write( zip_path.decode(<span class="string">'utf-8'</span>) + <span class="string">'\t'</span> + create_time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>) +<span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    file_save.close()</div></pre></td></tr></table></figure>
<p>实现代码比较简单，其中备注下在Debug代码过程中踩的坑。<br><strong>k-1</strong></p>
<blockquote>
<p>因为需要操作生成环境下的文件，首先想到的第一步措施可能是将数据文件全部CP或者MV到指定的个人目录下。在这个地方趟的第一个坑，就是CP或MV命令操作ZIP文件之后，其时间就会发生变化，更新为命令动作发生时的时间。所以，选择的方法是在解压ZIP文件的同时，顺道将ZIP文件的创建时间信息获取并保存。</p>
</blockquote>
<p><strong>k-2</strong></p>
<blockquote>
<p>这个算是个小知识吧，不能算坑~。<code>os.listdir()</code>自动过滤指定目录下的当前目录和上级目录，这个在解释器内执行下对应代码即可了解。</p>
</blockquote>
<p><strong>k-3</strong></p>
<blockquote>
<p>前面也已经提到了ZIP内Excel的特征。因为是中文Excel名称，在解压时若直接使用<code>unzip file_name</code>命令，得到的Excel名称是乱码形式，并在下一步的Excel读取行数的过程中无法正常读取。因此调整命令为<code>unzip -O CP936 file_name</code>，完美将解压后中文问题解决。<br>其次，因为ZIP文件内的Excel命名格式只能保证在此ZIP文件下是不重复的，无法保证所有的ZIP下的文件都是不重复的。所以在此，选择了一个比较粗鲁的方案。依据ZIP文件的文成来生成对应的文件夹，同时将指定解压的文件目标路径为上述创建的文件夹中。因此调整命令为<code>unzip -n -d target_path</code>。</p>
</blockquote>
<p>这部分主要逻辑和代码是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">new_dir_path = <span class="string">'/mnt/home/data/upload/result/&#123;0&#125;'</span>.format(zip_name[:<span class="number">-4</span>])</div><div class="line">os.system(<span class="string">'mkdir &#123;0&#125;'</span>.format(new_dir_path))</div><div class="line">os.system(<span class="string">'unzip -n -O CP936 &#123;0&#125; -d &#123;1&#125;'</span>.format(zip_file, new_dir_path))</div></pre></td></tr></table></figure></p>
<p>到此，解压ZIP文件的工作已经完成。接下来统计Excel行数的工作就比较轻松啦。</p>
<h4 id="统计excel行数"><a href="#统计Excel行数" class="headerlink" title="统计Excel行数"></a>统计Excel行数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment">## Summary_info.py</span></div><div class="line"><span class="comment">## 统计解压后的Excel文件的行数信息</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlrd</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="comment"># 个人数据处理路径</span></div><div class="line">root_dir = <span class="string">'/mnt/home/data/upload/result'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dir_list</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    <span class="keyword">if</span> os.path.exists(root_dir):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            dir_list = os.listdir(root_dir)</div><div class="line">            dir_list.pop(dir_list.index(<span class="string">'Summary_info.py'</span>))</div><div class="line">            dir_list.pop(dir_list.index(<span class="string">'Unzip_files.py'</span>))</div><div class="line">            <span class="keyword">return</span> dir_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The root_dir is not exists.'</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dir_list_</span><span class="params">(target_dir)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    dir_ = os.path.join(root_dir, target_dir)</div><div class="line">    <span class="keyword">if</span> os.path.exists(dir_):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            file_list = os.listdir(dir_)</div><div class="line">            <span class="keyword">return</span> file_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The root_dir is not exists.'</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_time</span><span class="params">(target_dir, excel_file)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    excel_path = os.path.join(root_dir, target_dir, excel_file)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> os.path.exists(excel_path):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            create_time = os.path.getctime(excel_path)</div><div class="line">            <span class="keyword">return</span>  excel_path, datetime.fromtimestamp(create_time)</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(excel_file)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rows</span><span class="params">(target_dir, excel_file)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    excel_path = os.path.join(root_dir, target_dir, excel_file)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> os.path.exists(excel_path):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            excelFile = xlrd.open_workbook(excel_path.decode(<span class="string">'utf-8'</span>))</div><div class="line">            sheet = excelFile.sheet_by_index(<span class="number">0</span>)</div><div class="line">            nrows = sheet.nrows</div><div class="line">            <span class="keyword">return</span> nrows</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(excel_file)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    dir_list = get_dir_list()</div><div class="line"></div><div class="line">    file_save = codecs.open(<span class="string">'/mnt/home/data/upload/summary_result.txt'</span>, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> target_dir <span class="keyword">in</span> dir_list:</div><div class="line">        file_list = get_dir_list_(target_dir)</div><div class="line">        <span class="keyword">if</span> file_list <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">for</span> excel_file <span class="keyword">in</span> file_list:</div><div class="line">                excel_path, create_time = get_time(target_dir, excel_file)</div><div class="line">                nrows = get_rows(target_dir, excel_file)</div><div class="line">                file_save.write( excel_path.decode(<span class="string">'utf-8'</span>) + <span class="string">'\t'</span> + create_time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>) + <span class="string">'\t'</span> + str(nrows) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    file_save.close()</div></pre></td></tr></table></figure>
<p>这部分的代码很简单，只需要稍微注意下<code>xlrd.open_workbook()</code>中文名的Excel即可。</p>
<hr>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>重构代码，两个功能部分的代码还是有很大的相似性，减少代码的冗余，使代码更加通用化</li>
<li>扩展获取文件相关信息的功能</li>
</ol>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><ol>
<li>Python官方 OS 文档</li>
<li>Ubuntu unzip 命令</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/05/30/Python项目：定制化词云/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/30/Python项目：定制化词云/" itemprop="url">
                  Python项目：定制化词云
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-30T22:26:34+08:00">
                2017-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h3><p>“词云”是对常见的文本中出现频率较高的“关键词”或“高频词”予以视觉和展示上的突出，形成层次有序、主题突出的“词云”图形，从而过滤掉大量的无意义信息，并凸显想要展示的信息内容。<br>一幅制作精美的词云图片，可以达到一图胜千言的效果，通常在PPT报告中使用漂亮的词云，关键是可以装X~   :）</p>
<p>接下来，将使用<code>wordcloud</code>第三方包来制作词云，并且解决中文字符显示的问题，生成定制化个性词云。</p>
<hr>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li>Python 3.6</li>
</ul>
<hr>
<h3 id="第三方packages"><a href="#第三方Packages" class="headerlink" title="第三方Packages"></a>第三方Packages</h3><ul>
<li>wordcloud</li>
<li>PIL</li>
</ul>
<hr>
<h4 id="wordcloud安装"><a href="#wordcloud安装" class="headerlink" title="wordcloud安装"></a>wordcloud安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple wordcloud</div></pre></td></tr></table></figure>
<p>Windows环境下，推荐从<a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/" target="_blank" rel="external">非官方Windows第三方库</a>下载安装。<br><img src="http://on58f12qv.bkt.clouddn.com/Unoffical_wordcloud.PNG" alt="wordcloud|center"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install C:\Users\Desktop\wordcloud-1.3.1-cp36-cp36m-win_amd64.whl</div></pre></td></tr></table></figure></p>
<p><code>Unofficial Windows Binaries for Python Extension Packages</code>可以高效的在windows环境下安装第三方包，并且避免pip安装过程中莫名其妙的坑。</p>
<p><strong>wordcloud</strong><a href="https://github.com/amueller/word_cloud" target="_blank" rel="external">GitHub</a>。wordcloud作者是使用Python2+编写，但是Python3+也是兼容的。</p>
<h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><p>官方Git展示的简单示例，将《美国宪法》生成词云。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</div><div class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line">FILE_PATH = path.dirname(__file__)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_text</span><span class="params">(FILE_NAME)</span>:</span></div><div class="line">	<span class="keyword">global</span> FILE_PATH</div><div class="line">	file_path = path.join(FILE_PATH, FILE_NAME)</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="keyword">with</span> codecs.open(file_path, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">			text = file.read()</div><div class="line">		<span class="keyword">return</span> text</div><div class="line">	<span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</div><div class="line">		print(<span class="string">"FileNot Found ,&#123;&#125;"</span>.format(e))</div><div class="line">		<span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_wordcloud</span><span class="params">(text,)</span>:</span></div><div class="line">	wordcloud = WordCloud(max_font_size=<span class="number">40</span>).generate(text)</div><div class="line"></div><div class="line">	plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>)</div><div class="line">	plt.axis(<span class="string">"off"</span>)</div><div class="line">	plt.show()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	FILE_NAME = <span class="string">'US_constitution.txt'</span></div><div class="line">	text = load_text(FILE_NAME)</div><div class="line"></div><div class="line">	generate_wordcloud(text)</div></pre></td></tr></table></figure></p>
<p>下图是生成的《美国宪法》默认样式参数的词云图。<br><img src="http://on58f12qv.bkt.clouddn.com/US_constitution.txt.jpeg" alt="美国宪法-词云|center"></p>
<p><code>wordcloud</code>包的核心是<code>WordCloud</code>类，用于生成和绘制WordCloud对象。<br><strong>参数：</strong></p>
<ul>
<li>font_path  要使用的字体的路径（OTF或TTF文件）</li>
<li>width  画布宽度，默认400</li>
<li>heifht  画布高度，默认200</li>
<li>prefer_horizontal </li>
<li>mask </li>
<li>scale 缩放，默认1</li>
<li>min_font_size 使用最小的字体大小，默认4</li>
<li>font_step 字体的步长大小，morning1</li>
<li>max_words 最大字数，默认200</li>
<li>stopwords  禁用词，默认内置的STOPWORDS列表</li>
<li>background_color 词云图像的北京颜色，默认black</li>
<li>max_font_size 最大字体的字体大小</li>
<li>mode 模式，默认RGB，当mode=RGBA时，产生透明背景</li>
<li>relative_scaling</li>
<li>color_func callable，default=None。一般使用Image的generate_image方法获取图片的颜色设置</li>
<li>colormap 色彩映射将每个单词随机绘制颜色</li>
</ul>
<p>在上面的代码中，当输入中文格式的文本时，是不能正常显示的中文的。如下图所示：<br><img src="http://on58f12qv.bkt.clouddn.com/%E4%B8%AD%E6%96%87%E9%97%AE%E9%A2%98.png" alt="中文问题|center"></p>
<p>因为WordCloud类中font_path参数变量没有找到显示中文的字体。通过WordCloud的参数说明，可以用font_path参数来设置可显示中文的字体。并将对应部分的代码进行如下调整：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_wordcloud</span><span class="params">(text, save_name, font_name=None)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> font_path:</div><div class="line">        wordcloud = WordCloud(max_font_size=<span class="number">40</span>).generate(text) </div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        wordcloud = WordCloud(font_path=path.join(FILE_PATH,font_name),max_font_size=<span class="number">40</span>).generate(text)</div><div class="line"></div><div class="line">    plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>)</div><div class="line">    plt.axis(<span class="string">"off"</span>)</div><div class="line">    plt.savefig(save_name+<span class="string">".jpeg"</span>)</div><div class="line">    plt.show()</div></pre></td></tr></table></figure></p>
<p>调整之后的词云结果如下：<br><img src="http://on58f12qv.bkt.clouddn.com/%E6%AD%A3%E5%B8%B8%E6%98%BE%E7%A4%BA.png" alt="解决中文问题|center"></p>
<hr>
<h3 id="奇形怪状的词云"><a href="#奇形怪状的词云" class="headerlink" title="奇形怪状的词云"></a>奇形怪状的词云</h3><p>接下来，我们绘制定制图形的词云！git官方的实例，是关于爱丽丝的一个词云。</p>
<h4 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'MaFuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</div><div class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud,STOPWORDS</div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line">FILE_PATH = path.dirname(__file__)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_text</span><span class="params">(FILE_NAME)</span>:</span></div><div class="line">	<span class="keyword">global</span> FILE_PATH</div><div class="line">	file_path = path.join(FILE_PATH, FILE_NAME)</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="keyword">with</span> codecs.open(file_path, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">			text = file.read()</div><div class="line">		<span class="keyword">return</span> text</div><div class="line">	<span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</div><div class="line">		print(<span class="string">"FileNot Found ,&#123;&#125;"</span>.format(e))</div><div class="line">		<span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_wordcloud</span><span class="params">(text, save_name, font_name=None, mask_name=None)</span>:</span></div><div class="line">	<span class="keyword">global</span> FILE_PATH</div><div class="line"></div><div class="line">	image_mask = np.array(Image.open(path.join(FILE_PATH,mask_name)))</div><div class="line">	stopwords = set(STOPWORDS)</div><div class="line">	stopwords.add(<span class="string">"said"</span>)</div><div class="line"></div><div class="line">	wordcloud = WordCloud(background_color=<span class="string">'white'</span>, max_words=<span class="number">2000</span>, mask=image_mask,</div><div class="line">	                            stopwords=stopwords,font_path=path.join(FILE_PATH,font_name))</div><div class="line">	wordcloud.generate(text)</div><div class="line"></div><div class="line">	wordcloud.to_file(path.join(FILE_PATH, save_name.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.png'</span>))</div><div class="line">	plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>, cmap=plt.cm.gray)</div><div class="line">	plt.axis(<span class="string">"off"</span>)</div><div class="line">	plt.savefig(path.join(FILE_PATH, save_name.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.png'</span>))</div><div class="line">	plt.show()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	FILE_NAME = <span class="string">'alice.txt'</span></div><div class="line">	text = load_text(FILE_NAME)</div><div class="line"></div><div class="line">	generate_wordcloud(text, FILE_NAME, font_name=<span class="string">'simhei.ttf'</span>, mask_name=<span class="string">'alice_mask.png'</span>)</div></pre></td></tr></table></figure>
<p>效果图如下所示：<br><img src="http://on58f12qv.bkt.clouddn.com/alice.png" alt="alice|center|800*0"></p>
<p>最核心的一个参数是<code>mask=image_mask</code>，设置一个图片轮廓作为词云的mask，让我们的单词只在这个mask的空间内进行展示。</p>
<hr>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>代码重构</li>
<li>参数添加，更加通用化</li>
<li>可否制作成可安装的exe小程序</li>
</ol>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://github.com/amueller/word_cloud" target="_blank" rel="external">https://github.com/amueller/word_cloud</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/05/22/Python项目：小说汉字统计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/22/Python项目：小说汉字统计/" itemprop="url">
                  Python项目：小说汉字统计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-22T22:26:17+08:00">
                2017-05-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h3><p>这个练手代码实际不能称为“项目”的，因为实在是太简单，并且没有实质的干货内容。这篇博客仅仅是做一个小小的记录，在过程的一些坑做一个小备忘。：)</p>
<hr>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li>Python 2.7.10</li>
<li>文本素材：随便一本小说即可(注意文本数据的编码UTF-8)</li>
</ul>
<hr>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>大的方向即：获取文件的内容，并高效的拆分单个汉字，简单统计各个汉字在小说文件中出现的次数（没有什么实质意义）。将统计结果排序，并且查看在小说文件中最长见的Top-N汉字，并将统计结果数据保存。</p>
<hr>
<h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/ - <span class="comment"># 根目录</span></div><div class="line">  -	./data</div><div class="line">  - main.py</div></pre></td></tr></table></figure>
<hr>
<h4 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># main.py 代码</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Characters_Summary</span><span class="params">(object)</span>:</span></div><div class="line">	<span class="keyword">global</span> stop_characters</div><div class="line">	</div><div class="line">	stop_characters = [<span class="string">''</span>,<span class="string">'\t'</span>,<span class="string">'\n'</span>,<span class="string">'.'</span>,<span class="string">','</span>,<span class="string">'?'</span>,<span class="string">'!'</span>,<span class="string">'('</span>,<span class="string">')'</span>,<span class="string">':'</span>,<span class="string">'&#123;'</span>,<span class="string">'&#125;'</span>,<span class="string">';'</span>,<span class="string">'/'</span>,<span class="string">'['</span>,<span class="string">']'</span>,<span class="string">'．'</span>,<span class="string">'＋'</span>,<span class="string">'—'</span>,<span class="string">''</span>,<span class="string">'\r\n'</span>,<span class="string">'"'</span>,<span class="string">'*'</span>,<span class="string">'-'</span>,<span class="string">u'。'</span>,<span class="string">u'，'</span>,<span class="string">u'？'</span>,<span class="string">u'！'</span>,<span class="string">u'（'</span>,<span class="string">u'）'</span>,<span class="string">u'：'</span>,<span class="string">u'；'</span>,<span class="string">u'《'</span>,<span class="string">u'》'</span>,<span class="string">u'’'</span>,<span class="string">u'‘'</span>,<span class="string">u''</span>,<span class="string">u'【'</span>,<span class="string">u'】'</span>,<span class="string">u'、'</span>,<span class="string">u'￥'</span>,<span class="string">u'“'</span>,<span class="string">u'…'</span>,<span class="string">u'”'</span>,<span class="string">u'*'</span>,<span class="string">u'-'</span>,<span class="string">u''</span>]</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file_in_path)</span>:</span></div><div class="line">		self.stop_characters = stop_characters</div><div class="line">		self.file_in_path = file_in_path</div><div class="line">		self.characters_dict = self.main()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(self)</span>:</span></div><div class="line">		characters_dict = Counter()</div><div class="line">		<span class="keyword">try</span>:</div><div class="line">			<span class="keyword">with</span> codecs.open(self.file_in_path, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">				<span class="keyword">for</span> line <span class="keyword">in</span> file:</div><div class="line">					line = line.strip()</div><div class="line">					<span class="keyword">if</span> <span class="keyword">not</span> line:</div><div class="line">						<span class="keyword">continue</span></div><div class="line">					<span class="keyword">else</span>:</div><div class="line">						<span class="keyword">for</span> idx,character <span class="keyword">in</span> enumerate(line):</div><div class="line">							<span class="keyword">if</span> character <span class="keyword">not</span> <span class="keyword">in</span> self.stop_characters <span class="keyword">and</span> <span class="keyword">not</span> re.search(<span class="string">r'[0-9]|[A-Z]'</span>,character,re.S):</div><div class="line">								characters_dict[character] += <span class="number">1</span></div><div class="line">			<span class="keyword">return</span> characters_dict</div><div class="line">		<span class="keyword">except</span> Exception,e:</div><div class="line">			<span class="keyword">print</span> <span class="string">'Error Information :'</span>,e</div><div class="line">			<span class="keyword">return</span> dict()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">sort_</span><span class="params">(self)</span>:</span></div><div class="line">		<span class="keyword">if</span> <span class="keyword">not</span> self.characters_dict:</div><div class="line">			<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			characters_dict_sorted = sorted(self.characters_dict.iteritems(), key=<span class="keyword">lambda</span> d:d[<span class="number">1</span>], reverse=<span class="keyword">True</span>)</div><div class="line">			<span class="keyword">return</span> characters_dict_sorted</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">most_comm</span><span class="params">(self, top=None)</span>:</span></div><div class="line">		<span class="keyword">if</span> <span class="keyword">not</span> self.characters_dict:</div><div class="line">			<span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			<span class="keyword">return</span> self.characters_dict.most_common(top)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_txt</span><span class="params">(self, file_save_path)</span>:</span></div><div class="line">		<span class="keyword">if</span> <span class="keyword">not</span> self.characters_dict:</div><div class="line">			<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			<span class="keyword">if</span> isinstance(self.characters_dict, dict):</div><div class="line">				<span class="keyword">with</span> codecs.open(file_save_path, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">					<span class="keyword">for</span> character, cnt <span class="keyword">in</span> self.characters_dict.iteritems():</div><div class="line">						file.write(character + <span class="string">'\t'</span> + str(cnt) + <span class="string">'\n'</span>)</div><div class="line">			<span class="keyword">elif</span> isinstance(self.characters_dict, list):</div><div class="line">				<span class="keyword">with</span> codecs.open(file_save_path, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">					<span class="keyword">for</span> tuple_ <span class="keyword">in</span> self.characters_dict:</div><div class="line">						character, cnt = tuple_</div><div class="line">						file.write(character + <span class="string">'\t'</span> + str(cnt) + <span class="string">'\n'</span>)</div><div class="line">			<span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_json</span><span class="params">(self, file_save_path)</span>:</span></div><div class="line">		<span class="keyword">if</span> <span class="keyword">not</span> self.characters_dict:</div><div class="line">			<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			<span class="keyword">with</span> codecs.open(file_save_path, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">				file.write(json.dumps(self.characters_dict))</div><div class="line">			<span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	characters = Characters_Summary(<span class="string">'./data/novel.txt'</span>)</div><div class="line"></div><div class="line">	characters.most_comm(top=<span class="number">50</span>)</div><div class="line">	characters.save_txt(<span class="string">'./data/out_txt.txt'</span>)</div><div class="line">	characters.save_json(<span class="string">'./data/out_json.json'</span>)</div></pre></td></tr></table></figure>
<hr>
<h4 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h4><ol>
<li>小说文本数据，推荐使用UTF-8编码，并且注意编辑器所对应的编码设置。在Python2.7中常见的编码解码问题</li>
<li>停用标点符号的清洗和过滤，配合正则表达式使用</li>
<li>dict数据结构，通过<code>sorted(dict.iteritems(), key=lambda d:d[1], reverse=True)</code>排序后返回的数据是list类型，因为dict是无序的，若要排序，就需要数据类型可排序</li>
</ol>
<h4 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h4><ol>
<li>Counter()类及其方法的使用，高效便捷！</li>
</ol>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>单个汉字统计，没有实质的信息，后续通过分词并在其基础上，进一步探索</li>
<li>在停用标点符号过滤部分代码，提示一个警告：’UnicodeWarning: Unicode equal comparison failed to convert both arguments to Unicode - interpreting them as being unequal<br>if character not in self.stop_characters and not re.search(r’[0-9]|[A-Z]’,character,re.S)’<br>这个警告主要因为停用标点符号中有字符无法将其转换为Unicode，不能正常的判定是否需要过滤操作。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/05/16/数据需求-转换Excel数据形式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/16/数据需求-转换Excel数据形式/" itemprop="url">
                  [数据需求] 转换Excel数据形式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-16T21:58:13+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h3><p>这个数据需求来自Q群水友：期望将Excel内各行的文本数据，转化为表格形式的数据以方便统计。</p>
<p>常规的Excel函数或多次分列、VBA、可以进行处理，现在用Python来解决实现这一需求。</p>
<p>需求数据示例如下：<br><img src="http://on58f12qv.bkt.clouddn.com/%E6%95%B0%E6%8D%AE%E9%9C%80%E6%B1%82.png" alt="数据需求|center"></p>
<p>数据格式比较规律，分别以”,”分隔为一组数据tuple，tuple内部以不定长空格进行分隔字段fields。</p>
<p>处理转化为结果示例如下：<br><img src="http://on58f12qv.bkt.clouddn.com/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%9C.png" alt="需求结果|center"></p>
<hr>
<h3 id="python实现"><a href="#Python实现" class="headerlink" title="Python实现"></a>Python实现</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>python version：2.7.10<br>系统：windows</p>
<h4 id="第三方package"><a href="#第三方Package" class="headerlink" title="第三方Package"></a>第三方Package</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip install xlsxwriter</div><div class="line">pip install pandas</div></pre></td></tr></table></figure>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="string">""" Transform the Excel Data.</span></div><div class="line">"""</div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> xlsxwriter</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Data</span><span class="params">(file_in, sheetname=<span class="number">0</span>)</span>:</span></div><div class="line">	df = pd.read_excel(file_in, sheetname=sheetname)</div><div class="line">	data = []</div><div class="line">	<span class="keyword">for</span> line <span class="keyword">in</span> df[df.columns[<span class="number">1</span>]]:</div><div class="line">		data.append(line)</div><div class="line">	<span class="keyword">return</span> data</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_workbook</span><span class="params">(workbook_name, sheet_name)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        workbook = xlsxwriter.Workbook((workbook_name + <span class="string">".xlsx"</span>))</div><div class="line">        worksheet = workbook.add_worksheet(sheet_name)</div><div class="line">        <span class="keyword">print</span> <span class="string">"the %s excel workbook has been created successfully!"</span> % (workbook_name + <span class="string">".xlsx"</span>)</div><div class="line">        <span class="keyword">return</span> workbook,worksheet</div><div class="line">    <span class="keyword">except</span> Exception,e:</div><div class="line">        <span class="keyword">print</span> e</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_title</span><span class="params">(worksheet, title_lists, row=<span class="number">1</span>, col=<span class="number">0</span>, title_format=None)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">for</span> i,title <span class="keyword">in</span> enumerate(title_lists):</div><div class="line">            <span class="keyword">if</span> title:</div><div class="line">                worksheet.write(row, col+i, title, title_format)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">break</span></div><div class="line">    <span class="keyword">except</span> Exception,e:</div><div class="line">        <span class="keyword">return</span> e</div><div class="line">    <span class="keyword">print</span> <span class="string">"Done Successful!"</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_style</span><span class="params">(workbook)</span>:</span></div><div class="line">    <span class="keyword">if</span> workbook:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            title_formats = workbook.add_format(&#123;<span class="string">'bold'</span>:<span class="keyword">True</span>, <span class="string">'bg_color'</span>:<span class="string">'#B0C4DE'</span>, <span class="string">'font_size'</span>:<span class="number">10</span>, <span class="string">'font_name'</span>:<span class="string">'Microsoft yahei'</span>&#125;)</div><div class="line">            cell_formats = workbook.add_format(&#123;<span class="string">'bold'</span>:<span class="keyword">False</span>,<span class="string">'font_size'</span>:<span class="number">10</span>, <span class="string">'font_name'</span>:<span class="string">'Microsoft yahei'</span>&#125;)</div><div class="line">            date_formats = workbook.add_format(&#123;<span class="string">'bold'</span>:<span class="keyword">False</span>,<span class="string">'font_size'</span>:<span class="number">10</span>, <span class="string">'font_name'</span>:<span class="string">'Microsoft yahei'</span>, <span class="string">'num_format'</span>: <span class="string">'yyyy-mm-dd'</span>&#125;)</div><div class="line">            <span class="keyword">return</span> title_formats,cell_formats,date_formats</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">"the workbook object is invalid, please check the workbook object!"</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"please check and input the correct workbook object!"</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_data</span><span class="params">(worksheet,data,row=<span class="number">2</span>,col=<span class="number">0</span>)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        i = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> data:</div><div class="line">            j = <span class="number">0</span></div><div class="line">            <span class="keyword">for</span> tp <span class="keyword">in</span> line.split(<span class="string">','</span>):</div><div class="line">                name,count,amount = tp.split()</div><div class="line">                worksheet.write(row+i,col+<span class="number">0</span> + j*<span class="number">3</span>,name)</div><div class="line">                worksheet.write(row+i,col+<span class="number">1</span> + j*<span class="number">3</span>,count)</div><div class="line">                worksheet.write(row+i,col+<span class="number">2</span> + j*<span class="number">3</span> ,amount)</div><div class="line">                j +=<span class="number">1</span></div><div class="line">            i += <span class="number">1</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"The data has been write into excel worksheet object successfully!"</span></div><div class="line">    <span class="keyword">except</span> Exception,e:</div><div class="line">        <span class="keyword">print</span> <span class="string">"please check the data's content!"</span></div><div class="line">    <span class="keyword">return</span> None3</div><div class="line">   </div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    file_in = <span class="string">r'test.xlsx'</span></div><div class="line">    title_lists = [<span class="string">u'姓名'</span>,<span class="string">u'数量'</span>,<span class="string">u'金额'</span>] * <span class="number">3</span></div><div class="line">	data = get_data(file_in)</div><div class="line"></div><div class="line">	workbook,worksheet = create_workbook( <span class="string">'out'</span>, <span class="string">'sheet1'</span>)</div><div class="line">	title_formats,cell_formats,_ = format_style(workbook)</div><div class="line">	write_title(worksheet, title_lists, row=<span class="number">1</span>, col=<span class="number">1</span>, title_format=title_formats)</div><div class="line">	write_data(worksheet,data,row=<span class="number">2</span>,col=<span class="number">1</span>, cell_format=cell_formats)</div><div class="line">	workbook.close()</div></pre></td></tr></table></figure>
<hr>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ul>
<li>1.代码重构</li>
<li>2.通用性</li>
</ul>
<h3 id="代码重构"><a href="#代码重构" class="headerlink" title="代码重构"></a>代码重构</h3><h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><p><img src="http://on58f12qv.bkt.clouddn.com/Excel_Temp%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png" alt="代码结构|center"></p>
<p>‘data’ 文件夹存放输入和输出数据文件。<br>‘Excel_Object’ 存放Excel类及实例结构和操作方法。<br>‘main’ 处理数据的主函数。<br>‘transform’ 代码重构前函数式、流水操作式代码。</p>
<h4 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###  Excel_Object.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'MaFuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> xlsxwriter</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Excel_Operator</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, workbook_name, worksheet_name)</span>:</span></div><div class="line">        self.workbook_name = workbook_name</div><div class="line">        self.worksheet_name = worksheet_name</div><div class="line">        self.workbook = xlsxwriter.Workbook(self.workbook_name + <span class="string">".xlsx"</span>)</div><div class="line">        self.worksheet = self.workbook.add_worksheet(self.worksheet_name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">format_style</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self.workbook:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                title_formats = self.workbook.add_format(&#123;<span class="string">'bold'</span>:<span class="keyword">True</span>, <span class="string">'bg_color'</span>:<span class="string">'#B0C4DE'</span>, <span class="string">'font_size'</span>:<span class="number">10</span>, <span class="string">'font_name'</span>:<span class="string">'Microsoft yahei'</span>&#125;)</div><div class="line">                cell_formats = self.workbook.add_format(&#123;<span class="string">'bold'</span>:<span class="keyword">False</span>,<span class="string">'font_size'</span>:<span class="number">10</span>, <span class="string">'font_name'</span>:<span class="string">'Microsoft yahei'</span>&#125;)</div><div class="line">                date_formats = self.workbook.add_format(&#123;<span class="string">'bold'</span>:<span class="keyword">False</span>,<span class="string">'font_size'</span>:<span class="number">10</span>, <span class="string">'font_name'</span>:<span class="string">'Microsoft yahei'</span>, <span class="string">'num_format'</span>: <span class="string">'yyyy-mm-dd'</span>&#125;)</div><div class="line">                <span class="keyword">return</span> title_formats,cell_formats,date_formats</div><div class="line">            <span class="keyword">except</span> Exception,e:</div><div class="line">                <span class="keyword">print</span> <span class="string">"the workbook object is invalid, please check the workbook object."</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"please check and input the correct workbook object!"</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_title</span><span class="params">(self, title_lists, row=<span class="number">0</span>, col=<span class="number">0</span>, title_format=None)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">for</span> i, title <span class="keyword">in</span> enumerate(title_lists):</div><div class="line">                <span class="keyword">if</span> title:</div><div class="line">                    self.worksheet.write(row, col+i, title, title_format)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> e</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"The titles has been write into excel worksheet object successfully!"</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_data</span><span class="params">(self, data, row=<span class="number">0</span>, col=<span class="number">0</span>, cell_format=None)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            i = <span class="number">0</span></div><div class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> data:</div><div class="line">                j = <span class="number">0</span></div><div class="line">                <span class="keyword">for</span> tp <span class="keyword">in</span> line.split(<span class="string">','</span>):</div><div class="line">                    name, count, amount = tp.split()</div><div class="line">                    self.worksheet.write(row+i,col+<span class="number">0</span> + j*<span class="number">3</span>,name, cell_format)</div><div class="line">                    self.worksheet.write(row+i,col+<span class="number">1</span> + j*<span class="number">3</span>,count, cell_format)</div><div class="line">                    self.worksheet.write(row+i,col+<span class="number">2</span> + j*<span class="number">3</span> ,amount, cell_format)</div><div class="line">                    j += <span class="number">1</span></div><div class="line">                i += <span class="number">1</span></div><div class="line">            <span class="keyword">print</span> <span class="string">"The data has been write into excel worksheet object successfully!"</span></div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">"please check the data's content!"</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></div><div class="line">        self.workbook.close()</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### main.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'MaFuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">from</span> Excel_Object <span class="keyword">import</span> Excel_Operator</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(file_in, sheetname=<span class="number">0</span>)</span>:</span></div><div class="line">    df = pd.read_excel(file_in, sheetname)</div><div class="line">    data = []</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> df[df.columns[<span class="number">1</span>]]:</div><div class="line">        data.append(line)</div><div class="line">    <span class="keyword">return</span> data</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(data, title_lists)</span>:</span></div><div class="line">    Excel_obj = Excel_Operator(<span class="string">'./data/out'</span>, <span class="string">'sheet1'</span>)</div><div class="line"></div><div class="line">    title_formats,cell_formats,_ = Excel_obj.format_style()</div><div class="line"></div><div class="line">    Excel_obj.write_title( title_lists, row=<span class="number">1</span>, col=<span class="number">1</span>, title_format=title_formats)</div><div class="line">    Excel_obj.write_data(data,row=<span class="number">2</span>,col=<span class="number">1</span>, cell_format=cell_formats)</div><div class="line">    Excel_obj.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line"></div><div class="line">    title_lists = [<span class="string">u'姓名'</span>,<span class="string">u'数量'</span>,<span class="string">u'金额'</span>] * <span class="number">3</span></div><div class="line">    data = get_data(<span class="string">'./data/test.xlsx'</span>)</div><div class="line"></div><div class="line">    main(data, title_lists)</div></pre></td></tr></table></figure>
<hr>
<h3 id="to-do"><a href="#To-DO" class="headerlink" title="To-DO"></a>To-DO</h3><ul>
<li><ol>
<li>功能代码通用化</li>
</ol>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/05/14/Python项目：IP地址信息可视化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/14/Python项目：IP地址信息可视化/" itemprop="url">
                  Python项目：IP地址信息可视化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-14T21:33:21+08:00">
                2017-05-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h3><p>无论对于任何的互联网企业，“用户”是企业最最核心的资源。因此在用户经营管理的工作中，对“用户”的分析，是不可或缺的一个环节。</p>
<p>分析的角度非常多，其中包括“用户地域分布信息”的分析。针对用户地域信息分布的数据，不仅仅是进行单纯的统计，更是在后续的决策、推广、拓展中起到非常重要的指导作用。</p>
<p>通常，可以通过接入API服务（例如高德、谷歌地图等），或者购买第三方IP查询服务（例如常见的IP查询功能网址），以及当前市面上“纯真IP数据库”，或者使用免费API查询IP信息（通常有使用次数限制）。</p>
<p>现在，我们以“节约成本”为前提，以“数据尽量准确”为目的，通过使用“纯真IP数据库”实现用户IP地址位置信息查询的项目。</p>
<hr>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li>MySQL 5.7 </li>
<li>Python 2.7.10</li>
<li><a href="http://www.cz88.net/" target="_blank" rel="external">纯真IP数据库</a></li>
</ul>
<p>感谢CZ88提供的查询IP服务，并将其开发为一款小巧便捷的插件。我们这个项目的目的是自动化更新IP地址信息。接下来，开始详细项目内容。</p>
<hr>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>结合纯真IP数据库提供的数据信息，以及IP的基础知识，总体的思路就是：首先，将IP地址转化为数字字段，并将其与IP库内的IP地址段进行比较，以初步确定IP地址信息；然后，对IP数据进行数据库的读写操作、更新数据；最后，将IP地址信息进行统计并借助Echart进行可视化。</p>
<hr>
<h4 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h4><p><img src="http://on58f12qv.bkt.clouddn.com/IP_Store%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png" alt="代码结构|center|300*0"></p>
<ol>
<li><p>Data 数据准备<br>“qqwry.dat”  是纯真数据库setup之后在安装目录下的IP库文件，是本项目的核心数据。<br>“ip_data.txt” 是需要处理的IP数据，是本项目的需求数据。<br>“ip_data_address.txt”是更新address信息后的ip_data数据。</p>
</li>
<li><p>Utils 工具准备<br>“mysql.config” 是数据库相关的连接信息。<br>“mysql_utils” 是操作MySQL数据库相关类和方法。<br>“load_ip_data” 是需求数据导入MySQL数据相关的方法。<br>“update_ip_address” 是更新MySQL数据相关的方法。<br>“IP_Locator” 是本项目的核心代码，读取纯真IP库、转换IP数据、查询IP地址信息。<br>“ChinaMap_JS” 是Echart官网Map地图生成相关代码。<br>“china_map_summary” 是处理IP地址信息相关代码。</p>
</li>
<li><p>纯真IP库<br>纯真IP库即“qqwry.dat”是十六进制的内容，其内容结构是：</p>
</li>
</ol>
<ul>
<li>start_ip , end_ip , address_info<br>如下截图所示：<br><img src="http://on58f12qv.bkt.clouddn.com/%E7%BA%AF%E7%9C%9FIP%E5%BA%93.png" alt="纯真IP库内容|center"></li>
</ul>
<hr>
<h4 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">; MySQL数据库配置文件</div><div class="line">[platform_database]</div><div class="line">outer_host = 127.0.0.1</div><div class="line">inner_host = localhost</div><div class="line">user = user</div><div class="line">password = password</div><div class="line">db = database</div><div class="line">charset = utf8</div><div class="line">port = 3308</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"><span class="string">""" MySQL数据库相关的工具包,包含配置信息管理、数据库连接、数据查询、数据更新、数据写入功能.</span></div><div class="line">"""</div><div class="line"><span class="keyword">import</span> MySQLdb</div><div class="line"><span class="keyword">import</span> ConfigParser</div><div class="line"><span class="keyword">import</span> sys,os</div><div class="line"></div><div class="line">__all__ = [<span class="string">'MySQL_Config'</span>, <span class="string">'connect'</span>, <span class="string">'select'</span>, <span class="string">'insert'</span>,<span class="string">'update'</span>]</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQL_Utils</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cfg_path, section)</span>:</span></div><div class="line">		self.cfg_path = cfg_path</div><div class="line">		self.section = section</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">MySQL_Config</span><span class="params">(self)</span>:</span></div><div class="line">		config_info = []</div><div class="line">		conf = ConfigParser.ConfigParser()</div><div class="line">		conf.read(self.cfg_path)</div><div class="line">		options = conf.options(self.section)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> sys.platform.find(<span class="string">"win"</span>) &gt;= <span class="number">0</span>:</div><div class="line">			options.pop(options.index(<span class="string">"inner_host"</span>))</div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			options.pop(options.index(<span class="string">"outer_host"</span>))</div><div class="line"></div><div class="line">		<span class="keyword">for</span> option <span class="keyword">in</span> options:</div><div class="line">			config_info.append(conf.get(self.section, option))</div><div class="line">		<span class="keyword">return</span> config_info</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">(self)</span>:</span></div><div class="line">		host, user, passwd, db, charset, port = self.MySQL_Config()</div><div class="line">		self.conn = MySQLdb.connect(host=host, user=user, passwd=passwd,</div><div class="line">		                                db=db, charset=charset, port=int(port))</div><div class="line">		self.cur = self.conn.cursor()</div><div class="line">		<span class="keyword">return</span> self.conn, self.cur</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">select</span><span class="params">(self, select_sql)</span>:</span></div><div class="line">		<span class="keyword">if</span> select_sql:</div><div class="line">			conn, cur = self.connect()</div><div class="line">			<span class="keyword">try</span>:</div><div class="line">				cur.execute(select_sql)</div><div class="line">				data = cur.fetchall()</div><div class="line">				conn.close()</div><div class="line">				<span class="keyword">return</span> data</div><div class="line">			<span class="keyword">except</span> Exception,e:</div><div class="line">				<span class="keyword">print</span> e</div><div class="line">				<span class="keyword">return</span> (<span class="string">''</span>,)</div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			<span class="keyword">print</span> <span class="string">"Please input the correct select_sql!"</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, insert_sql)</span>:</span></div><div class="line">		<span class="keyword">if</span> insert_sql:</div><div class="line">			conn, cur = self.connect()</div><div class="line">			<span class="keyword">try</span>:</div><div class="line">				cur.execute(insert_sql)</div><div class="line">				conn.commit()</div><div class="line">				conn.close()</div><div class="line">				<span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">			<span class="keyword">except</span> Exception,e:</div><div class="line">				conn.rollback()</div><div class="line">				conn.close()</div><div class="line">				<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			<span class="keyword">print</span> <span class="string">"Please input the correct insert_sql!"</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self,update_sql)</span>:</span></div><div class="line">		<span class="keyword">if</span> update_sql:</div><div class="line">			conn, cur = self.connect()</div><div class="line">			<span class="keyword">try</span>:</div><div class="line">				cur.execute(update_sql)</div><div class="line">				conn.commit()</div><div class="line">				conn.close()</div><div class="line">				<span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">			<span class="keyword">except</span> Exception,e:</div><div class="line">				conn.rollback()</div><div class="line">				conn.close()</div><div class="line">				<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			<span class="keyword">print</span> <span class="string">"Please input the correct update_sql!"</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line"></div><div class="line">	cfg_path = os.path.dirname(os.path.abspath(__file__)) + os.path.sep + <span class="string">'mysql.config'</span></div><div class="line">	section = <span class="string">'platform_database'</span></div><div class="line"></div><div class="line">	cfg = MySQL_Utils(cfg_path, section)</div><div class="line">	<span class="keyword">print</span> cfg.connect()</div><div class="line">	cfg.insert(<span class="string">"insert into customers_ip_info(ip) values ('111.200.54.38');"</span>)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### load_ip_data.py </span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"><span class="string">""" 将ip_data.txt数据入库到Database的customers_ip_info.</span></div><div class="line">"""</div><div class="line"><span class="keyword">from</span> IP_Store.utils.mysql_utils <span class="keyword">import</span> MySQL_Utils</div><div class="line"><span class="keyword">import</span> codecs,os,time</div><div class="line"></div><div class="line">CFG_PATH = os.path.dirname(os.path.abspath(__file__)) + os.path.sep + <span class="string">'mysql.config'</span></div><div class="line">SECTION = <span class="string">'platform_database'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mysql_instance</span><span class="params">(cfg_path, section)</span>:</span></div><div class="line">	cfg = MySQL_Utils(cfg_path, section)</div><div class="line">	<span class="keyword">return</span> cfg</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql_insert</span><span class="params">(table, ip)</span>:</span></div><div class="line">	<span class="keyword">if</span> table <span class="keyword">and</span> ip:</div><div class="line">		sql = <span class="string">'''INSERT INTO &#123;0&#125;(ip) VALUES ('&#123;1&#125;'); '''</span>.format(table, ip)</div><div class="line">	<span class="keyword">else</span>:</div><div class="line">		<span class="keyword">pass</span></div><div class="line">	<span class="keyword">return</span> sql</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	time_start = time.time()</div><div class="line"></div><div class="line">	cfg = mysql_instance(CFG_PATH, SECTION)</div><div class="line"></div><div class="line">	<span class="keyword">with</span> codecs.open(<span class="string">'../data/ip_data.txt'</span>, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">		<span class="keyword">for</span> line <span class="keyword">in</span> file:</div><div class="line">			id, ip = line.strip().split(<span class="string">'\t'</span>)</div><div class="line">			insert_sql = sql_insert(<span class="string">'customers_ip_info'</span>, ip)</div><div class="line">			cfg.insert(insert_sql)</div><div class="line"></div><div class="line">	time_end = time.time()</div><div class="line">	<span class="keyword">print</span> <span class="string">"The process has been completed! It takes &#123;0:.4&#125; seconds!"</span>.format(time_end - time_start)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### update_ip_address.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"><span class="string">""" 更新数据库内ip所对应的地址信息address.</span></div><div class="line">"""</div><div class="line"><span class="keyword">from</span> IP_Store.utils.mysql_utils <span class="keyword">import</span> MySQL_Utils</div><div class="line"><span class="keyword">import</span> codecs,os,time</div><div class="line"><span class="keyword">from</span> IP_Store.IP_Locator <span class="keyword">import</span> IPLocator</div><div class="line"></div><div class="line"></div><div class="line">CFG_PATH = os.path.dirname(os.path.abspath(__file__)) + os.path.sep + <span class="string">'mysql.config'</span></div><div class="line">SECTION = <span class="string">'platform_database'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mysql_instance</span><span class="params">(cfg_path, section)</span>:</span></div><div class="line">	cfg = MySQL_Utils(cfg_path, section)</div><div class="line">	<span class="keyword">return</span> cfg</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sql</span><span class="params">(table, ip, address)</span>:</span></div><div class="line">	<span class="keyword">if</span> table <span class="keyword">and</span> ip:</div><div class="line">		sql = <span class="string">'''UPDATE &#123;0&#125; SET address='&#123;1&#125;' WHERE ip='&#123;2&#125;'; '''</span>.format(table, address, ip)</div><div class="line">		<span class="keyword">print</span> sql</div><div class="line">	<span class="keyword">else</span>:</div><div class="line">		<span class="keyword">pass</span></div><div class="line">	<span class="keyword">return</span> sql</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	TABLE = <span class="string">'customers_ip_info'</span></div><div class="line">	time_start = time.time()</div><div class="line"></div><div class="line">	cfg = mysql_instance(CFG_PATH, SECTION)</div><div class="line">	IPL = IPLocator( <span class="string">r"D:/Pycharm/Git_Project/IP_Store/data/qqwry.dat"</span> )</div><div class="line"></div><div class="line">	sql_select = <span class="string">'''SELECT ip FROM &#123;0&#125; WHERE address IS  NULL '''</span>.format(TABLE)</div><div class="line">	<span class="keyword">for</span> ip <span class="keyword">in</span> cfg.select(sql_select):</div><div class="line">		ip = ip[<span class="number">0</span>]</div><div class="line">		address = IPL.getIpAddr(IPL.str2ip(ip))</div><div class="line">		sql_update = sql(TABLE, ip, address)</div><div class="line">		cfg.update(sql_update)</div><div class="line"></div><div class="line">	time_end = time.time()</div><div class="line">	<span class="keyword">print</span> <span class="string">"The process has been completed! It takes &#123;0:.4&#125; seconds!"</span>.format(time_end - time_start)</div></pre></td></tr></table></figure>
<hr>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### IP_Locator, 代码来源网络，有很多版本，选择较为清晰的版本  </span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="string">""" IP_Locator: query the IP location in the QQWry.dat</span></div><div class="line">"""</div><div class="line"><span class="keyword">import</span> socket,string,struct,sys</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IPLocator</span> :</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">( self, ipdbFile )</span>:</span></div><div class="line">        self.ipdb = open( ipdbFile, <span class="string">"rb"</span> )</div><div class="line">        str = self.ipdb.read( <span class="number">8</span> )</div><div class="line">        (self.firstIndex,self.lastIndex) = struct.unpack(<span class="string">'II'</span>,str)</div><div class="line">        self.indexCount = (self.lastIndex - self.firstIndex)/<span class="number">7</span>+<span class="number">1</span></div><div class="line">        <span class="keyword">print</span> self.getVersion(),<span class="string">" 纪录总数: %d 条 "</span>%(self.indexCount)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getVersion</span><span class="params">(self)</span>:</span></div><div class="line">        s = self.getIpAddr(<span class="number">0xffffff00L</span>)</div><div class="line">        <span class="keyword">return</span> s</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAreaAddr</span><span class="params">(self,offset=<span class="number">0</span>)</span>:</span></div><div class="line">        <span class="keyword">if</span> offset :</div><div class="line">            self.ipdb.seek( offset )</div><div class="line">        str = self.ipdb.read( <span class="number">1</span> )</div><div class="line">        (byte,) = struct.unpack(<span class="string">'B'</span>,str)</div><div class="line">        <span class="keyword">if</span> byte == <span class="number">0x01</span> <span class="keyword">or</span> byte == <span class="number">0x02</span>:</div><div class="line">            p = self.getLong3()</div><div class="line">            <span class="keyword">if</span> p:</div><div class="line">                <span class="keyword">return</span> self.getString( p )</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">return</span> <span class="string">""</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.ipdb.seek(<span class="number">-1</span>,<span class="number">1</span>)</div><div class="line">            <span class="keyword">return</span> self.getString( offset )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAddr</span><span class="params">(self,offset,ip=<span class="number">0</span>)</span>:</span></div><div class="line">        self.ipdb.seek( offset + <span class="number">4</span>)</div><div class="line">        countryAddr = <span class="string">""</span></div><div class="line">        areaAddr = <span class="string">""</span></div><div class="line">        str = self.ipdb.read( <span class="number">1</span> )</div><div class="line">        (byte,) = struct.unpack(<span class="string">'B'</span>,str)</div><div class="line">        <span class="keyword">if</span> byte == <span class="number">0x01</span>:</div><div class="line">            countryOffset = self.getLong3()</div><div class="line">            self.ipdb.seek( countryOffset )</div><div class="line">            str = self.ipdb.read( <span class="number">1</span> )</div><div class="line">            (b,) = struct.unpack(<span class="string">'B'</span>,str)</div><div class="line">            <span class="keyword">if</span> b == <span class="number">0x02</span>:</div><div class="line">                countryAddr = self.getString( self.getLong3() )</div><div class="line">                self.ipdb.seek( countryOffset + <span class="number">4</span> )</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                countryAddr = self.getString( countryOffset )</div><div class="line">            areaAddr = self.getAreaAddr()</div><div class="line">        <span class="keyword">elif</span> byte == <span class="number">0x02</span>:</div><div class="line">            countryAddr = self.getString( self.getLong3() )</div><div class="line">            areaAddr = self.getAreaAddr( offset + <span class="number">8</span> )</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            countryAddr = self.getString( offset + <span class="number">4</span> )</div><div class="line">            areaAddr = self.getAreaAddr()</div><div class="line">        <span class="keyword">return</span> countryAddr + <span class="string">" "</span> + areaAddr</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(self, first ,last )</span>:</span></div><div class="line">        <span class="keyword">if</span> last &gt; self.indexCount :</div><div class="line">            last = self.indexCount</div><div class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> range(first,last):</div><div class="line">            offset = self.firstIndex + index * <span class="number">7</span></div><div class="line">            self.ipdb.seek( offset )</div><div class="line">            buf = self.ipdb.read( <span class="number">7</span> )</div><div class="line">            (ip,of1,of2) = struct.unpack(<span class="string">"IHB"</span>,buf)</div><div class="line">            address = self.getAddr( of1 + (of2 &lt;&lt; <span class="number">16</span>) )</div><div class="line">            <span class="comment">#把GBK转为utf-8</span></div><div class="line">            address = unicode(address,<span class="string">'gbk'</span>).encode(<span class="string">"utf-8"</span>)</div><div class="line">            <span class="keyword">print</span> <span class="string">"%d\t%s\t%s"</span> %(index, self.ip2str(ip), \</div><div class="line">                address )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setIpRange</span><span class="params">(self,index)</span>:</span></div><div class="line">        offset = self.firstIndex + index * <span class="number">7</span></div><div class="line">        self.ipdb.seek( offset )</div><div class="line">        buf = self.ipdb.read( <span class="number">7</span> )</div><div class="line">        (self.curStartIp,of1,of2) = struct.unpack(<span class="string">"IHB"</span>,buf)</div><div class="line">        self.curEndIpOffset = of1 + (of2 &lt;&lt; <span class="number">16</span>)</div><div class="line">        self.ipdb.seek( self.curEndIpOffset )</div><div class="line">        buf = self.ipdb.read( <span class="number">4</span> )</div><div class="line">        (self.curEndIp,) = struct.unpack(<span class="string">"I"</span>,buf)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getIpAddr</span><span class="params">(self,ip)</span>:</span></div><div class="line">        L = <span class="number">0</span></div><div class="line">        R = self.indexCount - <span class="number">1</span></div><div class="line">        <span class="keyword">while</span> L &lt; R<span class="number">-1</span>:</div><div class="line">            M = (L + R) / <span class="number">2</span></div><div class="line">            self.setIpRange(M)</div><div class="line">            <span class="keyword">if</span> ip == self.curStartIp:</div><div class="line">                L = M</div><div class="line">                <span class="keyword">break</span></div><div class="line">            <span class="keyword">if</span> ip &gt; self.curStartIp:</div><div class="line">                L = M</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                R = M</div><div class="line">        self.setIpRange( L )</div><div class="line">        <span class="comment">#version information,255.255.255.X,urgy but useful</span></div><div class="line">        <span class="keyword">if</span> ip&amp;<span class="number">0xffffff00L</span> == <span class="number">0xffffff00L</span>:</div><div class="line">            self.setIpRange( R )</div><div class="line">        <span class="keyword">if</span> self.curStartIp &lt;= ip &lt;= self.curEndIp:</div><div class="line">            address = self.getAddr( self.curEndIpOffset )</div><div class="line">            <span class="comment">#把GBK转为utf-8</span></div><div class="line">            address = unicode(address,<span class="string">'gbk'</span>).encode(<span class="string">"utf-8"</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            address = <span class="string">"未找到该IP的地址"</span></div><div class="line">        <span class="keyword">return</span> address</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getIpRange</span><span class="params">(self,ip)</span>:</span></div><div class="line">        self.getIpAddr(ip)</div><div class="line">        range = self.ip2str(self.curStartIp) + <span class="string">' - '</span> \</div><div class="line">            + self.ip2str(self.curEndIp)</div><div class="line">        <span class="keyword">return</span> range</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getString</span><span class="params">(self,offset = <span class="number">0</span>)</span>:</span></div><div class="line">        <span class="keyword">if</span> offset :</div><div class="line">            self.ipdb.seek( offset )</div><div class="line">        str = <span class="string">""</span></div><div class="line">        ch = self.ipdb.read( <span class="number">1</span> )</div><div class="line">        (byte,) = struct.unpack(<span class="string">'B'</span>,ch)</div><div class="line">        <span class="keyword">while</span> byte != <span class="number">0</span>:</div><div class="line">            str = str + ch</div><div class="line">            ch = self.ipdb.read( <span class="number">1</span> )</div><div class="line">            (byte,) = struct.unpack(<span class="string">'B'</span>,ch)</div><div class="line">        <span class="keyword">return</span> str</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ip2str</span><span class="params">(self,ip)</span>:</span></div><div class="line">        <span class="keyword">return</span> str(ip&gt;&gt;<span class="number">24</span>)+<span class="string">'.'</span>+str((ip&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffL</span>)+<span class="string">'.'</span> \</div><div class="line">            +str((ip&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffL</span>)+<span class="string">'.'</span>+str(ip&amp;<span class="number">0xffL</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">str2ip</span><span class="params">(self,s)</span>:</span></div><div class="line">        (ip,) = struct.unpack(<span class="string">'I'</span>,socket.inet_aton(s))</div><div class="line">        <span class="keyword">return</span> ((ip&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xffL</span>)|((ip&amp;<span class="number">0xffL</span>)&lt;&lt;<span class="number">24</span>) \</div><div class="line">            |((ip&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff00L</span>)|((ip&amp;<span class="number">0xff00L</span>)&lt;&lt;<span class="number">8</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getLong3</span><span class="params">(self,offset = <span class="number">0</span>)</span>:</span></div><div class="line">        <span class="keyword">if</span> offset :</div><div class="line">            self.ipdb.seek( offset )</div><div class="line">        str = self.ipdb.read(<span class="number">3</span>)</div><div class="line">        (a,b) = struct.unpack(<span class="string">'HB'</span>,str)</div><div class="line">        <span class="keyword">return</span> (b &lt;&lt; <span class="number">16</span>) + a</div><div class="line"><span class="comment">#Demo</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    IPL = IPLocator( <span class="string">r"D:/Pycharm/Git_Project/IP_Store/data/qqwry.dat"</span> )</div><div class="line">    ip = <span class="string">""</span></div><div class="line">    <span class="comment"># if len(sys.argv) != 2:</span></div><div class="line">    <span class="comment">#     print 'Usage: python IPLocator.py &lt;IP&gt;'</span></div><div class="line">    <span class="comment">#     return</span></div><div class="line">    <span class="comment"># else:</span></div><div class="line">    <span class="comment">#     ip = sys.argv[1]</span></div><div class="line">    ip = <span class="string">"106.120.5.48"</span></div><div class="line">    address = IPL.getIpAddr( IPL.str2ip(ip) )</div><div class="line">    range = IPL.getIpRange( IPL.str2ip(ip) )</div><div class="line">    <span class="keyword">print</span> <span class="string">"此IP %s 属于 %s\n所在网段: %s"</span> % (ip,address, range)</div><div class="line">    <span class="keyword">print</span> address</div><div class="line">    <span class="keyword">print</span> range</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span> :</div><div class="line">    main()</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### ChinaMap_JS.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'Fujia'</span></div><div class="line"><span class="string">""" http://echarts.baidu.com/demo.html#map-china-dataRange</span></div><div class="line">"""</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChinaMap</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">	CONTENT_Start = <span class="string">'''option = &#123;</span></div><div class="line">    title: &#123;</div><div class="line">        text: '平台注册用户分布',</div><div class="line">        subtext: '',</div><div class="line">        left: 'left'</div><div class="line">    &#125;,</div><div class="line">    tooltip: &#123;</div><div class="line">        trigger: 'item',</div><div class="line">        formatter: '&#123;b&#125;'</div><div class="line">    &#125;,</div><div class="line">    visualMap: &#123;</div><div class="line">        seriesIndex: 0,</div><div class="line">        min: 0,</div><div class="line">        max: 15000,</div><div class="line">        left: 'left',</div><div class="line">        top: 'bottom',</div><div class="line">        text: ['高','低'],           // 文本，默认为数值文本</div><div class="line">        calculable: true</div><div class="line">    &#125;,</div><div class="line">    grid: &#123;</div><div class="line">        height: 200,</div><div class="line">        width: 8,</div><div class="line">        right: 80,</div><div class="line">        bottom: 10</div><div class="line">    &#125;,</div><div class="line">    xAxis: &#123;</div><div class="line">        type: 'category',</div><div class="line">        data: [],</div><div class="line">        splitNumber: 1,</div><div class="line">        show: true</div><div class="line">    &#125;,</div><div class="line">    yAxis: &#123;</div><div class="line">        position: 'right',</div><div class="line">        min: 0,</div><div class="line">        max: 20,</div><div class="line">        splitNumber: 20,</div><div class="line">        inverse: true,</div><div class="line">        axisLabel: &#123;</div><div class="line">            show: true</div><div class="line">        &#125;,</div><div class="line">        axisLine: &#123;</div><div class="line">            show: true</div><div class="line">        &#125;,</div><div class="line">        splitLine: &#123;</div><div class="line">            show: false</div><div class="line">        &#125;,</div><div class="line">        axisTick: &#123;</div><div class="line">            show: true</div><div class="line">        &#125;,</div><div class="line">        data: []</div><div class="line">    &#125;,</div><div class="line">    series: [</div><div class="line">        &#123;</div><div class="line">            zlevel: 1,</div><div class="line">            name: '中国',</div><div class="line">            type: 'map',</div><div class="line">            mapType: 'china',</div><div class="line">            selectedMode : 'multiple',</div><div class="line">            roam: true,</div><div class="line">            left: 0,</div><div class="line">            right: '15%',</div><div class="line">            label: &#123;</div><div class="line">                normal: &#123;</div><div class="line">                    show: true</div><div class="line">                &#125;,</div><div class="line">                emphasis: &#123;</div><div class="line">                    show: true</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            data:[ '''</div><div class="line"></div><div class="line">	CONTENT_End = <span class="string">''']</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            zlevel: 2,</div><div class="line">            name: '地图指示',</div><div class="line">            type: 'bar',</div><div class="line">            barWidth: 5,</div><div class="line">            itemStyle: &#123;</div><div class="line">                normal: &#123;</div><div class="line">                    color: undefined,</div><div class="line">                    shadowColor: 'rgba(0, 0, 0, 0.1)',</div><div class="line">                    shadowBlur: 10</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            data: [20]</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> * 根据值获取线性渐变颜色</div><div class="line"> * @param  &#123;String&#125; start 起始颜色</div><div class="line"> * @param  &#123;String&#125; end   结束颜色</div><div class="line"> * @param  &#123;Number&#125; max   最多分成多少分</div><div class="line"> * @param  &#123;Number&#125; val   渐变取值</div><div class="line"> * @return &#123;String&#125;       颜色</div><div class="line"> */</div><div class="line">function getGradientColor (start, end, max, val) &#123;</div><div class="line">    var rgb = /#((?:[0-9]|[a-fA-F])&#123;2&#125;)((?:[0-9]|[a-fA-F])&#123;2&#125;)((?:[0-9]|[a-fA-F])&#123;2&#125;)/;</div><div class="line">    var sM = start.match(rgb);</div><div class="line">    var eM = end.match(rgb);</div><div class="line">    var err = '';</div><div class="line">    max = max || 1</div><div class="line">    val = val || 0</div><div class="line">    if (sM === null) &#123;</div><div class="line">        err = 'start';</div><div class="line">    &#125;</div><div class="line">    if (eM === null) &#123;</div><div class="line">        err = 'end';</div><div class="line">    &#125;</div><div class="line">    if (err.length &gt; 0) &#123;</div><div class="line">        throw new Error('Invalid ' + err + ' color format, required hex color');</div><div class="line">    &#125;</div><div class="line">    var sR = parseInt(sM[1], 16),</div><div class="line">        sG = parseInt(sM[2], 16),</div><div class="line">        sB = parseInt(sM[3], 16);</div><div class="line">    var eR = parseInt(eM[1], 16),</div><div class="line">        eG = parseInt(eM[2], 16),</div><div class="line">        eB = parseInt(eM[3], 16);</div><div class="line">    var p = val / max;</div><div class="line">    var gR = Math.round(sR + (eR - sR) * p).toString(16),</div><div class="line">        gG = Math.round(sG + (eG - sG) * p).toString(16),</div><div class="line">        gB = Math.round(sB + (eB - sB) * p).toString(16);</div><div class="line">    return '#' + gR + gG + gB;</div><div class="line">&#125;</div><div class="line"></div><div class="line">setTimeout(function() &#123;</div><div class="line">    var TOPN = 25</div><div class="line"></div><div class="line">    var option = myChart.getOption()</div><div class="line">    // 修改top</div><div class="line">    option.grid[0].height = TOPN * 20</div><div class="line">    option.yAxis[0].max = TOPN</div><div class="line">    option.yAxis[0].splitNumber = TOPN</div><div class="line">    option.series[1].data[0] = TOPN</div><div class="line">    // 排序</div><div class="line">    var data = option.series[0].data.sort(function(a, b) &#123;</div><div class="line">        return b.value - a.value</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    var maxValue = data[0].value,</div><div class="line">        minValue = data.length &gt; TOPN ? data[TOPN - 1].value : data[data.length - 1].value</div><div class="line"></div><div class="line">    var s = option.visualMap[0].controller.inRange.color[0],</div><div class="line">        e = option.visualMap[0].controller.inRange.color.slice(-1)[0]</div><div class="line">    var sColor = getGradientColor(s, e, maxValue, minValue)</div><div class="line">    var eColor = getGradientColor(s, e, maxValue, maxValue)</div><div class="line"></div><div class="line">    option.series[1].itemStyle.normal.color = new echarts.graphic.LinearGradient(0, 0, 0, 1, [&#123;</div><div class="line">        offset: 1,</div><div class="line">        color: sColor</div><div class="line">    &#125;, &#123;</div><div class="line">        offset: 0,</div><div class="line">        color: eColor</div><div class="line">    &#125;])</div><div class="line"></div><div class="line">    // yAxis</div><div class="line">    var newYAxisArr = []</div><div class="line">    echarts.util.each(data, function(item, i) &#123;</div><div class="line">        if (i &gt;= TOPN) &#123;</div><div class="line">            return false</div><div class="line">        &#125;</div><div class="line">        var c = getGradientColor(sColor, eColor, maxValue, item.value)</div><div class="line">        newYAxisArr.push(&#123;</div><div class="line">            value: item.name,</div><div class="line">            textStyle: &#123;</div><div class="line">                color: c</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line">    option.yAxis[0].data = newYAxisArr</div><div class="line">    option.yAxis[0].axisLabel.formatter = (function(data) &#123;</div><div class="line">        return function(value, i) &#123;</div><div class="line">            if (!value) return ''</div><div class="line">            return value + ' ' + data[i].value</div><div class="line">        &#125;</div><div class="line">    &#125;)(data)</div><div class="line">    myChart.setOption(option)</div><div class="line">&#125;, 0);</div><div class="line"></div><div class="line">'''</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	JS_Scripts = ChinaMap()</div><div class="line">	summary_string = <span class="string">'''</span></div><div class="line">		&#123;name:'安徽',value:2712&#125;,</div><div class="line">		&#123;name:'澳门',value:21&#125;,</div><div class="line">		&#123;name:'北京',value:5351&#125;,</div><div class="line">		&#123;name:'福建',value:3494&#125;,</div><div class="line">		&#123;name:'甘肃',value:697&#125;,</div><div class="line">		&#123;name:'广东',value:13418&#125;,</div><div class="line">		&#123;name:'广西',value:2072&#125;,</div><div class="line">		&#123;name:'贵州',value:1067&#125;,</div><div class="line">		&#123;name:'海南',value:376&#125;,</div><div class="line">		&#123;name:'河北',value:3318&#125;,</div><div class="line">		&#123;name:'河南',value:5552&#125;,</div><div class="line">		&#123;name:'黑龙江',value:1117&#125;,</div><div class="line">		&#123;name:'湖北',value:3286&#125;,</div><div class="line">		&#123;name:'湖南',value:2885&#125;,</div><div class="line">		&#123;name:'吉林',value:873&#125;,</div><div class="line">		&#123;name:'江苏',value:5330&#125;,</div><div class="line">		&#123;name:'江西',value:2255&#125;,</div><div class="line">		&#123;name:'辽宁',value:1718&#125;,</div><div class="line">		&#123;name:'内蒙古',value:739&#125;,</div><div class="line">		&#123;name:'宁夏',value:217&#125;,</div><div class="line">		&#123;name:'青海',value:105&#125;,</div><div class="line">		&#123;name:'山东',value:5476&#125;,</div><div class="line">		&#123;name:'山西',value:1756&#125;,</div><div class="line">		&#123;name:'陕西',value:2033&#125;,</div><div class="line">		&#123;name:'上海',value:3173&#125;,</div><div class="line">		&#123;name:'四川',value:4121&#125;,</div><div class="line">		&#123;name:'台湾',value:94&#125;,</div><div class="line">		&#123;name:'天津',value:945&#125;,</div><div class="line">		&#123;name:'西藏',value:43&#125;,</div><div class="line">		&#123;name:'香港',value:122&#125;,</div><div class="line">		&#123;name:'新疆',value:575&#125;,</div><div class="line">		&#123;name:'云南',value:1045&#125;,</div><div class="line">		&#123;name:'浙江',value:5311&#125;,</div><div class="line">		&#123;name:'重庆',value:1744&#125;</div><div class="line">	'''</div><div class="line">	JS_CODE = JS_Scripts.CONTENT_Start + summary_string.encode(<span class="string">'utf-8'</span>) + JS_Scripts.CONTENT_End</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### china_map_summary.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'Fujia'</span></div><div class="line"></div><div class="line"><span class="string">""" 统计IP地址信息,绘制China Map分布图.</span></div><div class="line">link : http://echarts.baidu.com/demo.html#map-china-dataRange</div><div class="line">"""</div><div class="line"></div><div class="line"><span class="keyword">import</span> time,os</div><div class="line"><span class="keyword">from</span> IP_Store.utils.mysql_utils <span class="keyword">import</span> MySQL_Utils</div><div class="line"><span class="keyword">from</span> IP_Store.ChinaMap_JS <span class="keyword">import</span> ChinaMap</div><div class="line"></div><div class="line">CFG_PATH = os.path.dirname(os.path.abspath(__file__)) + os.path.sep + <span class="string">'utils/mysql.config'</span></div><div class="line">SECTION = <span class="string">'platform_database'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mysql_instance</span><span class="params">(cfg_path, section)</span>:</span></div><div class="line">	cfg = MySQL_Utils(cfg_path, section)</div><div class="line">	<span class="keyword">return</span> cfg</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">()</span>:</span></div><div class="line">	cfg = mysql_instance(CFG_PATH, SECTION)</div><div class="line">	sql_select = <span class="string">'''SELECT left(address,2),count(*)</span></div><div class="line">					FROM &#123;0&#125;</div><div class="line">					WHERE address IS NOT NULL</div><div class="line">					AND LEFT(address,2) REGEXP '(北京)|(天津)|(上海)|(重庆)|(河北)|(河南)|(云南)|(辽宁)|(黑龙)|(湖南)|(安徽)|(山东)|(新疆)|(江苏)|(浙江)|(江西)|(湖北)|(广西)|(甘肃)|(山西)|(内蒙)|(陕西)|(吉林)|(福建)|(贵州)|(广东)|(青海)|(西藏)|(四川)|(宁夏)|(海南)|(台湾)|(香港)|(澳门)'</div><div class="line">					GROUP BY LEFT(address,2) '''.format(TABLE)</div><div class="line">	<span class="keyword">return</span> cfg.select(sql_select)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	TABLE = <span class="string">'customers_ip_info'</span></div><div class="line">	time_start = time.time()</div><div class="line"></div><div class="line">	summary_string = <span class="string">'\n'</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> line <span class="keyword">in</span> data():</div><div class="line">		province, count = line</div><div class="line">		<span class="keyword">if</span> province == <span class="string">u'黑龙'</span>:</div><div class="line">			summary_string += <span class="string">"&#123;name:'"</span> + <span class="string">u"黑龙江"</span> +<span class="string">"',value:"</span> + str(count) + <span class="string">"&#125;,\n"</span></div><div class="line">		<span class="keyword">elif</span> province == <span class="string">u'内蒙'</span>:</div><div class="line">			summary_string += <span class="string">"&#123;name:'"</span> + <span class="string">u"内蒙古"</span> +<span class="string">"',value:"</span> + str(count) + <span class="string">"&#125;,\n"</span></div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			summary_string += <span class="string">"&#123;name:'"</span> + province +<span class="string">"',value:"</span> + str(count) + <span class="string">"&#125;,\n"</span></div><div class="line"></div><div class="line">	JS_Scripts = ChinaMap()</div><div class="line">	JS_CODE = JS_Scripts.CONTENT_Start + summary_string.encode(<span class="string">'utf-8'</span>) + JS_Scripts.CONTENT_End</div><div class="line"></div><div class="line">	<span class="keyword">print</span> JS_CODE</div></pre></td></tr></table></figure>
<hr>
<h4 id="数据可视化"><a href="#数据可视化" class="headerlink" title="数据可视化"></a>数据可视化</h4><p>将“JS_CODE”结果直接粘贴到<a href="http://echarts.baidu.com/demo.html#map-china-dataRange" target="_blank" rel="external">Echart ChinaMap</a>中生成可视化图像即可。 可视化效果如</p>
<p><img src="http://on58f12qv.bkt.clouddn.com/%E5%9C%B0%E5%9B%BE%E5%88%86%E5%B8%83%E5%8F%AF%E8%A7%86%E5%8C%96.png" alt="注册地图可视化"></p>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ul>
<li><ol>
<li>代码重构，减少冗余</li>
</ol>
</li>
<li><ol>
<li>数据库连接池，提高读写数据库效率</li>
</ol>
</li>
<li><ol>
<li>地图可视化自动化，或嵌入网页微框架</li>
</ol>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/04/27/《Python算法教程》读书笔记-（四）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/27/《Python算法教程》读书笔记-（四）/" itemprop="url">
                  《Python算法教程》读书笔记 - （四）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-27T22:26:51+08:00">
                2017-04-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="树的概念"><a href="#树的概念" class="headerlink" title="树的概念"></a>树的概念</h3><p>树，本身就是图的一种特殊情况。树在算法中扮演着及其重要的角色，并且有许多特定问题是推荐用树结构来解决。大部分树算法都可以被理解成一般图概念中的思路，但特定的树结构会使得它们更容易实现。</p>
<p>最容易表示的就是带根的树结构，这种树的每条边都从根出发，并向下延伸。此类结构所代表的往往是某个数据集所拥有的层次结构，其根节点代表着全部对象，而其内部各节点所代表的对象都是以该节点为根的树结构的叶节点。</p>
<p>示例如下图：</p>
<p>可以将该树表示成一个二维列表(lists of lists)，代码如下所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>T = [[<span class="string">'a'</span>, <span class="string">'b'</span>], [<span class="string">'c'</span>], [<span class="string">'d'</span>, [<span class="string">'e'</span>, <span class="string">'f'</span>]]]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>T[<span class="number">0</span>][<span class="number">1</span>]</div><div class="line">&gt; b</div><div class="line"></div><div class="line"><span class="comment"># 访问的一次是根节点的第三个子节点,然后是该子节点的第二个子节点,最后是这个子节点的第一个子节点，即页节点</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>T[<span class="number">2</span>][<span class="number">1</span>][<span class="number">0</span>]</div><div class="line">&gt; <span class="string">'e'</span></div></pre></td></tr></table></figure></p>
<p>这种方法中，每个列表表示的都是相应内部（匿名）节点所拥有的一个包含其所有相邻节点的列表。</p>
<hr>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>有时实现知道其内部所能拥有的最大子节点数(如二叉树，各节点最多只能拥有两个子节点)，所以可以选择其他表示法，如为各对象的各子节点设置相应的属性。还可以用None值来表示不存在的子节点。如下代码所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 二叉树类</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tree</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,left,right)</span>:</span></div><div class="line">		self.left = left</div><div class="line">		self.right = right</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t = Tree(Tree(<span class="string">"a"</span>,<span class="string">"b"</span>),Tree(<span class="string">"c"</span>,<span class="string">"d"</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.right.left</div><div class="line">&gt; <span class="string">"c"</span></div></pre></td></tr></table></figure></p>
<p>对于没有内置list类型的语言，还有一种常见的树实现方式，即采取“先子节点，后兄弟节点”的表示方法。在这种表示法里，每一个树节点都有两个用于引用其他节点的“指针”或属性，这似乎与二叉树的情况很类似。然而在这里，<strong>!第一个引用指向的是当前节点的第一个子节点!</strong>，而<strong>!第二个引用所指向的则是下一个兄弟节点!</strong>。换句话说，这里的各个节点所对应用的是一个其子节点的兄弟节点链表，并且这些兄弟节点又各自引用了属于他们自己的那个兄弟节点链表。如下代码所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 多路搜索树类</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tree</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,kids,next=None)</span>:</span></div><div class="line">		self.kids = self.val = kids</div><div class="line">		self.next = next</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t = Tree(Tree(<span class="string">"d"</span>,Tree(<span class="string">"b"</span>,Tree(<span class="string">"c"</span>,Tree(<span class="string">"d"</span>)))))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.kids.next.next.val</div><div class="line">&gt; <span class="string">"c"</span></div></pre></td></tr></table></figure></p>
<p><strong>小插曲：Bunch模式</strong></p>
<blockquote>
<p>“Bunch设计模式”，基本上其实现方式中都会具备以下要素：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bunch</span><span class="params">(dict)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,*args,**kwds)</span>:</span></div><div class="line">		super(Bunch, self).__init__(*args,**kwds)</div><div class="line">		self.__dict__ = self</div></pre></td></tr></table></figure></p>
</blockquote>
<p>该模式主要有几个有用的方面.首先，它能让我们以命令行参数的形式创建相关对象，并设置任何属性：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>x = Bunch(name=<span class="string">"Jayne Cobb"</span>,position=<span class="string">"Public Relations"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>x.name</div><div class="line">&gt; <span class="string">"Jayne Cobb"</span></div><div class="line"><span class="comment"># x的结果</span></div><div class="line">&#123;<span class="string">'name'</span>: <span class="string">'Jayne Cobb'</span>, <span class="string">'position'</span>: <span class="string">'Public Relations'</span>&#125;</div></pre></td></tr></table></figure></p>
<p>其次，由于它继承自dict类，可以自然而然地获得大量相关的操作。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>T = Bunch</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t = T(left=T(left=<span class="string">"a"</span>,right=<span class="string">"b"</span>),right=T(left=<span class="string">"c"</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.left.right</div><div class="line">&gt; <span class="string">"b"</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t[<span class="string">'left'</span>][<span class="string">'right'</span>]</div><div class="line">&gt; <span class="string">"b"</span></div></pre></td></tr></table></figure></p>
<p>注：Bunch设计模式直观的感受是递归调用，但是没有理解，后续在回过头来学习这块内容~</p>
<hr>
<h3 id="树的多种表示法"><a href="#树的多种表示法" class="headerlink" title="树的多种表示法"></a>树的多种表示法</h3><p>常用的表示方法：邻接列表、邻接数组、邻接矩阵。</p>
<p>在邻接矩阵中，查询边(u,v)需要的时间为$\theta(1)$，遍历v邻居的操作时间为$\theta(n)$，而到了邻接列表这种表示法中，两种操作所需要的时间都为$\theta(d(v))$。</p>
<p>解析XML文档或者遍历某文件系统目录结构时，直接使用现成的树结构和API。</p>
<p>最后介绍的一类图结构叫做<strong>子问题图(subproblem graph)</strong>，将来在学习各种不同算法技术时还会多次涉及它。</p>
<p>这个概念简单地说就是，绝大部分问题应该都可以被分成若干个子问题，这些子问题在结构上往往都非常相似。因此，这些结构可以被看做相关子问题图中的节点，而它们间的依赖关系就称为该图的边。例如，分治法以及动态规划等技术就出自这些分析。</p>
<hr>
<h3 id="算法编程中提防的陷阱"><a href="#算法编程中提防的陷阱" class="headerlink" title="算法编程中提防的陷阱"></a>算法编程中提防的陷阱</h3><ol>
<li>当性能成为重点问题时，要着重于实际分析而不是直觉。</li>
<li>当正确性至关重要时，最好的做法是用不同的实现体来对答案进行多次计算，即冗余原则。</li>
</ol>
<h4 id="隐性平方级操作"><a href="#隐性平方级操作" class="headerlink" title="隐性平方级操作"></a>隐性平方级操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> random <span class="keyword">import</span> randrange</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L = [randrange(<span class="number">10000</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>)]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">42</span> <span class="keyword">in</span> L</div><div class="line">&gt; <span class="keyword">False</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>S =set(L)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">42</span> <span class="keyword">in</span> S</div><div class="line">&gt; <span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>这个示例很能说明问题。正如书中所说，两种方式都很快，似乎在list上构建一个set是毫无意义的。实际代码的构造是依据具体情况的。如果进行多次成员查询操作，这样做值得！因为成员检测在list中是线性级的，而在set中则是常数级的。如果想依次往集合里添加新值，并在每一步中都检查该值是否已经被添加的话，这种情况用list来处理的话，运行时间是平方级的，而用set就可以获得线性级时间。 </p>
<p>但也有一些不那么明显的例子，它们也会带来许多问题。如下代码所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">S = <span class="string">''</span></div><div class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> string_producer():</div><div class="line">	s += chunk</div></pre></td></tr></table></figure></p>
<p>Python自身采用了一些非常聪明的优化，它在扩展到某一规模之前都能工作的很好 — 但随后这些优化的作用就会消退，运行时间也因此猛然呈现出平方级的增长。问题在于，需要在每次执行+=操作时新建一个字符串，并复制上一个字符串内容。这是一个有风险的业务逻辑。它有一个更好的解决方案：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">chunks = []</div><div class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> string_producer():</div><div class="line">	chunks.append(chunk)</div><div class="line">s = <span class="string">''</span>.join(chunks)</div><div class="line"><span class="comment"># 更优化</span></div><div class="line">s = <span class="string">''</span>.join(string_producer())</div></pre></td></tr></table></figure></p>
<h4 id="浮点数运算的麻烦"><a href="#浮点数运算的麻烦" class="headerlink" title="浮点数运算的麻烦"></a>浮点数运算的麻烦</h4><p>第一课就是“不要对浮点数进行等值比较”。实际应用中，我们可以检查它们是否接近于相等。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 2.7.10</span></div><div class="line">&gt;&gt;&gt;sum(<span class="number">0.1</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)) == <span class="number">1.0</span></div><div class="line">&gt;<span class="keyword">False</span></div><div class="line"></div><div class="line"><span class="comment"># 改进实现</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">almost_equal</span><span class="params">(x, y, places=<span class="number">7</span>)</span>:</span></div><div class="line">	<span class="keyword">return</span> round(abs(x-y),places) == <span class="number">0</span></div><div class="line">&gt;&gt;&gt;almost_equal(sum(<span class="number">0.1</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)),<span class="number">1.0</span>)</div><div class="line">&gt;<span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>此外，如果需要某种精确的十进制浮点数表示法，可以选择使用其他工具，如<code>decimal</code>模块：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> *</div><div class="line">sum(Decimal(<span class="string">"0.1"</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)) == Decimal(<span class="string">"1.0"</span>)</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/04/26/《Python算法教程》读书笔记-（三）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/26/《Python算法教程》读书笔记-（三）/" itemprop="url">
                  《Python算法教程》读书笔记 - （三）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-26T22:18:00+08:00">
                2017-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇博客重点是<strong>图与树</strong>的实现。</p>
<hr>
<h3 id="图与树"><a href="#图与树" class="headerlink" title="图与树"></a>图与树</h3><p>算法中最强大的框架之一 — 图结构(graph)，通常，如果可以讲问题诠释成一个图问题的话，至少该问题已经接近解决方案了；如果可以用树结构(tree)来诠释的话，基本已经拥有了一个真正的解决方案！足以说明树结构和图结构的重要性！</p>
<p>图结构可以表现几乎所有类型的结构与系统，例如交通网络、通信网络、细胞核交互、社交关系等等，并可通过添加权重值、距离值等额外数据来增强其表现能力。而树结构只是图结构的一种特殊情况。有很多的机构形式，如XML文档或者目录层次结构等等，实际上也都是用树结构来表现的。</p>
<p>以下是一些图术语：</p>
<blockquote>
<ol>
<li>图$G=(V,E)$通常由一组节点$V$及节点间的边$E$共同组成。如果这些边是带有方向的，则称其为有向图；</li>
<li>节点之间是通过边来实现彼此相连的。这些边其实就是节点$v$与其邻居之间的关系。与节点$v$相邻的节点，称为节点$v$的邻居。<strong>一个节点的度数就是连接其边的个数。</strong></li>
<li>图$G=(V,E)$的子图结构将由$V$的子集与$E$的子集共同组成。在$G$中没一条路径(path)是一个子图结构，本质上都是一些由多个节点串联而成的边线序列。环路(cycle)的定义与路径基本相同，只不过它最后一条边所连接末节点同时是它的首节点。</li>
<li>如果将图$G$中的每条边与某种权值联系在一起，就成为一种加权图。在加权图中，一条路径或环路的长度等于各条边上的权值之和；而对于非加权图而言，就直接等于该图的边数了。</li>
<li>森林(forest)可以被认为是一个无环路图，而这样的连通图就是一棵树。实质上，森林就是由一棵或多棵树构成的。</li>
</ol>
</blockquote>
<hr>
<h3 id="图数据结构"><a href="#图数据结构" class="headerlink" title="图数据结构"></a>图数据结构</h3><p>上面目前介绍关于图的一些基本概念，接下来核心知识即学会用某种数据结构来表示图。</p>
<p>用抽象属于来说，倾向于采用一种被称为邻近函数$N(v)$(neighborhood function)的实现方式。在这，会涉及一个容器N[v]，主要用于存储v节点的邻近节点。常见图数据结构主要放在<strong>邻接列表和邻接矩阵</strong>这两种著名的表现形式上，它们的可用性和普及率都很高。</p>
<p><strong>小插曲：黑盒子专栏之 dict 和 set</strong></p>
<blockquote>
<p>散列(hashing)在算法中及其常见，在Python语言中，标准散列机制是由hash函数提供的，如下调用一个对象的<code>__hash__</code>方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; hash(<span class="number">42</span>)</div><div class="line"><span class="number">42</span></div><div class="line">&gt; hash(<span class="string">"Hello,World!"</span>)</div><div class="line"><span class="number">1564194085</span></div></pre></td></tr></table></figure></p>
<p>该机制常用于字典类型(dict)的实现，dict就是通常所说的散列表。同样，集合类型(set)也是通过这种机制实现的。记住最重要的一点，<strong>散列值的构成基本上是在常数级时间内完成的</strong>。这意味着在对dict和set中的元素进行访问时所消耗的时间都是常数级别的，对于构建更为复杂的结构与算法是非常有用的！</p>
</blockquote>
<p>后续详细的学习下hash方法和<code>hashlib</code>模块。</p>
<hr>
<h3 id="邻接列表与其类似结构"><a href="#邻接列表与其类似结构" class="headerlink" title="邻接列表与其类似结构"></a>邻接列表与其类似结构</h3><p>对于图结构而言，最直观的实现方式之一就是使用邻接列表。即要针对每个结点设置一个邻居列表（也可以使set等其他容器或迭代器类型）。</p>
<p>接下来实现一个最简单的：假设有n个结点，编号分别为$0,1,…,n-1$，然后每个邻接(邻居)列表就都指示一个数字列表，可以讲它们编入一个大小为n的主列表，并用节点编号对其进行索引。由于这些列表内的顺序是任意的，所以实际上我们是使用集合来实现邻接集(adjacency sets)。</p>
<p>以下图为例具体说明图结构的各种表示法：</p>
<p>首先，完成对节点的编号工作$(a=0,b=1,c=2,d=3,e=4,f=5,g=6,h=7)$。该图可以先用一种简单明了的方式来表示，如下所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 简单明了的邻接集表示法</span></div><div class="line">a, b, c, d, e, f, g, h = range(<span class="number">8</span>)</div><div class="line">N = [</div><div class="line">	&#123;b, c, d, e, f&#125;,  <span class="comment"># a</span></div><div class="line">	&#123;c, e&#125;,           <span class="comment"># b</span></div><div class="line">	&#123;d&#125;,              <span class="comment"># c</span></div><div class="line">	&#123;e&#125;,              <span class="comment"># d</span></div><div class="line">	&#123;f&#125;,              <span class="comment"># e</span></div><div class="line">	&#123;c, g, h&#125;,        <span class="comment"># f</span></div><div class="line">	&#123;f, h&#125;,           <span class="comment"># g</span></div><div class="line">	&#123;f, g&#125;            <span class="comment"># h</span></div><div class="line">]</div><div class="line"><span class="comment">## 结果,在Ipython中结果如下，在Python解释器中是类似set([1,2,3,4,5])。</span></div><div class="line">&gt; [&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;, &#123;<span class="number">2</span>, <span class="number">4</span>&#125;, &#123;<span class="number">3</span>&#125;, &#123;<span class="number">4</span>&#125;, &#123;<span class="number">5</span>&#125;, &#123;<span class="number">2</span>, <span class="number">6</span>, <span class="number">7</span>&#125;, &#123;<span class="number">5</span>, <span class="number">7</span>&#125;, &#123;<span class="number">5</span>, <span class="number">6</span>&#125;]</div></pre></td></tr></table></figure></p>
<p>变量N作用相当于之前提到的N函数。在图论中，$N(v)$代表的是v节点的邻居节点集。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; N[a]    <span class="comment"># a节点的邻居节点集</span></div><div class="line">&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</div><div class="line">&gt; b <span class="keyword">in</span> N[a]   <span class="comment"># 判断b节点是否是a节点的邻居节点</span></div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>在某些情况下，另一种表示方法的开销会更小一些，即用真正的邻接列表来代替上面的邻接集。如下所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 简单明了的邻接列表示法</span></div><div class="line">a, b, c, d, e, f, g, h = range(<span class="number">8</span>)</div><div class="line">N = [</div><div class="line">	[b, c, d, e, f],  <span class="comment"># a</span></div><div class="line">	[c, e],           <span class="comment"># b</span></div><div class="line">	[d],              <span class="comment"># c</span></div><div class="line">	[e],              <span class="comment"># d</span></div><div class="line">	[f],              <span class="comment"># e</span></div><div class="line">	[c, g, h],        <span class="comment"># f</span></div><div class="line">	[f, h],           <span class="comment"># g</span></div><div class="line">	[f, g]            <span class="comment"># h</span></div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>这种表示法可能存在着一个争议，因为它实际上是一组邻接数组的结合，而并非传统意义上的邻接列表。</p>
<p>在Python中，list类型的背后实际上是一个<strong>动态数组</strong>。</p>
<p>在执行与图有关的工作时，要遵从一个主题思想，即一个图的最佳表示方法应该取决于我们用它来做什么！例如，邻接列表(或数组)可以让我们在维持低成本的情况下，对$N(v)$中所有节点v进行有效遍历。然而，在检查u和v是否互为邻居时的成本就是$\theta(N(v))$。这时如果改图的结构很密集(如果它的边很多的话)，很可能会带来一些问题，此时邻接集或许是个更好的选择。</p>
<p>还有另外一种表示方法，就是用dict类型来替代这里的set或list。在dict类型中，每个邻居几点都会有一个键值对，用于表示与其邻居节点（或<strong>出边</strong>）之间的关联性，如边的权重。如下所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 加权邻接字典</span></div><div class="line">a, b, c, d, e, f, g, h = range(<span class="number">8</span>)</div><div class="line">N = [</div><div class="line">	&#123;b:<span class="number">2</span>, c:<span class="number">1</span>, d:<span class="number">3</span>, e:<span class="number">9</span>, f:<span class="number">4</span>&#125;,  <span class="comment"># a</span></div><div class="line">	&#123;c:<span class="number">4</span>, e:<span class="number">4</span>&#125;,           <span class="comment"># b</span></div><div class="line">	&#123;d:<span class="number">8</span>&#125;,              <span class="comment"># c</span></div><div class="line">	&#123;e:<span class="number">7</span>&#125;,              <span class="comment"># d</span></div><div class="line">	&#123;f:<span class="number">5</span>&#125;,              <span class="comment"># e</span></div><div class="line">	&#123;c:<span class="number">2</span>, g:<span class="number">2</span>, h:<span class="number">2</span>&#125;,        <span class="comment"># f</span></div><div class="line">	&#123;f:<span class="number">1</span>, h:<span class="number">6</span>&#125;,           <span class="comment"># g</span></div><div class="line">	&#123;f:<span class="number">9</span>, g:<span class="number">8</span>&#125;            <span class="comment"># h</span></div><div class="line">]</div><div class="line">&gt;&gt;&gt;b <span class="keyword">in</span> N[a]    <span class="comment"># Neighborhood membership  邻节点成员关系</span></div><div class="line">&gt;<span class="keyword">True</span></div><div class="line">&gt;&gt;&gt;len(N[f])    <span class="comment"># Degree   节点的度</span></div><div class="line">&gt;<span class="number">3</span></div><div class="line">&gt;&gt;&gt;N[a][b]      <span class="comment"># Edge weight for (a,b) 节点a到节点b的权重</span></div><div class="line">&gt;<span class="number">2</span></div></pre></td></tr></table></figure></p>
<p>目前为止，用来存储邻接结构（可能是list、set、dict）的主要容器其实都是列表类型，它们都以节点编号为索引值。对灵活性而言，使用dict类型来作为主要存储结构会是一种更好的选择（因为它允许我们使用任意可散列的对象来充当节点标签）。用dict存储邻接集的具体示例如下所示，在这里是用字符来表示相关节点的。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 邻接集的字典表示法</span></div><div class="line">N = &#123;</div><div class="line">	<span class="string">'a'</span>:set(<span class="string">'bcdef'</span>),        <span class="comment"># a</span></div><div class="line">	<span class="string">'b'</span>:set(<span class="string">'ce'</span>),           <span class="comment"># b</span></div><div class="line">	<span class="string">'c'</span>:set(<span class="string">'d'</span>),            <span class="comment"># c</span></div><div class="line">	<span class="string">'d'</span>:set(<span class="string">'e'</span>),            <span class="comment"># d</span></div><div class="line">	<span class="string">'e'</span>:set(<span class="string">'f'</span>),            <span class="comment"># e</span></div><div class="line">	<span class="string">'f'</span>:set(<span class="string">'cgh'</span>),          <span class="comment"># f</span></div><div class="line">	<span class="string">'g'</span>:set(<span class="string">'fh'</span>),           <span class="comment"># g</span></div><div class="line">	<span class="string">'h'</span>:set(<span class="string">'fg'</span>)            <span class="comment"># h</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="邻接矩阵"><a href="#邻接矩阵" class="headerlink" title="邻接矩阵"></a>邻接矩阵</h3><p>图的另一种常见表示法就是邻接矩阵了！这种表示的主要不同之处在于，它不再列出每个节点的所有邻居节点，而是会将每个节点可能的邻居位置排成一排（也就是一个数组，用于对应图中每个节点），然后用某种值（True或False）来表示相关节点是否为当前节点的邻居。</p>
<p>其最简单的形式也可以用嵌套list来实现，如下所示，其中，节点编号依然是从0到$V-1$，并且为了让矩阵具有更好的可读性，会用1和0来填充真值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 用嵌套list实现的邻接矩阵</span></div><div class="line">a, b, c, d, e, f, g, h = range(<span class="number">8</span>)</div><div class="line"></div><div class="line">N = [</div><div class="line">	[<span class="number">0</span>，<span class="number">1</span>，<span class="number">1</span>，<span class="number">1</span>，<span class="number">1</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">0</span>],    <span class="comment"># a</span></div><div class="line">	[<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>],    <span class="comment"># b</span></div><div class="line">	[<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>],    <span class="comment"># c</span></div><div class="line">	[<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>],    <span class="comment"># d</span></div><div class="line">	[<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">0</span>],    <span class="comment"># e</span></div><div class="line">	[<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">1</span>],    <span class="comment"># f</span></div><div class="line">	[<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">0</span>，<span class="number">1</span>],    <span class="comment"># g</span></div><div class="line">	[<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">0</span>，<span class="number">1</span>，<span class="number">1</span>，<span class="number">0</span>],    <span class="comment"># h</span></div><div class="line">]</div><div class="line">&gt;&gt;&gt;N[a][b]    <span class="comment"># Neighborhood membership</span></div><div class="line">&gt;<span class="number">1</span></div><div class="line">&gt;&gt;&gt;sum(N[f])    <span class="comment"># Degree</span></div><div class="line">&gt;<span class="number">3</span></div></pre></td></tr></table></figure></p>
<p>在使用方式上与邻接列表或邻接集略有不同。邻居关系检查是要检查矩阵单元N[a][b]是否为真。相关节点的邻居数度，用sum函数求得。</p>
<p>在邻接矩阵中，有一些实用的特性。</p>
<blockquote>
<p>首先，只要不允许出现自循环状态，其对角线上的值应该全为假。<br>而且，通过向现有表示法中加入双向边元素的方式来实现一个无向图，这就意味着无向图的邻接矩阵应该是一个对称矩阵。</p>
</blockquote>
<p>将邻接矩阵扩展成对边进行加权处理，也非常简单：在原来存储真值的地方直接存储对应的权值即可。</p>
<p>例如：对于边$(u,v)$来说，只需要将N[u][v]处的True替换成$\omega(u,v)$的权值即可。出于某些实践因素的考虑，通常会将一些实际不存在的边的权值设置为无穷大。（这可以确保它们不会被纳入考虑的范围，也就是说，在考虑<strong>最短路径</strong>时，我们只要根据实际存在的那些边来寻找合适路径）。</p>
<p>也可以设置为一个非法的权值，如None、-1。但许多情况下，更实用的做法是设置一个非常大的值。通常对于整型加权值来说，用<code>sys.maxint</code>即可。在对浮点型的设计中，有一个可以代表无穷大的值：inf。该值在python中没有直接可用的名称，但我们可以通过<code>float(&#39;inf&#39;)</code>表达式来获取它。</p>
<p>如下所示，演示了如何用嵌套list来实现一个加权矩阵。要注意的是，该矩阵对角线上的值依然应该全为0，因为即使在没有自循环存在的情况下，相关权值也往往会被解释称为某种距离形式，从理解上来说，任一节点到自身的距离都应该始终是0。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#对不存在的边赋予无限大权值的加权矩阵</span></div><div class="line">a, b, c, d, e, f, g, h = range(<span class="number">8</span>)</div><div class="line">inf = float(<span class="string">'inf'</span>)</div><div class="line">W = [</div><div class="line">    [<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">9</span>,<span class="number">4</span>,inf,inf], <span class="comment">#a</span></div><div class="line">    [inf,<span class="number">0</span>,<span class="number">4</span>,inf,<span class="number">3</span>,inf,inf,inf],  <span class="comment">#b</span></div><div class="line">    [inf,inf,<span class="number">0</span>,<span class="number">8</span>,inf,inf,inf,inf], <span class="comment">#c</span></div><div class="line">    [inf,inf,inf,<span class="number">0</span>,<span class="number">7</span>,inf,inf,inf], <span class="comment">#d</span></div><div class="line">    [inf,inf,inf,inf,<span class="number">0</span>,<span class="number">5</span>,inf,inf], <span class="comment">#e</span></div><div class="line">    [inf,inf,<span class="number">2</span>,inf,inf,<span class="number">0</span>,<span class="number">2</span>,<span class="number">2</span>], <span class="comment">#f</span></div><div class="line">    [inf,inf,inf,inf,inf,<span class="number">1</span>,<span class="number">0</span>,<span class="number">6</span>], <span class="comment">#g</span></div><div class="line">    [inf,inf,inf,inf,inf,<span class="number">9</span>,<span class="number">8</span>,<span class="number">0</span>] <span class="comment">#h</span></div><div class="line">]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>W[a][b] &lt; inf <span class="comment">#Neighborhood membership</span></div><div class="line">&gt; <span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>W[c][e] &lt; inf <span class="comment"># Neighborhood membership</span></div><div class="line">&gt; <span class="keyword">False</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>sum(<span class="number">1</span> <span class="keyword">for</span> w <span class="keyword">in</span> W[a] <span class="keyword">if</span> w &lt; inf) - <span class="number">1</span>  <span class="comment"># Degree</span></div><div class="line">&gt; <span class="number">5</span>    <span class="comment"># -1 是因为节点与其自身不算做边</span></div></pre></td></tr></table></figure></p>
<p>如上成员检测、查找某个特定节点的度(degree)。尽管这个表达结构在度的计算上的操作复杂度是$\theta(n)$，但它很适合于相关成员与度的查找计算操作，并且这些操作在常数时间内完成。</p>
<p><strong>小插曲</strong></p>
<blockquote>
<p>Numpy库提供大量与多维数组有关的功能。就Numpy中的数组类型而言，对于实现邻接矩阵或加权矩阵是非常不错的。<br>例如，当需要一个基于list的、面向n个结点的空加权（或邻接）矩阵时，通常这样实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>N= [[<span class="number">0</span>] * <span class="number">10</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>)]</div><div class="line"><span class="comment"># 而在Numpy中，通过zeros函数实现：</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>N = np.zeros([<span class="number">10</span>,<span class="number">10</span>])</div><div class="line"><span class="comment"># 结果</span></div><div class="line">array([[ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>],</div><div class="line">       [ <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>,  <span class="number">0.</span>]])</div></pre></td></tr></table></figure></p>
<p>如果处理的是相对稀疏的图，即矩阵中只有一小部分有值，可通过更为特殊的一种稀疏矩阵的形式来节省内存开销。可以再Scipy中的scipy.sparse模块找到。</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Fujia" />
          <p class="site-author-name" itemprop="name">Fujia</p>
           
              <p class="site-description motion-element" itemprop="description">好记性不如烂笔头,更何况记性还不好</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">23</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fujia</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  



  




	





  





  





  






  





  

  

  

  

</body>
</html>
