<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="好记性不如烂笔头,更何况记性还不好">
<meta property="og:type" content="website">
<meta property="og:title" content="Fujia's Blog">
<meta property="og:url" content="https://fujiador.github.io/index.html">
<meta property="og:site_name" content="Fujia's Blog">
<meta property="og:description" content="好记性不如烂笔头,更何况记性还不好">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fujia's Blog">
<meta name="twitter:description" content="好记性不如烂笔头,更何况记性还不好">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fujiador.github.io/"/>





  <title> Fujia's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fujia's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">点滴技术的印记</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/07/06/机器学习：岭回归/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/06/机器学习：岭回归/" itemprop="url">
                  机器学习：岭回归
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-06T23:05:54+08:00">
                2017-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p><img src="http://on58f12qv.bkt.clouddn.com/%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0.PNG" alt="问题描述|center"></p>
<hr>
<h3 id="岭回归"><a href="#岭回归" class="headerlink" title="岭回归"></a>岭回归</h3><p><img src="http://on58f12qv.bkt.clouddn.com/%E5%B2%AD%E5%9B%9E%E5%BD%92.PNG" alt="岭回归|center"></p>
<hr>
<h3 id="sklearn-中的岭回归"><a href="#sklearn-中的岭回归" class="headerlink" title="sklearn 中的岭回归"></a>sklearn 中的岭回归</h3><h4 id="1-绘制岭系数作为正则化函数"><a href="#1、绘制岭系数作为正则化函数" class="headerlink" title="1、绘制岭系数作为正则化函数"></a><a href="http://scikit-learn.org/stable/auto_examples/linear_model/plot_ridge_path.html#sphx-glr-auto-examples-linear-model-plot-ridge-path-py" target="_blank" rel="external">1、绘制岭系数作为正则化函数</a></h4><p>主要目的是通过绘制岭系数作为正则化函数，来展示共线性对估计器系数的影响。</p>
<p>下例使用岭回归估计器，每个颜色代表一个不同特征的系数向量，并且以正则化函数形式来展示。</p>
<p>本利还展现出岭回归应用于高病态矩阵的有效性。对于高病态矩阵，目标变量的轻微变化可能导致计算权重系数的巨大差异。在这种情况下，设定一定程度的正则化（$\alpha$）可以有效的减少这种变化。</p>
<p>当$\alpha$非常大时，正则化效应主导平方损失函数，权重系数趋于零。在岭迹的末端，由于$\alpha$趋于零，解决方案趋向于OLS，所以系数呈现出较大的振荡。</p>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><h4 id="1-ridge-coefficients-as-a-function-of-the-regularization"><a href="#1、Ridge-coefficients-as-a-function-of-the-regularization" class="headerlink" title="1、Ridge coefficients as a function of the regularization"></a>1、Ridge coefficients as a function of the regularization</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> linear_model</div><div class="line"></div><div class="line"><span class="comment"># 构建训练数据集, X是一个10X10的希尔伯特矩阵Hilbert Matrix。HilbertMatrix是元素A（i,j）=1/(i+j-1),i,j分别为行表和列表。是一种数学变换矩阵，具有正定、且高度病态（即任何一个元素发生一点变动整个矩阵的行列式的值和逆矩阵都会发生巨大变化）的特点，病态程度和阶数有关。</span></div><div class="line">X = <span class="number">1.</span> / (np.arange(<span class="number">1</span>,<span class="number">11</span>) + np.arange(<span class="number">0</span>,<span class="number">10</span>)[:, np.newaxis])</div><div class="line">y = np.ones(<span class="number">10</span>)</div><div class="line"></div><div class="line"><span class="comment"># 计算岭迹 compute path</span></div><div class="line">n_alphas = <span class="number">200</span></div><div class="line">alphas = np.logspace(<span class="number">-10</span>, <span class="number">-2</span>, n_alphas)</div><div class="line"></div><div class="line"><span class="comment"># 实例化岭回归对象</span></div><div class="line">clf = linear_model.Ridge(fit_intercept=<span class="keyword">False</span>)</div><div class="line">coefs = []</div><div class="line"><span class="keyword">for</span> a <span class="keyword">in</span> alphas:</div><div class="line">    clf.set_params(alpha=a)</div><div class="line">    clf.fit(X, y)</div><div class="line">    coefs.append(clf.coef_)</div><div class="line"></div><div class="line"><span class="comment"># 图形展示,plt.gca() get_current_axis plt.gcf() get_current_figure</span></div><div class="line">ax.plot(alphas, coefs)</div><div class="line">ax.set_xscale(<span class="string">'log'</span>)</div><div class="line">ax.set_xlim(ax.get_xlim()[::<span class="number">-1</span>])</div><div class="line">plt.xlabel(<span class="string">'alpha'</span>)</div><div class="line">plt.ylabel(<span class="string">'weights'</span>)</div><div class="line">plt.title(<span class="string">'Ridge coefficients as a function of the regularization'</span>)</div><div class="line">plt.axis(<span class="string">'tight'</span>)</div><div class="line">plt.show()</div></pre></td></tr></table></figure>
<p><img src="http://on58f12qv.bkt.clouddn.com/%E5%B2%AD%E5%9B%9E%E5%BD%92-%E5%B2%AD%E8%BF%B9%E5%9B%BE.png" alt="岭回归-岭迹图|center"><br><strong>现在还不是很理解岭迹图的实际含义及其作用，先MARK下之后再来消化这个生饭。</strong></p>
<p>初步认识下数据集X，具象下病态矩阵的模样。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt;np.arange(0,10)</div><div class="line">array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])</div><div class="line">&gt;&gt;&gt;np.arange(0,10)[:,np.newaxis] </div><div class="line">array([[0],</div><div class="line">       [1],</div><div class="line">       [2],</div><div class="line">       [3],</div><div class="line">       [4],</div><div class="line">       [5],</div><div class="line">       [6],</div><div class="line">       [7],</div><div class="line">       [8],</div><div class="line">       [9]])</div><div class="line">&gt;&gt;&gt;np.arange(1,11) + np.arange(0,10)[:,np.newaxis] </div><div class="line">array([[ 1,  2,  3,  4,  5,  6,  7,  8,  9, 10],</div><div class="line">       [ 2,  3,  4,  5,  6,  7,  8,  9, 10, 11],</div><div class="line">       [ 3,  4,  5,  6,  7,  8,  9, 10, 11, 12],</div><div class="line">       [ 4,  5,  6,  7,  8,  9, 10, 11, 12, 13],</div><div class="line">       [ 5,  6,  7,  8,  9, 10, 11, 12, 13, 14],</div><div class="line">       [ 6,  7,  8,  9, 10, 11, 12, 13, 14, 15],</div><div class="line">       [ 7,  8,  9, 10, 11, 12, 13, 14, 15, 16],</div><div class="line">       [ 8,  9, 10, 11, 12, 13, 14, 15, 16, 17],</div><div class="line">       [ 9, 10, 11, 12, 13, 14, 15, 16, 17, 18],</div><div class="line">       [10, 11, 12, 13, 14, 15, 16, 17, 18, 19]])</div></pre></td></tr></table></figure></p>
<h4 id="2-classification-of-text-documents-using-sparse-features"><a href="#2、Classification-of-text-documents-using-sparse-features" class="headerlink" title="2、Classification of text documents using sparse features"></a>2、Classification of text documents using sparse features</h4><p>对稀疏特征的文本文档进行分类。下例展示如何应用Scikit-Learn通过使用“bag-of-words”方法对文档主题进行分类。<br>官方示例，对比了多种训练方法分别对比了训练时间、测试时间、准确率等数据。</p>
<p><img src="http://on58f12qv.bkt.clouddn.com/Text_Classification.png" alt="文档分类训练|center"></p>
<p>因这个示例中涉及到的知识点非常多，目前个人还没有完全掌握，详细的代码请参考<br><a href="http://scikit-learn.org/stable/auto_examples/text/document_classification_20newsgroups.html#sphx-glr-auto-examples-text-document-classification-20newsgroups-py" target="_blank" rel="external">文档分类训练|center</a>。</p>
<h3 id="交通流量预测实例"><a href="#交通流量预测实例" class="headerlink" title="交通流量预测实例"></a><a href="http://blog.csdn.net/jinbaosite/article/details/73951882#html" target="_blank" rel="external">交通流量预测实例</a></h3><h4 id="1-数据介绍"><a href="#1、数据介绍" class="headerlink" title="1、数据介绍"></a>1、数据介绍</h4><p>数据是某路口的交通流量监测数据，记录全年小时级别的车流量信息。</p>
<h4 id="2-目的"><a href="#2、目的" class="headerlink" title="2、目的"></a>2、目的</h4><p>根据已有的数据创建多项式拟合函数，使用岭回归模型对车流量的信息进行多项式回归拟合。<br>主要用到<code>sklearn.linear_model.Ridge</code>和<code>sklearn.preprocessing.Polynomial</code></p>
<h4 id="3-数据说明"><a href="#3、数据说明" class="headerlink" title="3、数据说明"></a>3、数据说明</h4><p>数据特征维度如下：</p>
<blockquote>
<p>ID：某路口的编号<br>HR：每日中的第几个小时，范围0-23<br>WEEK_DAY：每周中的第几日，范围0-6<br>DAY_OF_YEAR：每年中的第几日，范围1-365<br>WEEK_OF_YEAR：每年中的第几周，范围1-53<br>TRAFFIC_COUNT：路口交通流量统计</p>
</blockquote>
<p><img src="http://on58f12qv.bkt.clouddn.com/%E4%BA%A4%E9%80%9A%E6%B5%81%E9%87%8F%E9%A2%84%E6%B5%8B%E6%95%B0%E6%8D%AE.png" alt="交通流量预测数据|center"></p>
<h4 id="4-基础数据统计"><a href="#4、基础数据统计" class="headerlink" title="4、基础数据统计"></a>4、基础数据统计</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_Data</span><span class="params">(file_name, sep=<span class="string">','</span>, encoding=<span class="string">'utf-8'</span>)</span>:</span></div><div class="line">    file_path = os.path.join(os.path.dirname(__file__), file_name)</div><div class="line">    <span class="keyword">if</span> os.path.exists(file_path):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            data_df = pd.read_csv(file_path, sep=sep, encoding=encoding)</div><div class="line">            <span class="keyword">return</span> data_df</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            print(<span class="string">"The process has wrong. Error information:&#123;0&#125;"</span>.format(e))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        print(<span class="string">"file_path doesn't exists. Please check the file_name or file_path."</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">basicInfo</span><span class="params">(data_frame)</span>:</span></div><div class="line">    <span class="keyword">if</span> data_frame <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        print(<span class="string">"please check the input dataFrame."</span>)</div><div class="line">    print(<span class="string">"Show the data information as following:"</span>)</div><div class="line">    print(<span class="string">"="</span> * <span class="number">80</span> + <span class="string">'\nhead'</span>)</div><div class="line">    print(data_frame.head(<span class="number">5</span>))</div><div class="line">    print(<span class="string">"_"</span> * <span class="number">80</span> + <span class="string">'\ntail'</span>)</div><div class="line">    print(data_frame.tail(<span class="number">5</span>))</div><div class="line"></div><div class="line">    print(<span class="string">"_"</span> * <span class="number">80</span> + <span class="string">'\nindex'</span>)</div><div class="line">    print(data_frame.index)</div><div class="line">    print((<span class="string">"_"</span> * <span class="number">80</span> + <span class="string">'\ncolumns'</span>))</div><div class="line">    print(data_frame.columns)</div><div class="line">    print(<span class="string">"="</span> * <span class="number">80</span>)</div><div class="line"></div><div class="line">    print(<span class="string">'\n'</span>)</div><div class="line">    print(<span class="string">"="</span> * <span class="number">80</span> + <span class="string">'\nSummary Information:\n'</span>)</div><div class="line">    print(data_frame[<span class="string">'TRAFFIC_COUNT'</span>].describe())</div><div class="line">    print(<span class="string">"="</span> * <span class="number">80</span>)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">summaryInfo_perHour</span><span class="params">(data_frame)</span>:</span></div><div class="line">    <span class="keyword">if</span> data_frame <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        print(<span class="string">"please check the input dataFrame."</span>)</div><div class="line">    totFlow_per_hour = data_frame[[<span class="string">'HR'</span>, <span class="string">'TRAFFIC_COUNT'</span>]].groupby(<span class="string">'HR'</span>).sum()</div><div class="line">    avgFlow_per_hour = data_frame[[<span class="string">'HR'</span>, <span class="string">'TRAFFIC_COUNT'</span>]].groupby(<span class="string">'HR'</span>).mean()</div><div class="line">    <span class="comment"># display the data relationship</span></div><div class="line">    plt.figure()</div><div class="line">    plt.subplot(<span class="number">121</span>)</div><div class="line">    plt.plot(totFlow_per_hour.index, totFlow_per_hour[<span class="string">'TRAFFIC_COUNT'</span>],<span class="string">'--'</span>)</div><div class="line">    plt.xlabel(<span class="string">"Hour"</span>)</div><div class="line">    plt.ylabel(<span class="string">"Tot_Traffic_flow"</span>)</div><div class="line">    plt.title(<span class="string">"Traffic Flow SumData Trend per Hour"</span>)</div><div class="line">    plt.subplot(<span class="number">122</span>)</div><div class="line">    plt.plot(avgFlow_per_hour.index, avgFlow_per_hour[<span class="string">'TRAFFIC_COUNT'</span>],<span class="string">'o'</span>)</div><div class="line">    plt.xlabel(<span class="string">"Hour"</span>)</div><div class="line">    plt.ylabel(<span class="string">"avg_Traffic_flow"</span>)</div><div class="line">    plt.title(<span class="string">"Traffic Flow AvgData Trend per Hour"</span>)</div><div class="line">    plt.savefig(<span class="string">"Traffic_Flow_AvgData_Trend_per_Hour.png"</span>)</div><div class="line">    plt.show()</div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">summaryInfo_perDay</span><span class="params">(data_frame)</span>:</span></div><div class="line">    <span class="keyword">if</span> data_frame <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        print(<span class="string">"please check the input dataFrame."</span>)</div><div class="line">    totFlow_per_day = data_frame[[<span class="string">'DAY_OF_YEAR'</span>, <span class="string">'TRAFFIC_COUNT'</span>]].groupby(<span class="string">'DAY_OF_YEAR'</span>).sum()</div><div class="line">    <span class="comment"># display the data relationship</span></div><div class="line">    plt.figure()</div><div class="line">    plt.plot(totFlow_per_day.index, totFlow_per_day[<span class="string">'TRAFFIC_COUNT'</span>])</div><div class="line">    plt.xlabel(<span class="string">"day"</span>)</div><div class="line">    plt.ylabel(<span class="string">"Traffic Flow veryday"</span>)</div><div class="line">    plt.title(<span class="string">"Traffic Flow Data Trend every day"</span>)</div><div class="line">    plt.savefig(<span class="string">"Traffic_Flow_Data_Trend_every_day.png"</span>)</div><div class="line">    plt.show()</div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    data_frame = load_Data(<span class="string">'traffic_flow_rawdata.csv'</span>)</div><div class="line">    <span class="comment"># 基础统计信息</span></div><div class="line">    basicInfo(data_frame)</div><div class="line">    <span class="comment"># 展示每小时流量变化趋势</span></div><div class="line">    summaryInfo_perHour(data_frame)</div><div class="line">    <span class="comment"># 展示每天流量变化趋势</span></div><div class="line">    summaryInfo_perDay(data_frame)</div></pre></td></tr></table></figure>
<p>在基础分析过程中，发现原始数据是有一些问题的，但因为数据源并不是个人一手统计，所以暂时使用。<br><img src="http://on58f12qv.bkt.clouddn.com/Traffic_Flow_AvgData_Trend_per_Hour.png" alt="按照每日小时时段汇总车流量趋势数据|center|600X0"></p>
<p>从每日各小时车流量的数据分布中发现，这份数据不并非是典型的早高峰、晚高峰的态势，可能跟具体的路口车流量的特点有紧密关系。</p>
<p><img src="http://on58f12qv.bkt.clouddn.com/Traffic_Flow_Data_Trend_every_day.png" alt="按照每天汇总车流量趋势数据|center"></p>
<p>从每天车流量的数据分布中发现，数据有比较明显的周期性流量特点，并且后半部分数据明显量级增加。</p>
<p>其中存在较多的异常值，因原始数据源的准确性问题，暂时不做异常值方面的分析和处理。</p>
<h4 id="5-岭回归拟合预测"><a href="#5、岭回归拟合预测" class="headerlink" title="5、岭回归拟合预测"></a>5、岭回归拟合预测</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> warnings</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Ridge</div><div class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> cross_validation</div><div class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> PolynomialFeatures</div><div class="line"></div><div class="line">warnings.filterwarnings(<span class="string">"ignore"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_Data</span><span class="params">(file_name)</span>:</span></div><div class="line">    file_path = os.path.join(os.path.dirname(__file__), file_name)</div><div class="line">    <span class="keyword">if</span> os.path.exists(file_path):</div><div class="line">        data = np.genfromtxt(file_path)</div><div class="line">        X, y = data[:, :<span class="number">5</span>], data[:, <span class="number">5</span>]</div><div class="line">        <span class="keyword">return</span> X, y</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">pre_process</span><span class="params">(X, y, pf_i)</span>:</span></div><div class="line">    poly = PolynomialFeatures(pf_i)</div><div class="line">    X = poly.fit_transform(X)</div><div class="line">    train_set_X, test_set_X, train_set_y, test_set_y = cross_validation.train_test_split(X, y,</div><div class="line">                                                                    test_size=<span class="number">0.3</span>, random_state=<span class="number">0</span>)</div><div class="line">    <span class="keyword">return</span> X,train_set_X, test_set_X, train_set_y, test_set_y</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">visual_display</span><span class="params">(y, y_pre)</span>:</span></div><div class="line">    start, end = <span class="number">200</span>, <span class="number">300</span></div><div class="line">    time = np.arange(start, end)</div><div class="line">    plt.plot(time, y[start:end], <span class="string">'b'</span>, label=<span class="string">'real traffic flow'</span>)</div><div class="line">    plt.plot(time, y_pre[start:end], <span class="string">'r'</span>, label=<span class="string">'predict traffic flow'</span>)</div><div class="line">    plt.legend(loc=<span class="string">'upper left'</span>)</div><div class="line">    plt.show()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    X, y = load_Data(<span class="string">'rawdata.txt'</span>)</div><div class="line">    fig = plt.figure()</div><div class="line">    pf_i = <span class="number">4</span>  <span class="comment"># 测试最优的Polynomial Feature </span></div><div class="line">    X, train_set_X, test_set_X, train_set_y, test_set_y = pre_process(X, y, pf_i=pf_i)</div><div class="line">    <span class="comment"># 创建估计器,并进行训练</span></div><div class="line">    clf = Ridge(alpha=<span class="number">0.01</span>, fit_intercept=<span class="keyword">True</span>)</div><div class="line">    clf.fit(train_set_X, train_set_y)</div><div class="line">    print(clf.score(test_set_X, test_set_y))</div><div class="line"></div><div class="line">    y_pre = clf.predict(X)</div><div class="line">    visual_display(y, y_pre)</div></pre></td></tr></table></figure>
<p>首先，当正则化惩罚项$\alpha=1.0$时，依次尝试不同的pf_i值：</p>
<p><strong>pf_i=1       Score: 0.12212161115</strong><br><img src="http://on58f12qv.bkt.clouddn.com/ridge_regression_info_pfi=1.png" alt="Alt text|center|300x0"></p>
<p><strong>pf_i=2       Score: 0.528338472962</strong><br><img src="http://on58f12qv.bkt.clouddn.com/ridge_regression_info_pfi=2.png" alt="Alt text|center|300x0"></p>
<p><strong>pf_i=3       Score: 0.664089383716</strong><br><img src="http://on58f12qv.bkt.clouddn.com/ridge_regression_info_pfi=3.png" alt="Alt text|center|300x0"></p>
<p><strong>pf_i=4       Score: 0.744530809564</strong><br><img src="http://on58f12qv.bkt.clouddn.com/ridge_regression_info_pfi=4.png" alt="Alt text|center|300x0"></p>
<p><strong>pf_i=5       Score: -2.91583570786</strong><br><img src="http://on58f12qv.bkt.clouddn.com/ridge_regression_info_pfi=5.png" alt="Alt text|center|300x0"></p>
<p><strong>pf_i=6       Score: 0.211225114567</strong><br><img src="http://on58f12qv.bkt.clouddn.com/ridge_regression_info_pfi=6.png" alt="Alt text|center|300x0"></p>
<p>从结果来看，选择pf_i=4时，岭回归拟合的结果稍微过得去。其中有数据源准确度的问题、异常值存在等问题未进行处理。</p>
<p>其次，当pf_i值固定为4时，调整$\alpha$从[100,10,1.0,0.1,0.01,0.001,0.0001]，其中除了当$\alpha=0.1$时拟合结果明显变差之外，其他$\alpha$值均无明显的变化。</p>
<hr>
<h3 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h3><p>岭回归算法部分，还有一些不够彻底理解的内容。从实验操作的结果来看，也不能够彻底理解参数在变化过程中对结果的影响。</p>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="http://blog.csdn.net/jinbaosite/article/details/73951882#html" target="_blank" rel="external">交通流量实例</a><br><a href="http://scikit-learn.org/stable/modules/linear_model.html#ordinary-least-squares" target="_blank" rel="external">Ridge Regression</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/07/05/Python-Package：Threading多线程和Multiprocessing多进程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/05/Python-Package：Threading多线程和Multiprocessing多进程/" itemprop="url">
                  Python Package：Threading多线程和Multiprocessing多进程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-05T21:53:42+08:00">
                2017-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="threading-介绍"><a href="#Threading-介绍" class="headerlink" title="Threading 介绍"></a>Threading 介绍</h3><p><code>threading</code>是一个高级多线程接口，<code>thread</code>是比较底层的多线程模块，<code>threading</code>是对<code>thread</code>做了一些封装而可以更加方便的被使用。<code>Threading</code>模块主要是对一些线程的操作对象化，创建了<code>Thread Class</code>类，是多线程功能的核心部分。</p>
<p>一般使用多线程有两种模式：</p>
<ol>
<li>一种是创建线程索要执行的函数，把这个函数传递到<code>Thread</code>对象中，让它来执行。</li>
<li>另一种是直接从<code>Thread</code>类中继承，创建一个新的Class类，把线程执行的代码放到这个新Class中，相当于重新构造<code>__init__</code>和<code>run</code>方法。</li>
</ol>
<hr>
<h3 id="threading-代码示例"><a href="#Threading-代码示例" class="headerlink" title="Threading 代码示例"></a>Threading 代码示例</h3><p>1、面向过程函数式<br>直接调用<code>Threading</code>中的<code>Thread</code>类的构造函数，指定参数<code>target=func</code>，如果<code>func</code>需要传递参数，可在构造函数中传递参数<code>args=(args,)</code>。之后再将返回的Thread实例调用<code>start()</code>方法，即开始运行该线程，该线程则执行函数<code>func(args)</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> time,os</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main_func</span><span class="params">(tid)</span>:</span></div><div class="line">    <span class="string">'''线程执行的函数'''</span></div><div class="line">    <span class="keyword">global</span> i,lock</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        lock.acquire()  <span class="comment"># i是全局变量,所有线程操作更新i,需要加锁</span></div><div class="line">        <span class="keyword">if</span> i != <span class="number">0</span>:</div><div class="line">            i -= <span class="number">1</span></div><div class="line">            <span class="keyword">print</span> tid,<span class="string">":now left:"</span>,i</div><div class="line">            time.sleep(<span class="number">0.5</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"Thread_id"</span>, tid, <span class="string">"No more tickets"</span></div><div class="line">            os._exit(<span class="number">0</span>)</div><div class="line">        lock.release()  <span class="comment"># i是全局变量,所有线程操作更新i,需要释放锁</span></div><div class="line">i = <span class="number">100</span>; lock = threading.Lock()</div><div class="line"><span class="comment"># 开启10个线程</span></div><div class="line"><span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    <span class="comment"># 初始化线程对象</span></div><div class="line">    new_thread = threading.Thread(target=main_func, args=(k,))</div><div class="line">    <span class="comment"># 启动线程</span></div><div class="line">    new_thread.start()</div><div class="line"><span class="comment"># 结果展示</span></div><div class="line"><span class="number">0</span> :now left: <span class="number">99</span></div><div class="line"><span class="number">1</span> :now left: <span class="number">98</span></div><div class="line"><span class="number">2</span> :now left: <span class="number">97</span></div><div class="line">.  ...  ...  ..</div><div class="line"><span class="number">5</span> :now left: <span class="number">4</span></div><div class="line"><span class="number">6</span> :now left: <span class="number">3</span></div><div class="line"><span class="number">7</span> :now left: <span class="number">2</span></div><div class="line"><span class="number">8</span> :now left: <span class="number">1</span></div><div class="line"><span class="number">9</span> :now left: <span class="number">0</span></div><div class="line">Thread_id <span class="number">0</span> No more tickets</div></pre></td></tr></table></figure></p>
<p>这个示例来自<a href="http://www.cnblogs.com/vamei/archive/2012/10/11/2720042.html" target="_blank" rel="external">多线程售票以及同步</a>，全局变量i用来存储剩余票数，lock对象用来同步线程对i的修改，声明全局变量从而让多线程共享i和lock对象。Python中使用<code>threading.Thread</code>对象来实例化线程，用<code>threading.Lock</code>对象来实例化一个互斥锁（mutex）。</p>
<p>2、面向对象OOP式<br>从<code>Thread Class</code>类继承，创建一个新类，把线程执行的代码放到这个新Class中，相当于重新构造<code>__init__</code>和<code>run</code>方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> time,os</div><div class="line"></div><div class="line">Class NewThread(threading.Thread):</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tid, monitor)</span>:</span></div><div class="line">	    self.tid = tid</div><div class="line">	    self.monitor = monitor</div><div class="line">	    threading.Thread.__init__(self)</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">	    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	        self.monitor[<span class="string">'lock'</span>].acquire()</div><div class="line">            <span class="keyword">if</span> self.monitor[<span class="string">'tick'</span>] != <span class="number">0</span>:</div><div class="line">                self.monitor[<span class="string">'tick'</span>] = self.monitor[<span class="string">'tick'</span>] - <span class="number">1</span></div><div class="line">                <span class="keyword">print</span> self.tid,<span class="string">":now left:"</span>,self.monitor[<span class="string">'tick'</span>]</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">print</span> <span class="string">"Thread_id"</span>,self.tid,<span class="string">"No more tickets"</span></div><div class="line">                os._exit(<span class="number">0</span>)</div><div class="line">            self.monitor[<span class="string">'lock'</span>].release()</div><div class="line">monitor = &#123;<span class="string">'tick'</span>:<span class="number">100</span>, <span class="string">'lock'</span>:threading.Lock()&#125;</div><div class="line"><span class="comment"># 开启10个线程</span></div><div class="line"><span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    new_thread = NewThread(k, monitor)</div><div class="line">    new_thread.start()</div></pre></td></tr></table></figure></p>
<p>自定义了一个类NewThread，继承了<code>threading.Thread</code>类，并重载<code>run</code>方法来实现自定义的线程行为。</p>
<p>常用的多线程的方法就是上述看到的，<code>threading</code>还有其他的类对象和方法，详细请查看官方文档。</p>
<h4 id="python多线程的限制"><a href="#Python多线程的限制" class="headerlink" title="Python多线程的限制"></a>Python多线程的限制</h4><p>Python多线程有一个限制，叫“全局解释器锁（Global Interpreter Lock”）。这个锁的作用是任一时间只能有一个线程使用解释器。跟单CPU跑多个程序一个意思，多个任务轮着用。这个锁造成的困扰就是如果有一个计算密集型的线程占着CPU，其他的线程都将会等着，多线程此时就变成串行。具体是否使用这个多线程模块要考虑你所要面对的任务类型而决定。</p>
<p>接下来介绍<code>multiprocessing</code>多进程。</p>
<hr>
<h3 id="multiprocessing-多进程"><a href="#Multiprocessing-多进程" class="headerlink" title="Multiprocessing 多进程"></a>Multiprocessing 多进程</h3><p><code>multiprocessing --- Process-based “threading” Interface</code>。<br><code>multiprocessing</code>通过使用子进程而不是多线程来有效的避免Python的全局解释器锁（GIL）。因此，<code>multiprocessing</code>多进程模块允许充分利用机器上的多个CPU处理，与<code>threading</code>类似，使用同一套API接口。</p>
<hr>
<h3 id="multiprocessing-代码示例"><a href="#Multiprocessing-代码示例" class="headerlink" title="Multiprocessing 代码示例"></a>Multiprocessing 代码示例</h3><p>1、<a href="http://www.cnblogs.com/vamei/archive/2012/10/12/2721484.html" target="_blank" rel="external">对比<code>threading</code>和<code>multiprocessing</code></a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"></div><div class="line"><span class="comment"># worker function</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(sign, lock)</span>:</span></div><div class="line">    lock.acquire()</div><div class="line">    print(sign, os.getpid())</div><div class="line">    lock.release()</div><div class="line"><span class="comment"># Main</span></div><div class="line">print(<span class="string">'Main:'</span>,os.getpid())</div><div class="line"></div><div class="line"><span class="comment">## Multi-thread</span></div><div class="line">record = []; lock = threading.Lock()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">    thread = threading.Thread(target=worker,args=(<span class="string">'thread'</span>, lock))</div><div class="line">    thread.start()</div><div class="line">    record.append(thread) </div><div class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> record:</div><div class="line">    thread.join()</div><div class="line"><span class="comment"># Multi-thread多线程结果</span></div><div class="line">(<span class="string">'Main:'</span>, <span class="number">14800</span>)   <span class="comment"># 主进程PID</span></div><div class="line">(<span class="string">'thread'</span>, <span class="number">14800</span>)  <span class="comment"># 多线程PID均相同,符合GIL</span></div><div class="line">(<span class="string">'thread'</span>, <span class="number">14800</span>)</div><div class="line">(<span class="string">'thread'</span>, <span class="number">14800</span>)</div><div class="line">(<span class="string">'thread'</span>, <span class="number">14800</span>)</div><div class="line">(<span class="string">'thread'</span>, <span class="number">14800</span>)</div><div class="line"></div><div class="line"><span class="comment">## Multi-process</span></div><div class="line">record = []; lock = multiprocessing.Lock()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">    process = multiprocessing.Process(target=worker, args=(<span class="string">'process'</span>, lock))</div><div class="line">    process.start()</div><div class="line">    record.append(process)</div><div class="line"></div><div class="line"><span class="keyword">for</span> process <span class="keyword">in</span> record:</div><div class="line">    process.join()</div><div class="line"><span class="comment"># Multi-multiprocessing多线程结果</span></div><div class="line">(<span class="string">'Main:'</span>, <span class="number">18980</span>)  <span class="comment"># 主进程PID</span></div><div class="line">(<span class="string">'Main:'</span>, <span class="number">11304</span>)  <span class="comment"># 多进程PID均不相同,即开启不同的进程</span></div><div class="line">(<span class="string">'Main:'</span>, <span class="number">14064</span>)</div><div class="line">(<span class="string">'Main:'</span>, <span class="number">2160</span>)</div><div class="line">(<span class="string">'Main:'</span>, <span class="number">18624</span>)</div><div class="line">(<span class="string">'Main:'</span>, <span class="number">11760</span>)</div></pre></td></tr></table></figure></p>
<p>多线程与多进程在API接口上有很多相似的调用用法，当然在Python代码内部多进程与多线程有很大的关系，详情请查看官网文档。可以看到多进程的创建方式跟多线程完全一致，这也是标准库作者尽力保持的一致性。</p>
<p>2、Pipe和Queue</p>
<p>3、<a href="http://www.cnblogs.com/vamei/archive/2012/10/13/2722254.html" target="_blank" rel="external">Poll 进程池</a><br>进程池可以创建多个进程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(i)</span>:</span></div><div class="line">    <span class="keyword">print</span> i</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    pool = Pool(processes=<span class="number">10</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">100</span>):</div><div class="line">        pool.apply_async(func, args=(i,))</div><div class="line">    pool.close()</div><div class="line">    pool.join()</div></pre></td></tr></table></figure>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://docs.python.org/3/library/threading.html" target="_blank" rel="external">threading Python 3</a><br><a href="https://docs.python.org/3.6/library/multiprocessing.html" target="_blank" rel="external">multiprocessing Python 3</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/07/05/Python-Package：logging日志模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/05/Python-Package：logging日志模块/" itemprop="url">
                  Python Package：logging日志模块
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-05T21:49:54+08:00">
                2017-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="logging-模块"><a href="#logging-模块" class="headerlink" title="logging 模块"></a>logging 模块</h3><p><code>logging</code>模块是Python的日志工具，该模块定义的函数和类为应用程序提供了一个灵活的事件日志系统功能。<code>logging</code>模块提供了许多的功能和极强的使用灵活性。通常在一个成熟的产品中，都会有一个单独的日志模块供整个系统使用，我们也应该在编程的过程中保持正确的方式来记录日志信息。</p>
<p><code>logging</code>模块定义了下列四大基本类：</p>
<ol>
<li><code>Loggers</code> 提供针对应用程序代码直接使用的API接口。</li>
<li><code>Handlers</code> 发送日志记录到正确的应用目标。</li>
<li><code>Filters</code> 提供力度更细的工具用于决定输出哪些日志记录。</li>
<li><code>Formaters</code> 自定义最终输出的日志记录的格式。</li>
</ol>
<h4 id="logger-对象"><a href="#Logger-对象" class="headerlink" title="Logger 对象"></a>Logger 对象</h4><p>特别注意永远不要直接初始化<code>Loggers</code>，而应该通过模块级别的函数<code>logging.getLogger(name)</code>来得到Logger对象。</p>
<ol>
<li><code>logging.getLogger([name])</code>  返回一个logger实例，没指定name时返回root logger。只要name相同，返回的logger实例都是同一个而且只有一个。这意味着无需把logger实例在各个模块中传递即能通过name得到同一个logger实例。</li>
<li><code>logger.setLevel(lvl)</code> 为指定logger设置日志级别。</li>
<li><code>logger.addHandler(hdlr)</code> 通过handler对象可以把日志写到不同的位置。例如StreamHandler把日志输出到控制台，FileHandler输出文件，SMTPHandler输出到EMAIL邮件等等。Python提供多种类型的handler，详细参考官方文档。</li>
<li><code>logging.basicConfig([**kwargs])</code> 模块级别的函数来进行相关日志的配置。</li>
</ol>
<p>基础的用法如下所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> logging</div><div class="line"></div><div class="line"><span class="comment"># 创建一个logger</span></div><div class="line">logger = logging.getLogger(<span class="string">'my_logger'</span>)</div><div class="line">logger.setLevel(logging.DEBUG) <span class="comment"># 设置日志级别</span></div><div class="line"><span class="comment"># 创建一个Handler,用于写入日志文件</span></div><div class="line">file_handler = logging.FileHandler(<span class="string">'my_log.txt'</span>)</div><div class="line">file_handler.setLevel(logging.DEBUG) </div><div class="line"><span class="comment"># 创建一个Handler,用于输出到控制台屏幕</span></div><div class="line">console_handler = logging.StreamHandler()</div><div class="line">console_handler.setLevel(logging.DEBUG)</div><div class="line"><span class="comment"># 自定义handler的输出格式</span></div><div class="line">formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</div><div class="line">file_handler.setFormatter(formatter)</div><div class="line">console_handler.setFormatter(formatter)</div><div class="line"><span class="comment"># 为logger添加handler</span></div><div class="line">logger.addHandler(file_handler)</div><div class="line">logger.addHandler(console_handler)</div><div class="line">logging.debug(<span class="string">'This is debug log records.'</span>)</div><div class="line">logging.info(<span class="string">'This is info log records.'</span>)</div><div class="line">logging.warning(<span class="string">'This is warning reocrds.'</span>)</div></pre></td></tr></table></figure></p>
<h4 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h4><p>|CRITICAL|50| &gt; |ERROR|40| &gt; |WARNING|30| &gt; |INFO|20| &gt; |DEBUG|10| &gt; |NOTEST|0|</p>
<h4 id="如何正确的设置日志级别"><a href="#如何正确的设置日志级别" class="headerlink" title="如何正确的设置日志级别"></a>如何正确的设置日志级别</h4><p>在合适的场景使用合适的日志输出级别，这是我们使用<code>logging</code>模块的最高原则。因为日志的输出需要消耗性能，不能讲所有情况的日志都设置为DEBUG级别或其他级别，过多的日志也不便于进行分析和找出异常问题所在及其原因。</p>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用 DEBUG 日志级别</span></div><div class="line"><span class="comment"># 在开发调试阶段,通常使用debug日志级别,例如想要查看程序处理过程中的变量跟踪变化情况</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">processing</span><span class="params">(iterable_items)</span>:</span></div><div class="line">    <span class="keyword">for</span> i,item <span class="keyword">in</span> enumerate(iterable_items):</div><div class="line">        <span class="comment"># process code block</span></div><div class="line">        logger.debug(<span class="string">'&#123;0&#125; iteration, item=&#123;1&#125;'</span>.format(i, item))</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用 INFO 日志级别</span></div><div class="line"><span class="comment"># 在程序开发中,输出常规过程信息,通常使用info日志级别,例如查看程序处理过程中执行到哪一部分等info信息</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_process</span><span class="params">()</span>:</span></div><div class="line">    logger.info(<span class="string">'Starting the process at &#123;0&#125;.'</span>.format(date_time)</div><div class="line">    process.start()</div><div class="line">    logger.info(<span class="string">'The process has been started at &#123;0&#125;!'</span>.format(date_time))</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用 WARNING 级别</span></div><div class="line"><span class="comment"># 在一些重要的场景下输出warning日志级别,例如用户登录输入账号、密码错误时,输出WARNING级别日志,观察和分析日志以确认用户操作是否异常、蓄意暴力破解等等</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(user_name, password, ip_address)</span>:</span></div><div class="line">    <span class="keyword">if</span> user_name != USER_NAME <span class="keyword">and</span> password != PASSWORD：</div><div class="line">        logger.warn(<span class="string">'Login attempt to &#123;0&#125; from IP &#123;1&#125;'</span>.format(user_name, ip_address))</div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用 ERROR 级别</span></div><div class="line"><span class="comment"># 程序出现可预期的错误时,抛出一个错误日志.例如数据库连接失败,IO出错等</span></div><div class="line"></div><div class="line"><span class="comment"># 使用 CRITICAL 级别</span></div><div class="line"><span class="comment"># 在极个别特殊情况下使用,例如磁盘满,内存不够,CPU使用率爆满等等</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><p>1、示例代码将日志记录同时输出到文件和屏幕。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"></div><div class="line"><span class="comment"># logging日志基础配置</span></div><div class="line">logging.basicConfig(level=logging.DEBUG,</div><div class="line">                format=<span class="string">'%(asctime)s  %(filename)s [line:%(lineno)d]  %(levelname)s  %(message)s'</span>,</div><div class="line">                datefmt=<span class="string">'%a, %d %b %Y %H:%M:%S'</span>,</div><div class="line">                filename=os.path.join(os.path.dirname(__file__),<span class="string">'myapp.log'</span>),</div><div class="line">                filemode=<span class="string">'w'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 设置日志记录输出到屏幕</span></div><div class="line">console = logging.StreamHandler()</div><div class="line">console.setLevel(logging.INFO)  <span class="comment"># 日志级别</span></div><div class="line">formatter = logging.Formatter(<span class="string">'%(name)-12s: %(levelname)-8s %(message)s'</span>)</div><div class="line">console.setFormatter(formatter)</div><div class="line">logging.getLogger().addHandler(console)</div><div class="line"></div><div class="line">logging.debug(<span class="string">'This is debug log records.'</span>)</div><div class="line">logging.info(<span class="string">'This is info log records.'</span>)</div><div class="line">logging.warning(<span class="string">'This is warning reocrds.'</span>)</div></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 屏幕输出</span></div><div class="line">root        : INFO     This <span class="keyword">is</span> info message</div><div class="line">root        : WARNING  This <span class="keyword">is</span> warning message</div><div class="line"><span class="comment"># 日志文件输出</span></div><div class="line">Wed, <span class="number">05</span> Jul <span class="number">2017</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">42</span>  logging_Exc.py [line:<span class="number">20</span>]  DEBUG  This <span class="keyword">is</span> debug message</div><div class="line">Wed, <span class="number">05</span> Jul <span class="number">2017</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">42</span>  logging_Exc.py [line:<span class="number">21</span>]  INFO  This <span class="keyword">is</span> info message</div><div class="line">Wed, <span class="number">05</span> Jul <span class="number">2017</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">42</span>  logging_Exc.py [line:<span class="number">22</span>]  WARNING  This <span class="keyword">is</span> warning message</div></pre></td></tr></table></figure>
<p>2、重构示例<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> logging.handlers</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span><span class="params">()</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tag=<span class="string">""</span>, filename=<span class="string">"my_test.log"</span>, loglevel=<span class="number">1</span>, toConsole=True, toFile=True)</span>:</span></div><div class="line">        self.logger = logging.getLogger(tag)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.logger.handlers:</div><div class="line">            format_dict = &#123;</div><div class="line">               <span class="number">1</span> : logging.Formatter(<span class="string">'[%(asctime)s][%(filename)s,%(funcName)s:%(lineno)s][%(name)s]: %(message)s'</span>),</div><div class="line">               <span class="number">2</span> : logging.Formatter(<span class="string">'[%(asctime)s][%(filename)s,%(funcName)s:%(lineno)s][%(name)s]: %(message)s'</span>),</div><div class="line">               <span class="number">3</span> : logging.Formatter(<span class="string">'[%(asctime)s][%(filename)s,%(funcName)s:%(lineno)s][%(name)s]: %(message)s'</span>),</div><div class="line">               <span class="number">4</span> : logging.Formatter(<span class="string">'[%(asctime)s][%(filename)s,%(funcName)s:%(lineno)s][%(name)s]: %(message)s'</span>),</div><div class="line">               <span class="number">5</span> : logging.Formatter(<span class="string">'[%(asctime)s][%(filename)s,%(funcName)s:%(lineno)s][%(name)s]: %(message)s'</span>)</div><div class="line">            &#125;</div><div class="line">            formatter = format_dict[int(loglevel)]</div><div class="line">            self.logger.setLevel(logging.DEBUG)</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                <span class="keyword">if</span> toFile:</div><div class="line">                    fh = logging.FileHandler(filename)</div><div class="line">                    fh.setLevel(logging.DEBUG)</div><div class="line">                    fh.setFormatter(formatter)</div><div class="line">                    self.logger.addHandler(fh)</div><div class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                <span class="keyword">print</span> e</div><div class="line">                </div><div class="line">            <span class="keyword">if</span> toConsole:</div><div class="line">                ch = logging.StreamHandler()</div><div class="line">                ch.setLevel(logging.DEBUG)</div><div class="line">                ch.setFormatter(formatter)</div><div class="line">                self.logger.addHandler(ch)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getlogger</span><span class="params">(self)</span>:</span>  </div><div class="line">        <span class="keyword">return</span> self.logger</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">    Logger(tag=<span class="string">"_mytest"</span>).getlogger().debug(<span class="string">"This is a debug log record."</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    Logger(tag=<span class="string">"_mytest"</span>).getlogger().debug(<span class="string">"This is a debug log record."</span>)</div><div class="line">    func()</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://docs.python.org/2/library/logging.html" target="_blank" rel="external">logging Python 2.7官方文档</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/25/机器学习：线性回归/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/25/机器学习：线性回归/" itemprop="url">
                  机器学习：线性回归
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-25T01:14:51+08:00">
                2017-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因Hexo的MathJax插件与MarkDown在编辑数学公式时发生冲突，无法正常上传MarkDown文件，所有直接提PDF链接。</p>
<p><a href="http://on58f12qv.bkt.clouddn.com/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%EF%BC%9A%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92.pdf" target="_blank" rel="external">http://on58f12qv.bkt.clouddn.com/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%EF%BC%9A%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92.pdf</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/23/数学术语：正态分布/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/23/数学术语：正态分布/" itemprop="url">
                  数学术语：正态分布
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-23T21:16:16+08:00">
                2017-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="正态分布"><a href="#正态分布" class="headerlink" title="正态分布"></a>正态分布</h3><p>正态分布（Normal Distribution），也称“常态分布”，又名高斯分布（Gaussian Distribution）。正态分布式一个在各个领域内都非常重要的概率分布，在统计学的许多方面有重大的影响力。正态曲线呈钟型，两头低、中间高，左右对称。<br><img src="http://on58f12qv.bkt.clouddn.com/%E4%B8%89%E7%BB%B4%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83.jpg" alt="三维正态分布|center"></p>
<p>若随机变量$X$服从一个数学期望为$μ$、方差为$σ^2$的正态分布，记为$N(μ,σ^2)$。其概率密度函数为正态分布的期望$μ$决定了其位置，方差$σ^2$决定了分布的幅度。当$μ=0,σ^2=1$时是标准正态分布。</p>
<hr>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>正态分布具有两个参数$μ$和$σ^2$的连续随机变量的分布，参数$μ$是服从正态分布的随机变量的均值，参数$σ^2$是随机变量的方差。服从正态分布的随机变量的概率规律为与$μ$越近的值的概率越大，离$μ$越远的值的概率越小。$σ^2$越小，分布越集中在$μ$附近，$σ^2$越大，分布月分散。</p>
<p>正态分布的密度函数的特点是：关于$μ$对称，在$μ$处达到最大值，在正负无穷处取值为0，在$μ±σ$的位置处有拐点。<br><img src="http://on58f12qv.bkt.clouddn.com/%E4%BA%8C%E7%BB%B4%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83.jpg" alt="二维正态分布|center"></p>
<hr>
<h3 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h3><p>集中性：正态分布的高峰位于均值$μ$所在的位置；<br>对称性：正态分布曲线以均值$μ$为中心左右对称，曲线两端永远不与横轴相交；<br>均匀变动性：在均值$μ$处开始，分别向左右两侧逐渐均匀下降；<br>概率特性：横轴与正态曲线之间的面积恒等于1。正态曲线下，横轴区间$(μ-σ，μ+σ)$内的面积为68.268949%，横轴区间$(μ-1.96σ，μ+1.96σ)$内的面积为95.449974%，横轴区间$(μ-2.58σ，μ+2.58σ)$内的面积为99.730020%。<br><img src="http://on58f12qv.bkt.clouddn.com/%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83%E9%9D%A2%E7%A7%AF%E6%A6%82%E7%8E%87.jpg" alt="正态分布面积概率|center"></p>
<hr>
<h3 id="概率密度函数"><a href="#概率密度函数" class="headerlink" title="概率密度函数"></a>概率密度函数</h3><p>正态分布的概率密度函数为：<br><img src="http://on58f12qv.bkt.clouddn.com/%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6%E5%87%BD%E6%95%B0.jpg" alt="正态分布概率密度函数|center"></p>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="http://www.baike.com/wiki/%E9%AB%98%E6%96%AF%E5%88%86%E5%B8%83" target="_blank" rel="external">http://www.baike.com/wiki/%E9%AB%98%E6%96%AF%E5%88%86%E5%B8%83</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/19/数据需求-活跃用户统计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/19/数据需求-活跃用户统计/" itemprop="url">
                  [数据需求] 活跃用户统计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-19T21:04:44+08:00">
                2017-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求简介"><a href="#需求简介" class="headerlink" title="需求简介"></a>需求简介</h3><p>首先，简单的聊一下“活跃用户”这个概念。</p>
<p>在不同的行业、不同的公司、不同的人眼中，甚至在上述各个对象的不同发展阶段，“活跃用户”的定义各不相同，且很可能在定义字面上的差异非常明显。换句话说，“活跃用户”的定义并没有一个行业的统一标准，更加趋向于特殊化和个例化。因此不要盲从的去比较关于“活跃用户”的概念，只要是适合自己公司的，就是最好概念定义的。</p>
<p>定义“活跃用户”概念，其关键核心是围绕自己的产品战略和实际情况，进行跟踪分析用户<strong>有效的</strong>体验、参与、使用了我们的产品的用户活跃行为。</p>
<p>这些运营的需求是，将活跃用户定义为“在自然日期内，已经连续七天有效调用服务器API接口的用户”，将条件推广的定义即“连续N日内”。</p>
<p>连续活跃七天，我们可以先初步估算下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">假设：某个用户正常在自然日期内调用的概率是<span class="number">0.5</span>；</div><div class="line"></div><div class="line">概率：连续<span class="number">7</span>天内有效调用API接口的概率是 (<span class="number">0.5</span>)^<span class="number">7</span> ≈ <span class="number">0.78</span>%</div><div class="line"></div><div class="line">分析：当然实际的产品情况并非是简单的相互独立概率计算方式，这里的<span class="number">0.78</span>%仅仅是一个参考，单从概率值上来讲结论近几乎乎绝大多数用户都不太可能连续<span class="number">7</span>天内都活跃，虽然实际的概率模型并非每日活跃概率相互独立。</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="误区"><a href="#误区" class="headerlink" title="误区"></a>误区</h3><p>常见的活跃定义，可以是用户某个（系列）行为、打开APP停留时间、体验深入等等，因不同行业、不同产品，我们不展开说明。下面主要聊一下不能计入活跃的行为。</p>
<ol>
<li>用户在操作过程中，肯定存在<strong>误点击</strong>行为，这种类型不应算作活跃计数；</li>
<li>对于消息推送类，用户很可能因你推送消息的吸引而打开应用，但停留<strong>时间极短</strong>，就跳出结束体验。实际上这种情况是造成了不良用户体验的，这种情况也不算做活跃计数。</li>
<li>某些非用户正常行为，属于作弊行为的。这种情况也不应该算作活跃计数。（作弊行为识别和反作弊，这是另外一个庞大的话题了。）</li>
</ol>
<p>关于“活跃用户”的概念，暂时就聊这么多。下面回归到实现运营的需求这个正轨上面。</p>
<hr>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>Python 2.7 和 MySQL</p>
<h4 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h4><p>实现逻辑分为“全量更新”和“增量更新”两部分，拿“全量更新”来说明，将每天活跃的用户存储为dict字典，key为日期，value为活跃用户数；在<code>defaultdict(set)</code>数据结构中依次选择连续7日的活跃用户进行交集运算。实现比较简单，示例代码如下所示。</p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"></div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date,datetime,timedelta</div><div class="line"><span class="keyword">from</span> mysqlutil <span class="keyword">import</span> MysqlUtil</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Increment_Update</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Full_Update</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, section, out_file_name)</span>:</span></div><div class="line">        self.config_file = <span class="string">'mysql.config'</span></div><div class="line">        self.section = section</div><div class="line">        self.out_file_name = out_file_name</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rawData</span><span class="params">(self, left_date=<span class="number">20161220</span>, valid_pv=<span class="number">0</span>)</span>:</span></div><div class="line">        config_path = os.path.join(os.path.dirname(__file__), self.config_file)</div><div class="line">        Sql = <span class="string">'''</span></div><div class="line">              SELECT access_day, apikey</div><div class="line">              FROM active_log_table</div><div class="line">              WHERE access_day &gt;= &#123;0&#125; AND access_day &lt; &#123;1&#125;</div><div class="line">              AND valid_pv &gt; &#123;2&#125; '''.format(left_date, int(date.today().strftime(<span class="string">"%Y%m%d"</span>)), valid_pv)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            MySQL_DB = MysqlUtil(config_path, self.section)</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The mysql.config path get wrong.Error information:&#123;0&#125;."</span>.format(e)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            data = MySQL_DB.select(Sql)</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</div><div class="line">                <span class="keyword">print</span> <span class="string">"The return Data is None. Please check the data source."</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">return</span> data</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reconstruct</span><span class="params">(self, data)</span>:</span></div><div class="line">        data_result = defaultdict(set)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The self.data is None. Please check the self.data."</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> data:</div><div class="line">                <span class="keyword">if</span> <span class="keyword">not</span> line:</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">                dt, api_key = line</div><div class="line">                data_result[datetime.strptime(str(dt), <span class="string">"%Y%m%d"</span>)].add(api_key)</div><div class="line">        <span class="keyword">return</span> data_result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">activeRobotCnt</span><span class="params">(self, data_result, focus_date, N=<span class="number">7</span>)</span>:</span></div><div class="line">        <span class="keyword">if</span> focus_date <span class="keyword">not</span> <span class="keyword">in</span> data_result:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The focus_data &#123;0&#125; is out of self.data date range."</span>.format(focus_date)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            query_data = locals()</div><div class="line">            code_str = <span class="string">'len( '</span></div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</div><div class="line">                query_data[<span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i)] = data_result[focus_date - timedelta(days=i)]</div><div class="line">                <span class="keyword">if</span> i &lt;= N<span class="number">-2</span>:</div><div class="line">                    code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' &amp; '</span></div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' )'</span></div><div class="line">            <span class="keyword">return</span> eval(code_str)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">saveInfo</span><span class="params">(self, focus_date, active_cnt)</span>:</span></div><div class="line">        out_file_path = os.path.join(os.path.dirname(__file__), self.out_file_name)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">with</span> codecs.open(out_file_path, mode=<span class="string">'a+'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> outFile:</div><div class="line">                outFile.write(focus_date.strftime(<span class="string">"%Y%m%d"</span>) + <span class="string">'\t'</span> + str(active_cnt) + <span class="string">'\n'</span>)</div><div class="line">            <span class="keyword">print</span> <span class="string">"The process has been completed successfully!"</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">"The Error information &#123;0&#125;"</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    instance = Full_Update(<span class="string">'report'</span>, <span class="string">'result-0619.txt'</span>)</div><div class="line"></div><div class="line">    data = instance.rawData(left_date=<span class="number">20161220</span>, valid_pv=<span class="number">0</span>)</div><div class="line">    data_result = instance.reconstruct(data)</div><div class="line"></div><div class="line">    query_date = datetime(<span class="number">2017</span>,<span class="number">1</span>,<span class="number">1</span>)</div><div class="line">    today = datetime.today()</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> query_date &lt; today:</div><div class="line">        active_cnt = instance.activeRobotCnt(data_result, query_date)</div><div class="line">        instance.saveInfo(query_date, active_cnt)</div><div class="line">        <span class="comment"># print str(query_date) + '\t' + str(active_cnt)</span></div><div class="line">        query_date += timedelta(days=<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<h3 id="动态变量"><a href="#动态变量" class="headerlink" title="动态变量"></a>动态变量</h3><p>上面代码中比较重要的内容就是处理“连续七日内活跃用户数”的计算，因为考虑到代码逻辑的通用性，将其写成“连续N日活跃用户”的实现方式。在这里就遇到“动态变量”这个问题，假如我们要求“30日”，难道我们要写30个变量吗？而且，随着需求的变化，可能今天需要30日，明天需要2日，总不能手动修改变量赋值吧。因此，这里使用比较典型的“动态变量”来实现。</p>
<p>动态变量的创建解决了，那么我们同样面临的是动态变量的调用的问题。此处的解决方案是将待执行的代码拼接为字符串，通过<code>eval()</code>函数来执行并返回计算值。<code>eval()</code>方法使用的不算多，这算它的一个很好的使用场景。</p>
<p>关键的知识点是<code>locals()</code>和<code>eval()</code>两块内容。</p>
<h4 id="locals"><a href="#locals" class="headerlink" title="locals()"></a><code>locals()</code></h4><p><code>locals()</code>是内置函数，它以字典的方式来访问局部和全局变量。注意，动态创建字典会带来额外开销。</p>
<p>动态创建变量：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">query_data = locals()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(N):</div><div class="line">     query_data[<span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i)] = data_result[focus_date - timedelta(days=i)]</div><div class="line">     <span class="comment"># 动态变量创建完成,在代码中可以通过对应变量名来调用</span></div></pre></td></tr></table></figure></p>
<h4 id="eval"><a href="#eval" class="headerlink" title="eval()"></a><code>eval()</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ......</span></div><div class="line"><span class="comment"># ......</span></div><div class="line">query_data = locals()</div><div class="line">code_str = <span class="string">'len( '</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(N):</div><div class="line">    query_data[<span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i)] = data_result[focus_date - timedelta(days=i)]</div><div class="line">    <span class="keyword">if</span> i &lt;= N<span class="number">-2</span>:</div><div class="line">        code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' &amp; '</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        code_str += <span class="string">'activeRobotCnt_&#123;0&#125;'</span>.format(i) + <span class="string">' )'</span></div><div class="line">	<span class="comment"># 动态拼接动态字符串过程完成</span></div><div class="line"><span class="keyword">return</span> eval(code_str)</div></pre></td></tr></table></figure>
<p>到此，我们再也不用担心运营随时变更需求啦！甚至可以给提供从连续登陆2日到N日的定义的活跃用户数据。只需要调整一个参数即可，再也不用为频繁调整代码、变量名命名而头疼啦！</p>
<hr>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>代码优化</li>
<li>可做一个“N日连续调用”的活跃用户变化表（预期类似留存曲线，因为活跃&amp;流失&amp;留存必然不是相互独立的）</li>
</ol>
<hr>
<h3 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h3><p>最后计算出运营定义下的活跃用户量之后，又统计了截止当前的注册用户，占比平均约为“0.0075（0.75%）”，计算的结果与我们当初的预期相差不多。从概率的角度来看，这部分活跃用户已经可以定位为超核心用户啦。</p>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://docs.python.org/2/library/functions.html#locals" target="_blank" rel="external">https://docs.python.org/2/library/functions.html#locals</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/18/《Intermediate-Python》-读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/18/《Intermediate-Python》-读书笔记/" itemprop="url">
                  《Intermediate Python》 读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-18T02:44:12+08:00">
                2017-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="intermediate-python简介"><a href="#《Intermediate-Python》简介" class="headerlink" title="《Intermediate Python》简介"></a>《Intermediate Python》简介</h3><p>《Intermediate Python》即“Python 进阶”，首先感谢英文原著作者 <a href="https://pythontips.com/" target="_blank" rel="external">@Muhammad Yasoob Ullah Khalid</a>《Intermediate Python》的杰出贡献，请支持原著的伙伴购买正版书籍。</p>
<p><a href="https://github.com/yasoob/intermediatePython" target="_blank" rel="external">《Intermediate Python》Git地址</a></p>
<hr>
<h3 id="python-进阶简介"><a href="#《Python-进阶》简介" class="headerlink" title="《Python 进阶》简介"></a>《Python 进阶》简介</h3><p>《Python进阶》是《Intermediate Python》的中文译本，由辛勤的译者：老高 @spawnris  |  刘宇 @liuyu  |  明源 @muxueqz  |  大牙 @suqi  |  蒋委员长 @jiedo  翻译，感谢这些无私的译者的贡献。</p>
<p><a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/index.html" target="_blank" rel="external">《Python 进阶》在线阅读地址</a><br><img src="http://on58f12qv.bkt.clouddn.com/Python%E8%BF%9B%E9%98%B6%20%E6%A0%B7%E4%BE%8B.png" alt="页面示意截图"></p>
<hr>
<h3 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h3><p>Python语言对绝大多数使用者而言，是一门入门较易、精通较难的高级编程语言。引用译者对原著的评价“本书作者的行文方式有着科普作家的风范，那就是能将晦涩难懂的技术用比较清晰简洁的方式进行呈现，深入浅出的风格在每个章节的讨论中都得到了体现”。有些Python的知识点的确是循序渐进、深入浅出的讲解。</p>
<hr>
<h4 id="书籍目录"><a href="#书籍目录" class="headerlink" title="书籍目录"></a>书籍目录</h4><ul>
<li>*args 和 **kwargs 魔法变量</li>
<li>调试 Debugging</li>
<li>生成器 Generators    ※※</li>
<li>Map和Filter    ※※</li>
<li>set 数据结构</li>
<li>三元运算符    ※</li>
<li><a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/index.html" target="_blank" rel="external">装饰器     ※※※</a></li>
<li>Global和Return</li>
<li>对象变动 Mutation</li>
<li>__slots__魔法</li>
<li>虚拟环境    ※※</li>
<li>容器 Collections    ※※</li>
<li>枚举 Enumerate    ※※</li>
<li>对象自省</li>
<li>推导式    ※※</li>
<li>异常    ※※</li>
<li>lambda表达式    ※※※</li>
<li>一行式    ※</li>
<li>For-Else    ※</li>
<li>使用C扩展</li>
<li>open函数</li>
<li>目标Python2+3</li>
<li>协程    ※※</li>
<li>函数缓存</li>
<li>上下文管理器</li>
<li><a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/seealso.html" target="_blank" rel="external">推荐阅读 ※※※※</a><blockquote>
<p>1.<br>在基本目录中，依据我个人的使用和理解情况，依次对不同重要程度的内容以“※”进行标记。其中<strong>装饰器</strong>知识点部分尤其清晰明了，读者可以自行阅读体验。<br>2.<br>在推荐阅读详情页中给的资源也非常优质，请读者自行跳转阅读体验。</p>
</blockquote>
</li>
</ul>
<hr>
<h4 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h4><p>此处内容，是我个人读后感觉需要记录一下的知识点或内容，并不是以Python知识点的重要程度来决定的。</p>
<ol>
<li><p>*args 和 *<em>kwargs 魔法变量<br>在函数里同时使用所有这三种参数，顺序是`some_func(fargs, </em>args, **kwargs)`</p>
</li>
<li><p>迭代器（iterators）<br>迭代器是一个让程序员可以遍历的容器对象。迭代器包含三个部分：可迭代对象（iterable）、迭代器（iterator）、迭代（iteration）。<br><strong>可迭代对象（iterable）</strong> ：python中任意对象，只要定义了可返回一个迭代器的<code>__iter__</code>方法，或者定义可支持下标索引<code>__getitem__</code>方法，那么它就是一个可迭代对象。<br><strong>迭代器（Iterator）</strong>：任意对象，只要定义了<code>next</code>或<code>__next__</code>方法就是一个迭代器。<br><strong>迭代（Iteration）</strong>：从某个地方取出一个元素的过程。当使用一个循环来遍历某个东西时，这个过程本身就叫迭代。</p>
</li>
<li><p>生成器（Generators）<br>生成器也是一种迭代器，但是你只能对其迭代一次。因为它们并没有把所有的值存在内存中，而是在运行时生成值。通过遍历来使用它们，大多数生成器是以函数来实现的，但它们并不返回一个值，而是yield生出一个值。<br>生成器最佳应用场景是：你不想同一时间将所有计算出来的大量结果集分配到内存当中，特别是结果集里还包含循环（会消耗大量资源）。Python2中的标准库函数都会返回列表，而Python3都修改成了返回生成器，因为生成器占用更少的资源。</p>
</li>
</ol>
<p>生成器的典型示例就是计算斐波那契数列：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fibon</span><span class="params">(n)</span>:</span></div><div class="line">    a = b = <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</div><div class="line">        <span class="keyword">yield</span> a </div><div class="line">        a, b = b, a+b</div><div class="line"><span class="comment"># use it like this</span></div><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> fibon(<span class="number">1000000</span>):</div><div class="line">    print(x)</div><div class="line"><span class="comment"># 使用生成器的方式可以不用担心它会使用大量资源。</span></div><div class="line"></div><div class="line"><span class="comment"># 如果按照下列来实现的话：</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fibon</span><span class="params">(n)</span>:</span></div><div class="line">    a = b = <span class="number">1</span></div><div class="line">    result = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</div><div class="line">        result.append(a)</div><div class="line">        a, b = b, a+b</div><div class="line">    <span class="keyword">return</span> result</div><div class="line"><span class="comment"># 可能在计算很大的输入参数时，耗尽所有的资源。</span></div></pre></td></tr></table></figure></p>
<ol>
<li>Map和Filter<br>适用于函数式编程，关键是灵活应用这两个函数使代码更加Pythonic。<br><strong>map</strong>：将一个函数映射到一个输入列表的所有元素上。<code>map(function_to_apply, list_of_inputs)</code>。通常配合匿名函数（lambdas）来使用。<br>例如：<code>suqared = list(map(lambda x:x**2, [1,2,3,4]))</code>。<br>下面展示一个特殊的例子，将map函数应用于一列表的函数。<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">multiply</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> x*x</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + x</div><div class="line"></div><div class="line">funcs = [multiply, add]</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">    value = list(map(<span class="keyword">lambda</span> x:x(i), funcs))</div><div class="line">    print(value)</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># [0, 0]</span></div><div class="line"><span class="comment"># [1, 2]</span></div><div class="line"><span class="comment"># [4, 4]</span></div><div class="line"><span class="comment"># [9, 6]</span></div><div class="line"><span class="comment"># [16, 8]</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>filter</strong>：filter能创建一个列表，其中每个元素都是对应一个函数能返回True。例如<code>less_then_zero = list(filter(lambda x:x&lt;0, range(-5,5)))</code></p>
<ol>
<li>set 集合数据结构<br>集合最广泛的运用就是高效去重和交并补集合运算。</li>
</ol>
<p>例如：<code>duplicates = set([x for x in some_list if some_list.count(x) &gt; 1])</code></p>
<ol>
<li><p>三元运算符<br>即条件表达式。伪代码示例<code>condition_is_true if condition else condition_is_false</code>。主要用在简单的一行快速判断，而不是使用复杂的if语句。</p>
</li>
<li><p>装饰器（Decorators）<br>这本书里对我个人启发最深的一个知识点—就是装饰器。在日常的工作中，很少的用到装饰器。但它是Python的一个重要部分，是Python的魔法功能。<br>装饰器是修改其他函数的功能的函数，有助于让代码更简短、更Pythonic。初学者首先要懂得“哪些区域里装饰器可以让你的代码更简洁”。</p>
</li>
</ol>
<p>原作者将这个较难掌握的概念，逐层分解，一步步深入讨论装饰器的每个步骤。下面，所有示例和解释均摘要于《Python进阶》一书。</p>
<blockquote>
<p>7.1 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/everything_is_object.html" target="_blank" rel="external">一切皆对象</a><br>python中的函数也是对象，可以讲一个函数赋值给一个变量。使用形如<code>func()</code>，带括号的是在调用函数，不带括号<code>func</code>只是python函数对象。 </p>
<p>7.2 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/def_func_in_func.html" target="_blank" rel="external">在函数中定义函数</a><br>在python中可以在一个函数中定义另一个函数，如下示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hi</span><span class="params">(name=<span class="string">'yasoob'</span>)</span>:</span></div><div class="line">    print(<span class="string">"now you are inside the hi() function"</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">greet</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the greet() function"</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">welcome</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the welcome() function"</span></div><div class="line">	print(greet())</div><div class="line">	print(welcome())</div><div class="line">	print(<span class="string">"now you are back in the hi() function"</span>)</div><div class="line"></div><div class="line">hi()</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># now you are inside the hi() function</span></div><div class="line"><span class="comment"># now you are in the greet() function</span></div><div class="line"><span class="comment"># now you are in the welcome() function</span></div><div class="line"><span class="comment"># now you are back in the hi() function</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>这个例子重点展示了无论何时你调用<code>hi()</code>函数，在<code>hi()</code>内的<code>greet()</code>和<code>welcome()</code>函数将会依次被调用。但是，<code>greet()</code>和<code>welcome()</code>函数在<code>hi()</code>函数之外是不能访问的。</p>
<blockquote>
<p>7.3 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/return_func_in_func.html" target="_blank" rel="external">从函数中返回函数</a><br>在嵌套的函数中，可以将嵌套的函数作为输出返回。如下示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hi</span><span class="params">(name=<span class="string">'yasoob'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">greet</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the greet() function"</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">welcome</span><span class="params">()</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"now you are in the welcome() function"</span></div><div class="line">    <span class="keyword">if</span> name == <span class="string">'yasoob'</span>:</div><div class="line">        <span class="keyword">return</span> greet</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> welcome</div><div class="line">a = hi()</div><div class="line">print(a)</div><div class="line"><span class="comment"># output  a是一个函数对象，不是在调用a函数</span></div><div class="line"><span class="comment"># &lt;function greet at 0x7f2143c01500&gt;</span></div><div class="line"></div><div class="line">print(a())</div><div class="line"><span class="comment"># output  调用 a函数</span></div><div class="line"><span class="comment"># now you are in the greet() function</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>在<code>if/else</code>语句中我们返回<code>greet</code>和<code>welcome</code>。而不是<code>greet()</code>和<code>welcome()</code>。为什么那样？因为当你把一对小括号放在后面，这个函数就会执行；如果你放括号在它后面，那它可以被到处传递，并且可以赋值给别的变量而不去执行它。</p>
<blockquote>
<p>7.4 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/func_as_argument.html" target="_blank" rel="external">将函数作为参数传递给另一个函数</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hi</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'hi yasoob!'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">doSomethingBeforHi</span><span class="params">(func)</span>:</span></div><div class="line">    print(<span class="string">"I am doing some boring work before executing hi()"</span>)</div><div class="line">    print(func())</div><div class="line">doSomethingBeforeHi(hi)</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># I am doing some boring work before executing hi()</span></div><div class="line"><span class="comment"># hi yasoob!</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>到这里，其实有一些装饰器小影子啦。<code>hi()</code>函数作为参数传递给<code>doSomethingBeforHi()</code>函数，在<code>print(func())</code>中被调用形式参数<code>func()=hi()</code>并且被打印输出。<br>现在已经具备所有必需知识，来进一步学习装饰器真正是什么了。装饰器让你在一个函数的前后去执行代码。</p>
<blockquote>
<p>7.5 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/decorators/your_first_decorator.html" target="_blank" rel="external">你的第一个装饰器</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_new_decorator</span><span class="params">(a_func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapTheFunction</span><span class="params">()</span>:</span></div><div class="line">        print(<span class="string">"I am doing some boring work befor executing a_func()"</span>)</div><div class="line">        a_func()</div><div class="line">        print(<span class="string">"I am doing some boring work after executing a_func()"</span>)</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> wrapTheFunction</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_function_requiring_decoration</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"I am the function which need some decoration to remove my foul smell"</span>)</div><div class="line"></div><div class="line">a_function_requiring_decoration()</div><div class="line"><span class="comment"># output</span></div><div class="line"><span class="comment"># I am the function which needs some decoration to remove my foul smell</span></div><div class="line"></div><div class="line">a_function_requiring_decoration = a_new_decorator(a_function_requiring_decoration)</div><div class="line"><span class="comment"># now a_function_requiring_decoration is wrapped by wrapTheFunction()</span></div><div class="line"></div><div class="line">a_function_requiring_decoration ()</div><div class="line"><span class="comment">#outputs:I am doing some boring work before executing a_func()</span></div><div class="line"><span class="comment">#        I am the function which needs some decoration to remove my foul smell</span></div><div class="line"><span class="comment">#        I am doing some boring work after executing a_func()</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>这正是装饰器做的事情，它们封装一个函数，并且修改它的行为。你也许会疑惑，在代码里并没有使用‘@’符号？<br>那只是一个简短的方式来生成一个被装备的函数。下面是使用“@”来重写之前的代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@a_new_decorator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_function_requiring_decoration</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""Hey you! Decorate me!"""</span></div><div class="line">    print(<span class="string">"I am the function which needs some decoration to remove my foul smell"</span>)</div><div class="line"></div><div class="line">a_function_requiring_decoration()</div><div class="line"><span class="comment">#outputs: I am doing some boring work before executing a_func()</span></div><div class="line"><span class="comment">#         I am the function which needs some decoration to remove my foul smell</span></div><div class="line"><span class="comment">#         I am doing some boring work after executing a_func()</span></div></pre></td></tr></table></figure></p>
<p><strong>装饰器代码结构&lt;蓝本规范&gt;：</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> function <span class="keyword">import</span> wraps</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decorator_name</span><span class="params">(f)</span>:</span></div><div class="line"><span class="meta">    @wraps(f)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorated</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> can_run:</div><div class="line">            <span class="keyword">return</span> <span class="string">"Function will not run"</span></div><div class="line">        <span class="keyword">return</span> f(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> decorated</div><div class="line"></div><div class="line"><span class="meta">@decorator_name</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"Function is running"</span></div><div class="line"></div><div class="line">can_run = <span class="keyword">True</span></div><div class="line">print(func())</div><div class="line"><span class="comment"># Output: Function is running</span></div><div class="line"></div><div class="line">can_run = <span class="keyword">False</span></div><div class="line">print(func())</div><div class="line"><span class="comment"># Output: Function will not run</span></div></pre></td></tr></table></figure></p>
<p>注意，@wraps接受一个函数来进行装饰，并加入了复制函数名称、注释文档、参数列表等等的功能。可以让我们在装饰器里面访问在装饰器之前的函数的属性。</p>
<p><em>现在为止，个人对python的装饰器有一个大致的概念，但是还无法熟练使用和彻底理解装饰器的功能、写法、运用场景，还需要多回顾、多写、多体会</em></p>
<ol>
<li>虚拟环境（virtualenv）<br>创建独立的Python环境，而不是在全局安装所依赖的模块。<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install virtualenv</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>$ virtualenv myproject</code>  在“myproject”文件夹创建隔离环境；<br><code>$ source bin/activete</code>  激活这个隔离的环境；<br><code>$ deactivate</code> 退出隔离环境。</p>
<ol>
<li><p>容器（collections）<br>非常重要的数据结构，必须掌握的内置标准库。直接阅读collection模块的<a href="https://docs.python.org/3.6/library/collections.html" target="_blank" rel="external">官方文档</a>。</p>
</li>
<li><p>枚举<br>枚举（<a href="https://www.python.org/dev/peps/pep-0279/" target="_blank" rel="external">enumerate</a>）是Python内置函数。enumerate接受可选参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">enumerate</span><span class="params">(collection)</span>:</span></div><div class="line">   <span class="string">'Generates an indexed series:  (0,coll[0]), (1,coll[1]) ...'</span></div><div class="line">   i = <span class="number">0</span>  <span class="comment"># optional argument</span></div><div class="line">   it = iter(collection)</div><div class="line">   <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">      <span class="keyword">yield</span> (i, it.next())</div><div class="line">      i += <span class="number">1</span></div></pre></td></tr></table></figure>
</li>
<li><p>对象自省<br>自省（introspection），在计算机领域是指在运行时来判断一个对象的类型的能力。dir，返回一个对象所拥有的属性和方法的列表。深入了解可查看<a href="https://docs.python.org/3.6/library/inspect.html" target="_blank" rel="external"><code>inspect</code>模块</a></p>
</li>
<li><p>推导式（comprehensions）<br>列表list、字典dict、集合set推导式。</p>
</li>
<li><p>异常<br>异常处理时一种艺术，是必须要掌握的代码结构。try/except/finally语句块结构，可能触发异常的代码放到try语句块，而处理异常的代码放在except语句块，它会在try从句中的代码触发异常时执行，finally语句块是不管异常是否触发都将会被执行，一般用来在脚本执行之后做清理工作。</p>
</li>
</ol>
<p>可处理多个异常，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    file = open(<span class="string">'test.txt'</span>, <span class="string">'rb'</span>)</div><div class="line"><span class="keyword">except</span> (IOError, EOFError) <span class="keyword">as</span> e:</div><div class="line">    print(<span class="string">"An error occurred. &#123;&#125;"</span>.format(e.args[<span class="number">-1</span>]))</div><div class="line"></div><div class="line"><span class="comment"># 或</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    file = open(<span class="string">'test.txt'</span>, <span class="string">'rb'</span>)</div><div class="line"><span class="keyword">except</span> EOFError <span class="keyword">as</span> e:</div><div class="line">    print(<span class="string">"An EOF error occurred."</span>)</div><div class="line">    <span class="keyword">raise</span> e</div><div class="line"><span class="keyword">except</span> IOError <span class="keyword">as</span> e:</div><div class="line">    print(<span class="string">"An error occurred."</span>)</div><div class="line">    <span class="keyword">raise</span> e</div><div class="line"></div><div class="line"><span class="comment"># 下面这种方式会捕获所有异常</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    file = open(<span class="string">'test.txt'</span>, <span class="string">'rb'</span>)</div><div class="line"><span class="keyword">except</span> Exception:</div><div class="line">    <span class="comment"># 打印一些异常日志，如果你想要的话</span></div><div class="line">    <span class="keyword">raise</span></div></pre></td></tr></table></figure></p>
<ol>
<li><p>try/else<br>在没有触发异常的时候执行一些代码，通过else从句来实现。else从句只会在没有异常的情况下执行，而且它会在finally语句之前执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    print(<span class="string">'I am sure no exception is going to occur!'</span>)</div><div class="line"><span class="keyword">except</span> Exception:</div><div class="line">    print(<span class="string">'exception'</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="comment"># 这里的代码只会在try语句里没有触发异常时运行,</span></div><div class="line">    <span class="comment"># 但是这里的异常将 *不会* 被捕获</span></div><div class="line">    print(<span class="string">'This would only run if no exception occurs. And an error here '</span></div><div class="line">          <span class="string">'would NOT be caught.'</span>)</div><div class="line"><span class="keyword">finally</span>:</div><div class="line">    print(<span class="string">'This would be printed in every case.'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>lambda表达式<br>即匿名函数，也是非常有用的技巧。原型是<code>lambda 参数:操作(参数)</code>。经常使用在数据结构的<code>sort</code>排序中，例如：<code>a_list.sort(key=lambda x:x[1])</code>。</p>
</li>
<li><p>for-else<br>for循环还有一个else从句，这个else从句会在循环正常结束时执行，这意味着循环没有遇到任何的break，这是一种非常有用的代码结构。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">10</span>):</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">2</span>, n):</div><div class="line">        <span class="keyword">if</span> n % x == <span class="number">0</span>:</div><div class="line">            print( n, <span class="string">'equals'</span>, x, <span class="string">'*'</span>, n/x)</div><div class="line">            <span class="keyword">break</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="comment"># loop fell through without finding a factor</span></div><div class="line">        print(n, <span class="string">'is a prime number'</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>上下文管理器（context managers）<br>在使用时，精确的分配和释放资源。常见的操作文件的上下文管理器，确保文件会被关闭。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> open(<span class="string">'some_file'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> opened_file:</div><div class="line">    opened_file.write(<span class="string">'Hola!'</span>)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>基于类的实现上下文管理器，起码要定义<code>__enter__</code>和<code>__exit__</code>方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file_name, method)</span>:</span></div><div class="line">        self.file_obj = open(file_name, method)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.file_obj</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, traceback)</span>:</span></div><div class="line">        self.file_obj.close()</div><div class="line"><span class="comment">#1.with语句先暂存了File类的__exit__方法</span></div><div class="line"><span class="comment">#2.然后它调用File类的__enter__方法</span></div><div class="line"><span class="comment">#3.__enter__方法打开文件并返回给with语句</span></div><div class="line"><span class="comment">#4.打开的文件句柄被传递给opened_file参数</span></div><div class="line"><span class="comment">#5.我们使用.write()来写文件</span></div><div class="line"><span class="comment">#6.with语句调用之前暂存的__exit__方法</span></div><div class="line"><span class="comment">#7.__exit__方法关闭了文件</span></div></pre></td></tr></table></figure></p>
<hr>
<h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p>很好的资源，译者在 <a href="http://www.lizenghai.com/doc/Intermediate_Python_CN/seealso.html" target="_blank" rel="external">http://www.lizenghai.com/doc/Intermediate_Python_CN/seealso.html</a> 分享的阅读资料。</p>
<p>感兴趣的小伙伴可以取Fork这个<a href="https://github.com/Yixiaohan/codeparkshare" target="_blank" rel="external">资源地址</a>。</p>
<hr>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>《Intermediate Python》本书的内容知识点相对简单，且数量仅仅是Python中的冰山一角，深入也仅仅是浅层。细读了两遍之后，推荐将这本书定位为入门书目。</p>
<p>其中“装饰器”部分重点推荐阅读，结合所给实例深入理解。</p>
<p>最后，仅借着写这篇读书笔记为由，第三遍读此书，感谢开源的力量。 : )</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/13/Python需求：嵌套序列展开/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/13/Python需求：嵌套序列展开/" itemprop="url">
                  Python需求：嵌套序列展开
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T22:52:48+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求简介"><a href="#需求简介" class="headerlink" title="需求简介"></a>需求简介</h3><p>将嵌套的列表（即列表内嵌套子列表）进行展开（直观的描述，即将“[]”内的左右中括号全部去掉）。实例的数据结构由简单且规则的形式，逐步推广到一般情况。</p>
<hr>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>Python 2.7  和  Python 3.5</p>
<hr>
<h3 id="示例一"><a href="#示例一" class="headerlink" title="示例一"></a>示例一</h3><p>需求：将形如<code>source_list = [[1,2],[3,4],[5,6]]</code>的数据结构，展开为<code>target_list = [1,2,3,4,5,6]</code>。</p>
<p>常规的处理方法比较多，下面主要介绍一个标准库提供的工具。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### example_1.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># Python 2.7 &amp; Python 3.5</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</div><div class="line"></div><div class="line">source_list = [[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>],[<span class="number">5</span>,<span class="number">6</span>]]</div><div class="line">target = list(chain.from_iterable(souce_list))</div><div class="line"></div><div class="line"><span class="comment"># out put data </span></div><div class="line"><span class="comment"># [1, 2, 3, 4, 5, 6]</span></div></pre></td></tr></table></figure>
<p>上述处理的方法，主要使用<code>itertools</code>库的<code>chain.from_iterable</code>工具。<code>itertools</code>模块主要包含创建迭代器和生成器的函数，这个模块是非常有用的内置标准库。</p>
<p><code>chain.from_iterable(iterable)</code>要求参数是可迭代的。直接将可迭代的数据展开为<code>&lt;class &#39;itertools.chain&#39;&gt;</code>对象。实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">from_iterable</span><span class="params">(iterables)</span>:</span></div><div class="line">    <span class="comment"># chain.from_iterable(['ABC','DEF']) --&gt; A B C D E F</span></div><div class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> iterables:</div><div class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> it:</div><div class="line">            <span class="keyword">yield</span> element</div></pre></td></tr></table></figure>
<p>从<code>chain.from_iterable(iterable)</code>实现中也可以发现，这个方法主要使用与两层的嵌套列表数据结构的展开。接下来我们再看一个更加一般的数据结构。</p>
<hr>
<h3 id="示例二"><a href="#示例二" class="headerlink" title="示例二"></a>示例二</h3><p>需求：将形如<code>source_list = [1, 2, [3, 4, [5, 6], 7], 8]</code>的数据结构，展开为<code>target_list = [1,2,3,4,5,6,7,8]</code>。</p>
<p>这个source_list的结构就特别一般化了，我们不确定具体的嵌套的形式和层数，列表中的子列表可能是序列，子列表的子项仍可能是列表序列。列表的嵌套是任意的深度。最终的结果要求是循环遍历所有列表和子列表，将其所有的元素展开成为一个单一的列表。</p>
<p>解决方案：此处最明显考虑到的就是递归形式的迭代器和生成器。我们循环遍历列表的元素，依次判断其元素是否可迭代，若不可迭代，直接将其返回，若可迭代，执行上述遍历子列表和判断步骤。实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### example_2.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># Python 2.7</span></div><div class="line"><span class="keyword">from</span> collections impot Iterable</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(items, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></div><div class="line">    <span class="string">''' items:iterable data structure</span></div><div class="line">    ignore_types:默认提供的数据类型不再展开'''</div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</div><div class="line">        <span class="keyword">if</span> isinstance(item, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(item, ignore_types):</div><div class="line">            <span class="keyword">for</span> it <span class="keyword">in</span> flatten(item):</div><div class="line">                <span class="keyword">yield</span> foo</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">yield</span> item</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    items = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>], <span class="number">7</span>], <span class="number">8</span>]</div><div class="line">    target_list = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target_list.append()</div><div class="line">    <span class="keyword">print</span> target_list</div><div class="line">    <span class="comment"># [1,2,3,4,5,6,7,8]</span></div><div class="line"></div><div class="line">    items = [<span class="string">'xiao Z'</span>, <span class="string">'xiao Q'</span>, [<span class="string">'xiao D'</span>, <span class="string">'xiao Y'</span>]]</div><div class="line">    target = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target.append(x)</div><div class="line">    <span class="keyword">print</span> target</div><div class="line">    <span class="comment"># ['xiao Z', 'xiao Q', 'xiao D', 'xiao Y']</span></div></pre></td></tr></table></figure>
<hr>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### example_2.py</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment"># Python 3.5</span></div><div class="line"><span class="keyword">from</span> collections impot Iterable</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(items, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></div><div class="line">    <span class="string">''' items:iterable data structure</span></div><div class="line">    ignore_types:默认提供的数据类型不再展开'''</div><div class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</div><div class="line">        <span class="keyword">if</span> isinstance(item, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(item, ignore_types):</div><div class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> flatten(item)    <span class="comment"># &lt;== 主要的区别所在</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">yield</span> item</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    items = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>], <span class="number">7</span>], <span class="number">8</span>]</div><div class="line">    target_list = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target_list.append()</div><div class="line">    print(target_list)</div><div class="line">    <span class="comment"># [1,2,3,4,5,6,7,8]</span></div><div class="line"></div><div class="line">    items = [<span class="string">'xiao Z'</span>, <span class="string">'xiao Q'</span>, [<span class="string">'xiao D'</span>, <span class="string">'xiao Y'</span>]]</div><div class="line">    target = []</div><div class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</div><div class="line">        target.append(x)</div><div class="line">    print(target)</div><div class="line">    <span class="comment"># ['xiao Z', 'xiao Q', 'xiao D', 'xiao Y']</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://docs.python.org/2/library/itertools.html" target="_blank" rel="external">itertools python2.7</a><br><a href="https://docs.python.org/3/library/itertools.html" target="_blank" rel="external">itertools python3.5</a></p>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>详细学习<code>itertools</code>内置模块</li>
<li>学习迭代器和生成器（yield）</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/06/01/Python需求：批量解压ZIP文件，并获取简单信息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/01/Python需求：批量解压ZIP文件，并获取简单信息/" itemprop="url">
                  Python需求：批量解压ZIP文件，并获取简单信息
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-01T00:50:08+08:00">
                2017-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="需求简介"><a href="#需求简介" class="headerlink" title="需求简介"></a>需求简介</h3><p>现在需要获取服务器上某一类文件夹下的全部ZIP文件的创建时间信息，以及ZIP文件内的内容行数信息。服务器上基础的文件层级如下截图：<br><img src="http://on58f12qv.bkt.clouddn.com/%E9%9C%80%E6%B1%82-1.PNG" alt="需求-1|center"><br>其中以“YYYMM”命名的文件均为目标文件夹，“result”文件存放我们中间处理的结果以及放置脚本的位置，这些文件均在某一个固定目录下。其中“YYYYMM”文件夹下均未ZIP压缩文件，如下截图：<br><img src="http://on58f12qv.bkt.clouddn.com/%E9%9C%80%E6%B1%82-2.PNG" alt="需求-2|center"></p>
<p>需要说明的一点，在ZIP文件内，是不定数量的Excel（“.xls”格式，且以中文命名，而且只保证在单个ZIP文件下不重复）文件的压缩包（可能是空文件，也可能有很多个）。</p>
<p>现在的需求即：统计这些ZIP文件的创建时间，ZIP内各Excel的行数信息。</p>
<hr>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>获取某固定目录下的子目录以及各子目录下的ZIP文件列表，依次获取ZIP的创建时间信息。就ZIP文件内各Excel行数信息而言，需要将各ZIP文件解压，之后通过读取Excel获取行数信息。</p>
<p>大致的思路就是上述步骤，接下来是具体的代码实现。</p>
<hr>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><ul>
<li>Ubuntu</li>
<li>Python 2.7.10</li>
</ul>
<p>代码结构如下截图：<br><img src="http://on58f12qv.bkt.clouddn.com/%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png" alt="代码结构|center"></p>
<h4 id="解压zip文件"><a href="#解压ZIP文件" class="headerlink" title="解压ZIP文件"></a>解压ZIP文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## Unzip_file.py</span></div><div class="line"><span class="comment">## 实现ZIP文件的自动解压,同时读取各ZIP文件的创建时间</span></div><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="comment"># root_dir = '/mnt/home/data/upload'   #此路径为个人路径</span></div><div class="line">root_dir = <span class="string">'/mnt/online-env/upload/file'</span>   <span class="comment"># 此路径为线上环境路径</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dir_list</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">""" 获取指定路径下子目录列表"""</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    <span class="keyword">if</span> os.path.exists(root_dir):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            dir_list = os.listdir(root_dir)</div><div class="line">            <span class="keyword">return</span> dir_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The root_dir is not exists.'</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_zip_list</span><span class="params">(target_dir)</span>:</span></div><div class="line">    <span class="string">""" 获取指定子目录下的ZIP文件列表"""</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    target_dir_ = os.path.join(root_dir, target_dir)</div><div class="line">    <span class="keyword">if</span> os.path.exists(target_dir_):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            zip_list = [zp <span class="keyword">for</span> zp <span class="keyword">in</span> os.listdir(target_dir_)]</div><div class="line">            <span class="keyword">return</span> zip_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(target_dir)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">unzip_file</span><span class="params">(target_dir,zip_name)</span>:</span></div><div class="line">    <span class="string">""" 自动化解压ZIP文件功能"""</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    zip_file = os.path.join(root_dir, target_dir, zip_name)</div><div class="line">    <span class="keyword">if</span> os.path.exists(zip_file):</div><div class="line">	    <span class="comment"># root_dir是生产环境,不宜操作.故将数据解压到指定个人路径.</span></div><div class="line">	    <span class="comment"># 因ZIP文件只保证单个ZIP下不重复,因此以ZIP文件的"(*).ZIP"形式创建文件夹,存放对应解压后的Excel文件</span></div><div class="line">        new_dir_path = <span class="string">'/mnt/home/data/upload/result/&#123;0&#125;'</span>.format(zip_name[:<span class="number">-4</span>])</div><div class="line">        os.system(<span class="string">'mkdir &#123;0&#125;'</span>.format(new_dir_path))</div><div class="line">        os.system(<span class="string">'unzip -n -O CP936 &#123;0&#125; -d &#123;1&#125;'</span>.format(zip_file, new_dir_path))</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(zip_file)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">        </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_time</span><span class="params">(target_dir, zip_file)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    zip_path = os.path.join(root_dir, target_dir, zip_file)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> os.path.exists(zip_path):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            create_time = os.path.getctime(zip_path)</div><div class="line">            <span class="keyword">return</span>  zip_path[:<span class="number">-4</span>], datetime.fromtimestamp(create_time)</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(zip_path)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    dir_list = get_dir_list()</div><div class="line">	<span class="comment"># 保存ZIP文件创建时间</span></div><div class="line">    file_save = codecs.open(<span class="string">'/mnt/home/data/upload/time_result.txt'</span>, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> target_dir <span class="keyword">in</span> dir_list:</div><div class="line">        zip_list = get_zip_list(target_dir)</div><div class="line">        <span class="keyword">for</span> zip_name <span class="keyword">in</span> zip_list:</div><div class="line">            unzip_file(target_dir, zip_name)</div><div class="line">            zip_path, create_time = get_time(target_dir, zip_name)</div><div class="line">            file_save.write( zip_path.decode(<span class="string">'utf-8'</span>) + <span class="string">'\t'</span> + create_time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>) +<span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    file_save.close()</div></pre></td></tr></table></figure>
<p>实现代码比较简单，其中备注下在Debug代码过程中踩的坑。<br><strong>k-1</strong></p>
<blockquote>
<p>因为需要操作生成环境下的文件，首先想到的第一步措施可能是将数据文件全部CP或者MV到指定的个人目录下。在这个地方趟的第一个坑，就是CP或MV命令操作ZIP文件之后，其时间就会发生变化，更新为命令动作发生时的时间。所以，选择的方法是在解压ZIP文件的同时，顺道将ZIP文件的创建时间信息获取并保存。</p>
</blockquote>
<p><strong>k-2</strong></p>
<blockquote>
<p>这个算是个小知识吧，不能算坑~。<code>os.listdir()</code>自动过滤指定目录下的当前目录和上级目录，这个在解释器内执行下对应代码即可了解。</p>
</blockquote>
<p><strong>k-3</strong></p>
<blockquote>
<p>前面也已经提到了ZIP内Excel的特征。因为是中文Excel名称，在解压时若直接使用<code>unzip file_name</code>命令，得到的Excel名称是乱码形式，并在下一步的Excel读取行数的过程中无法正常读取。因此调整命令为<code>unzip -O CP936 file_name</code>，完美将解压后中文问题解决。<br>其次，因为ZIP文件内的Excel命名格式只能保证在此ZIP文件下是不重复的，无法保证所有的ZIP下的文件都是不重复的。所以在此，选择了一个比较粗鲁的方案。依据ZIP文件的文成来生成对应的文件夹，同时将指定解压的文件目标路径为上述创建的文件夹中。因此调整命令为<code>unzip -n -d target_path</code>。</p>
</blockquote>
<p>这部分主要逻辑和代码是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">new_dir_path = <span class="string">'/mnt/home/data/upload/result/&#123;0&#125;'</span>.format(zip_name[:<span class="number">-4</span>])</div><div class="line">os.system(<span class="string">'mkdir &#123;0&#125;'</span>.format(new_dir_path))</div><div class="line">os.system(<span class="string">'unzip -n -O CP936 &#123;0&#125; -d &#123;1&#125;'</span>.format(zip_file, new_dir_path))</div></pre></td></tr></table></figure></p>
<p>到此，解压ZIP文件的工作已经完成。接下来统计Excel行数的工作就比较轻松啦。</p>
<h4 id="统计excel行数"><a href="#统计Excel行数" class="headerlink" title="统计Excel行数"></a>统计Excel行数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment">## Summary_info.py</span></div><div class="line"><span class="comment">## 统计解压后的Excel文件的行数信息</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlrd</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="comment"># 个人数据处理路径</span></div><div class="line">root_dir = <span class="string">'/mnt/home/data/upload/result'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dir_list</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    <span class="keyword">if</span> os.path.exists(root_dir):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            dir_list = os.listdir(root_dir)</div><div class="line">            dir_list.pop(dir_list.index(<span class="string">'Summary_info.py'</span>))</div><div class="line">            dir_list.pop(dir_list.index(<span class="string">'Unzip_files.py'</span>))</div><div class="line">            <span class="keyword">return</span> dir_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The root_dir is not exists.'</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dir_list_</span><span class="params">(target_dir)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    dir_ = os.path.join(root_dir, target_dir)</div><div class="line">    <span class="keyword">if</span> os.path.exists(dir_):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            file_list = os.listdir(dir_)</div><div class="line">            <span class="keyword">return</span> file_list</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The root_dir is not exists.'</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_time</span><span class="params">(target_dir, excel_file)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    excel_path = os.path.join(root_dir, target_dir, excel_file)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> os.path.exists(excel_path):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            create_time = os.path.getctime(excel_path)</div><div class="line">            <span class="keyword">return</span>  excel_path, datetime.fromtimestamp(create_time)</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(excel_file)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span>,<span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rows</span><span class="params">(target_dir, excel_file)</span>:</span></div><div class="line">    <span class="keyword">global</span> root_dir</div><div class="line">    excel_path = os.path.join(root_dir, target_dir, excel_file)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> os.path.exists(excel_path):</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            excelFile = xlrd.open_workbook(excel_path.decode(<span class="string">'utf-8'</span>))</div><div class="line">            sheet = excelFile.sheet_by_index(<span class="number">0</span>)</div><div class="line">            nrows = sheet.nrows</div><div class="line">            <span class="keyword">return</span> nrows</div><div class="line">        <span class="keyword">except</span> Exception,e:</div><div class="line">            <span class="keyword">print</span> <span class="string">'The Error &#123;0&#125;.'</span>.format(e)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'The target_dir &#123;0&#125; is not exists.'</span>.format(excel_file)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    dir_list = get_dir_list()</div><div class="line"></div><div class="line">    file_save = codecs.open(<span class="string">'/mnt/home/data/upload/summary_result.txt'</span>, mode=<span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> target_dir <span class="keyword">in</span> dir_list:</div><div class="line">        file_list = get_dir_list_(target_dir)</div><div class="line">        <span class="keyword">if</span> file_list <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">for</span> excel_file <span class="keyword">in</span> file_list:</div><div class="line">                excel_path, create_time = get_time(target_dir, excel_file)</div><div class="line">                nrows = get_rows(target_dir, excel_file)</div><div class="line">                file_save.write( excel_path.decode(<span class="string">'utf-8'</span>) + <span class="string">'\t'</span> + create_time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>) + <span class="string">'\t'</span> + str(nrows) + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    file_save.close()</div></pre></td></tr></table></figure>
<p>这部分的代码很简单，只需要稍微注意下<code>xlrd.open_workbook()</code>中文名的Excel即可。</p>
<hr>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>重构代码，两个功能部分的代码还是有很大的相似性，减少代码的冗余，使代码更加通用化</li>
<li>扩展获取文件相关信息的功能</li>
</ol>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><ol>
<li>Python官方 OS 文档</li>
<li>Ubuntu unzip 命令</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://fujiador.github.io/2017/05/30/Python项目：定制化词云/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fujia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fujia's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/30/Python项目：定制化词云/" itemprop="url">
                  Python项目：定制化词云
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-30T22:26:34+08:00">
                2017-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h3><p>“词云”是对常见的文本中出现频率较高的“关键词”或“高频词”予以视觉和展示上的突出，形成层次有序、主题突出的“词云”图形，从而过滤掉大量的无意义信息，并凸显想要展示的信息内容。<br>一幅制作精美的词云图片，可以达到一图胜千言的效果，通常在PPT报告中使用漂亮的词云，关键是可以装X~   :）</p>
<p>接下来，将使用<code>wordcloud</code>第三方包来制作词云，并且解决中文字符显示的问题，生成定制化个性词云。</p>
<hr>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li>Python 3.6</li>
</ul>
<hr>
<h3 id="第三方packages"><a href="#第三方Packages" class="headerlink" title="第三方Packages"></a>第三方Packages</h3><ul>
<li>wordcloud</li>
<li>PIL</li>
</ul>
<hr>
<h4 id="wordcloud安装"><a href="#wordcloud安装" class="headerlink" title="wordcloud安装"></a>wordcloud安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple wordcloud</div></pre></td></tr></table></figure>
<p>Windows环境下，推荐从<a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/" target="_blank" rel="external">非官方Windows第三方库</a>下载安装。<br><img src="http://on58f12qv.bkt.clouddn.com/Unoffical_wordcloud.PNG" alt="wordcloud|center"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install C:\Users\Desktop\wordcloud-1.3.1-cp36-cp36m-win_amd64.whl</div></pre></td></tr></table></figure></p>
<p><code>Unofficial Windows Binaries for Python Extension Packages</code>可以高效的在windows环境下安装第三方包，并且避免pip安装过程中莫名其妙的坑。</p>
<p><strong>wordcloud</strong><a href="https://github.com/amueller/word_cloud" target="_blank" rel="external">GitHub</a>。wordcloud作者是使用Python2+编写，但是Python3+也是兼容的。</p>
<h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><p>官方Git展示的简单示例，将《美国宪法》生成词云。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'FuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</div><div class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line">FILE_PATH = path.dirname(__file__)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_text</span><span class="params">(FILE_NAME)</span>:</span></div><div class="line">	<span class="keyword">global</span> FILE_PATH</div><div class="line">	file_path = path.join(FILE_PATH, FILE_NAME)</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="keyword">with</span> codecs.open(file_path, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">			text = file.read()</div><div class="line">		<span class="keyword">return</span> text</div><div class="line">	<span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</div><div class="line">		print(<span class="string">"FileNot Found ,&#123;&#125;"</span>.format(e))</div><div class="line">		<span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_wordcloud</span><span class="params">(text,)</span>:</span></div><div class="line">	wordcloud = WordCloud(max_font_size=<span class="number">40</span>).generate(text)</div><div class="line"></div><div class="line">	plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>)</div><div class="line">	plt.axis(<span class="string">"off"</span>)</div><div class="line">	plt.show()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	FILE_NAME = <span class="string">'US_constitution.txt'</span></div><div class="line">	text = load_text(FILE_NAME)</div><div class="line"></div><div class="line">	generate_wordcloud(text)</div></pre></td></tr></table></figure></p>
<p>下图是生成的《美国宪法》默认样式参数的词云图。<br><img src="http://on58f12qv.bkt.clouddn.com/US_constitution.txt.jpeg" alt="美国宪法-词云|center"></p>
<p><code>wordcloud</code>包的核心是<code>WordCloud</code>类，用于生成和绘制WordCloud对象。<br><strong>参数：</strong></p>
<ul>
<li>font_path  要使用的字体的路径（OTF或TTF文件）</li>
<li>width  画布宽度，默认400</li>
<li>heifht  画布高度，默认200</li>
<li>prefer_horizontal </li>
<li>mask </li>
<li>scale 缩放，默认1</li>
<li>min_font_size 使用最小的字体大小，默认4</li>
<li>font_step 字体的步长大小，morning1</li>
<li>max_words 最大字数，默认200</li>
<li>stopwords  禁用词，默认内置的STOPWORDS列表</li>
<li>background_color 词云图像的北京颜色，默认black</li>
<li>max_font_size 最大字体的字体大小</li>
<li>mode 模式，默认RGB，当mode=RGBA时，产生透明背景</li>
<li>relative_scaling</li>
<li>color_func callable，default=None。一般使用Image的generate_image方法获取图片的颜色设置</li>
<li>colormap 色彩映射将每个单词随机绘制颜色</li>
</ul>
<p>在上面的代码中，当输入中文格式的文本时，是不能正常显示的中文的。如下图所示：<br><img src="http://on58f12qv.bkt.clouddn.com/%E4%B8%AD%E6%96%87%E9%97%AE%E9%A2%98.png" alt="中文问题|center"></p>
<p>因为WordCloud类中font_path参数变量没有找到显示中文的字体。通过WordCloud的参数说明，可以用font_path参数来设置可显示中文的字体。并将对应部分的代码进行如下调整：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_wordcloud</span><span class="params">(text, save_name, font_name=None)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> font_path:</div><div class="line">        wordcloud = WordCloud(max_font_size=<span class="number">40</span>).generate(text) </div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        wordcloud = WordCloud(font_path=path.join(FILE_PATH,font_name),max_font_size=<span class="number">40</span>).generate(text)</div><div class="line"></div><div class="line">    plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>)</div><div class="line">    plt.axis(<span class="string">"off"</span>)</div><div class="line">    plt.savefig(save_name+<span class="string">".jpeg"</span>)</div><div class="line">    plt.show()</div></pre></td></tr></table></figure></p>
<p>调整之后的词云结果如下：<br><img src="http://on58f12qv.bkt.clouddn.com/%E6%AD%A3%E5%B8%B8%E6%98%BE%E7%A4%BA.png" alt="解决中文问题|center"></p>
<hr>
<h3 id="奇形怪状的词云"><a href="#奇形怪状的词云" class="headerlink" title="奇形怪状的词云"></a>奇形怪状的词云</h3><p>接下来，我们绘制定制图形的词云！git官方的实例，是关于爱丽丝的一个词云。</p>
<h4 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -*- coding:utf-8 -*-</span></div><div class="line">__author__ = <span class="string">'MaFuJia'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</div><div class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud,STOPWORDS</div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line">FILE_PATH = path.dirname(__file__)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_text</span><span class="params">(FILE_NAME)</span>:</span></div><div class="line">	<span class="keyword">global</span> FILE_PATH</div><div class="line">	file_path = path.join(FILE_PATH, FILE_NAME)</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="keyword">with</span> codecs.open(file_path, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> file:</div><div class="line">			text = file.read()</div><div class="line">		<span class="keyword">return</span> text</div><div class="line">	<span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</div><div class="line">		print(<span class="string">"FileNot Found ,&#123;&#125;"</span>.format(e))</div><div class="line">		<span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_wordcloud</span><span class="params">(text, save_name, font_name=None, mask_name=None)</span>:</span></div><div class="line">	<span class="keyword">global</span> FILE_PATH</div><div class="line"></div><div class="line">	image_mask = np.array(Image.open(path.join(FILE_PATH,mask_name)))</div><div class="line">	stopwords = set(STOPWORDS)</div><div class="line">	stopwords.add(<span class="string">"said"</span>)</div><div class="line"></div><div class="line">	wordcloud = WordCloud(background_color=<span class="string">'white'</span>, max_words=<span class="number">2000</span>, mask=image_mask,</div><div class="line">	                            stopwords=stopwords,font_path=path.join(FILE_PATH,font_name))</div><div class="line">	wordcloud.generate(text)</div><div class="line"></div><div class="line">	wordcloud.to_file(path.join(FILE_PATH, save_name.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.png'</span>))</div><div class="line">	plt.imshow(wordcloud, interpolation=<span class="string">'bilinear'</span>, cmap=plt.cm.gray)</div><div class="line">	plt.axis(<span class="string">"off"</span>)</div><div class="line">	plt.savefig(path.join(FILE_PATH, save_name.split(<span class="string">'.'</span>)[<span class="number">0</span>] + <span class="string">'.png'</span>))</div><div class="line">	plt.show()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">	FILE_NAME = <span class="string">'alice.txt'</span></div><div class="line">	text = load_text(FILE_NAME)</div><div class="line"></div><div class="line">	generate_wordcloud(text, FILE_NAME, font_name=<span class="string">'simhei.ttf'</span>, mask_name=<span class="string">'alice_mask.png'</span>)</div></pre></td></tr></table></figure>
<p>效果图如下所示：<br><img src="http://on58f12qv.bkt.clouddn.com/alice.png" alt="alice|center|800*0"></p>
<p>最核心的一个参数是<code>mask=image_mask</code>，设置一个图片轮廓作为词云的mask，让我们的单词只在这个mask的空间内进行展示。</p>
<hr>
<h3 id="to-do"><a href="#To-Do" class="headerlink" title="To-Do"></a>To-Do</h3><ol>
<li>代码重构</li>
<li>参数添加，更加通用化</li>
<li>可否制作成可安装的exe小程序</li>
</ol>
<hr>
<h3 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h3><p><a href="https://github.com/amueller/word_cloud" target="_blank" rel="external">https://github.com/amueller/word_cloud</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Fujia" />
          <p class="site-author-name" itemprop="name">Fujia</p>
           
              <p class="site-description motion-element" itemprop="description">好记性不如烂笔头,更何况记性还不好</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fujia</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  



  




	





  





  





  






  





  

  

  

  

</body>
</html>
